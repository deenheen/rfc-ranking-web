<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RFC ë­í‚¹ì „ (ì‹¤ì‹œê°„)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Nanum+Gothic+Coding:wght@400;700&display=swap');
        
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fb; }
        .rank-item { transition: background-color 0.2s; }
        .rank-number { font-weight: 800; width: 3.5rem; text-align: center; cursor: pointer; transition: color 0.2s; } 
        .rank-number:hover { color: #3b82f6 !important; text-decoration: underline; }

        /* ì½ê¸° ì „ìš© í…ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
        .read-only-text { text-overflow: ellipsis; overflow: hidden; white-space: nowrap; }

        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.5); display: flex; justify-content: center; align-items: center; z-index: 1000;
        }
        
        /* í„ìŠ¤ ì• ë‹ˆë©”ì´ì…˜ (ë³€ë™ ì‹œ íš¨ê³¼) */
        .winner-pulse { animation: highlight-winner 5s ease-out; z-index: 20; position: relative; border-left-color: #22c55e !important; }
        @keyframes highlight-winner {
            0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); background-color: #dcfce7; transform: scale(1.02); }
            50% { box-shadow: 0 0 0 8px rgba(34, 197, 94, 0); background-color: #dcfce7; transform: scale(1.02); }
            100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); transform: scale(1); }
        }

        .tab-btn { border-bottom: 2px solid transparent; transition: all 0.2s; }
        .hof-card { background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); text-align: center; border: 1px solid #e5e7eb; }
        .hof-champion { background: linear-gradient(135deg, #fffbeb 0%, #fff 100%); border: 2px solid #fbbf24; }
        .hof-silver { background: linear-gradient(135deg, #f8fafc 0%, #fff 100%); border: 2px solid #94a3b8; }
        .hof-bronze { background: linear-gradient(135deg, #fff7ed 0%, #fff 100%); border: 2px solid #fdba74; }
        .hof-defense { background: linear-gradient(135deg, #eff6ff 0%, #fff 100%); border: 2px solid #60a5fa; }
        .hof-passion { background: linear-gradient(135deg, #fef2f2 0%, #fff 100%); border: 2px solid #ef4444; }
        
        .match-card { background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 12px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; border-left: 4px solid #9ca3af; }
        .match-card.defense-success { border-left-color: #3b82f6; background-color: #eff6ff; } 
        .match-card.challenge-success { border-left-color: #ef4444; background-color: #fef2f2; } 
        .match-vs { font-size: 0.8rem; color: #9ca3af; margin: 0 8px; font-weight: bold; }
        
        /* í† ë„ˆë¨¼íŠ¸ ìŠ¤íƒ€ì¼ */
        .bracket-container { display: flex; flex-direction: row; justify-content: flex-start; overflow-x: auto; padding: 20px 0; min-height: 500px; }
        .bracket-round { display: flex; flex-direction: column; min-width: 180px; margin-right: 30px; position: relative; }
        .bracket-matches { flex: 1; display: flex; flex-direction: column; justify-content: space-around; width: 100%; }
        .bracket-pair { display: flex; flex-direction: column; justify-content: space-around; flex: 1; position: relative; margin-bottom: 10px; }
        .bracket-match { background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 8px; margin: 4px 0; box-shadow: 0 1px 2px rgba(0,0,0,0.05); position: relative; z-index: 10; }
        .bracket-team { padding: 4px; border-radius: 4px; font-size: 13px; display: flex; justify-content: space-between; }
        .bracket-team.winner { background-color: #eff6ff; color: #1d4ed8; font-weight: bold; }
        .bracket-team.loser { color: #9ca3af; text-decoration: line-through; }
        .pair-connector { position: absolute; top: 25%; bottom: 25%; right: -20px; width: 20px; border-right: 2px solid #cbd5e1; border-top: 2px solid #cbd5e1; border-bottom: 2px solid #cbd5e1; pointer-events: none; }
        .pair-connector::after { content: ''; position: absolute; top: 50%; right: -20px; width: 20px; height: 2px; background-color: #cbd5e1; transform: translateY(-50%); }
        .final-connector { position: absolute; right: -30px; top: 50%; width: 30px; height: 2px; background-color: #cbd5e1; z-index: 0; }
        
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }

        /* í”„ë¡œí•„ ì´ë¯¸ì§€ ìŠ¤íƒ€ì¼ */
        .profile-image-container { width: 100%; height: 350px; background-color: #e5e7eb; position: relative; overflow: hidden; }
        .profile-image-container img { width: 100%; height: 100%; object-fit: cover; object-position: top center; }
        .profile-stat-box { background-color: #f9fafb; border-radius: 8px; padding: 8px; text-align: center; border: 1px solid #e5e7eb; }
        
        .matchup-item { display: flex; align-items: center; justify-content: space-between; padding: 6px 8px; background-color: #f8fafc; border-radius: 6px; margin-bottom: 4px; font-size: 12px; }
        .matchup-label { font-weight: bold; width: 80px; flex-shrink: 0; } 
        .matchup-name { flex-grow: 1; text-align: left; padding-left: 8px; font-weight: 600; color: #374151; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .matchup-score { font-family: 'Nanum Gothic Coding', monospace; font-weight: bold; color: #6b7280; margin-left: 4px; }
        
        .profile-log-container { overflow-y: auto; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; padding: 4px; margin-top: 4px; }
        .profile-log-item { display: flex; align-items: center; justify-content: space-between; padding: 6px 8px; border-bottom: 1px solid #f3f4f6; font-size: 11px; }
        .profile-log-item:last-child { border-bottom: none; }
        .log-badge { padding: 2px 6px; border-radius: 4px; font-weight: 800; font-size: 10px; min-width: 30px; text-align: center; margin-right: 8px; }
        .log-badge.win { background-color: #fef2f2; color: #dc2626; border: 1px solid #fecaca; }
        .log-badge.loss { background-color: #eff6ff; color: #2563eb; border: 1px solid #dbeafe; }
        
        .tag-badge { display: inline-block; padding: 2px 8px; margin: 2px; border-radius: 9999px; font-size: 15px; font-weight: 600; background-color: #f3f4f6; color: #4b5563; border: 1px solid #d1d5db; }
    </style>
</head>
<body class="p-4 bg-gray-50">

    <div class="max-w-2xl mx-auto">
        <div class="flex flex-col sm:flex-row items-center justify-between mb-4 relative">
            <h1 class="text-xl font-bold text-gray-800 flex items-center justify-center mb-2 sm:mb-0">
                ğŸ† RFC ë­í‚¹ì „ (ì‹¤ì‹œê°„)
            </h1>
            <div class="text-sm font-bold text-gray-600 bg-white px-3 py-1 rounded shadow-sm border" id="dateDisplay">
                -
            </div>
        </div>

        <div id="tabContainer" class="flex border-b border-gray-200 mb-4 sticky top-0 z-50 bg-gray-50 pt-2">
            <button id="tabRanking" onclick="switchTab('ranking')" class="tab-btn active flex-1 py-3 px-1 text-sm font-bold text-blue-600 border-b-2 border-blue-500">ğŸ”¥ ë­í‚¹</button>
            <button id="tabMatchHistory" onclick="switchTab('matchHistory')" class="tab-btn flex-1 py-3 px-1 text-sm font-medium text-gray-400 border-b-2 border-transparent hover:text-gray-600">âš”ï¸ ê¸°ë¡</button>
            <button id="tabHeadToHead" onclick="switchTab('headToHead')" class="tab-btn flex-1 py-3 px-1 text-sm font-medium text-gray-400 border-b-2 border-transparent hover:text-gray-600">ğŸ†š ì „ì </button>
            <button id="tabHallOfFame" onclick="switchTab('hallOfFame')" class="tab-btn flex-1 py-3 px-1 text-sm font-medium text-gray-400 border-b-2 border-transparent hover:text-gray-600">ğŸ“Š í˜„í™©</button>
            <button id="tabTournament" onclick="switchTab('tournament')" class="tab-btn flex-1 py-3 px-1 text-sm font-medium text-gray-400 border-b-2 border-transparent hover:text-gray-600">ğŸ† ëŒ€ì§„</button>
        </div>

        <div id="rankingSection">
            <div id="loading" class="text-center p-4 text-blue-500 font-medium">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
            
            <div class="flex items-end p-2 text-sm font-bold text-gray-500 border-b border-gray-300 mb-2">
                <div class="rank-number mr-1 pb-1">ìˆœìœ„</div> 
                <div class="w-12 text-center mr-1 pb-1">ì‹¬ë³¼</div> 
                <div class="flex-grow text-left pl-4 pb-1">ë‹‰ë„¤ì„</div> 
                <div class="w-16 text-center pb-1">ì „ì </div>
                <div class="w-12 text-center pb-1">ë³€ë™</div>
                <div class="w-16 text-center pb-1">ë°©ì–´ì „</div>
            </div>
            <div id="rankingList" class="space-y-2"></div>
        </div>

        <div id="matchHistorySection" class="hidden p-4 bg-gray-50 rounded-lg shadow-inner">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-gray-700">âš”ï¸ ìµœê·¼ ê²½ê¸° ê¸°ë¡</h3>
                <select id="seasonSelector" class="text-sm font-bold text-gray-700 border border-gray-300 rounded-lg p-1.5 bg-white"></select>
            </div>
            <div id="matchHistoryList"></div>
        </div>
        
        <div id="headToHeadSection" class="hidden p-4 bg-gray-50 rounded-lg shadow-inner">
            <h3 class="text-lg font-bold text-gray-700 mb-4 text-center">ğŸ†š ìƒëŒ€ì „ì  ë¶„ì„</h3>
            <div class="flex gap-2 mb-4 justify-center items-center">
                <select id="h2hPlayerA" class="border rounded shadow-sm w-1/2 bg-white p-2"><option value="">ì„ ìˆ˜ A ì„ íƒ</option></select> 
                <span class="font-bold text-gray-400">VS</span> 
                <select id="h2hPlayerB" class="border rounded shadow-sm w-1/2 bg-white p-2"><option value="">ì„ ìˆ˜ B ì„ íƒ</option></select>
            </div>
            <div id="h2hResult" class="text-center"> <div class="text-gray-400 italic py-10">ë‘ ì„ ìˆ˜ë¥¼ ì„ íƒí•˜ì„¸ìš”.</div> </div>
        </div>
        
        <div id="hallOfFameSection" class="hidden p-4 bg-gray-50 rounded-lg shadow-inner">
            <div id="hofContent"></div>
        </div>
        
        <div id="tournamentSection" class="hidden p-4 bg-gray-50 rounded-lg shadow-inner overflow-x-auto">
            <h3 class="text-lg font-bold text-gray-700 text-center mb-4">ğŸ† í† ë„ˆë¨¼íŠ¸ ëŒ€ì§„í‘œ</h3>
            <div id="bracketContainer" class="bracket-container custom-scrollbar"> 
                <div class="w-full text-center text-gray-400 italic py-10">ì§„í–‰ ì¤‘ì¸ í† ë„ˆë¨¼íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</div> 
            </div>
        </div>
    </div>

    <div id="profileModal" class="modal hidden overflow-y-auto" onclick="if(event.target===this)this.classList.add('hidden')">
        <div class="bg-white rounded-xl shadow-2xl w-11/12 max-w-sm overflow-hidden relative flex flex-col my-auto mx-auto">
            <button onclick="document.getElementById('profileModal').classList.add('hidden')" class="absolute top-3 right-3 text-white bg-black/40 hover:bg-black/60 rounded-full p-1.5 z-50">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
            </button>
            <div id="profileImageContainer" class="profile-image-container h-64 shrink-0 bg-gray-200">
                <img id="profileImage" src="" alt="Profile" class="w-full h-full object-cover object-top">
            </div>
            <div class="px-5 pt-4 pb-2 text-center shrink-0">
                <div class="flex justify-center items-baseline space-x-2">
                    <h2 id="profileName" class="text-2xl font-black text-gray-800">ë‹‰ë„¤ì„</h2>
                    <div id="profileRank" class="text-blue-600 font-bold text-xl">1ìœ„</div>
                </div>
                <div id="profileGameId" class="text-sm text-gray-500 font-medium mt-1"></div>
            </div>
            <div class="p-4 bg-white flex flex-col space-y-4">
                <div id="profileTags" class="flex flex-wrap justify-center gap-1"></div>
                <div class="grid grid-cols-2 gap-3">
                    <div class="profile-stat-box"><div class="text-xs text-gray-400 font-bold">ì „ì </div><div id="profileRecord" class="text-base font-black text-gray-800"></div></div>
                    <div class="profile-stat-box"><div class="text-xs text-gray-400 font-bold">ìŠ¹ë¥ </div><div id="profileWinRate" class="text-base font-black text-gray-800"></div></div>
                </div>
                <div class="flex justify-between items-center border-b border-gray-100 pb-2">
                    <span class="text-sm font-bold text-gray-500">ğŸ“ˆ ì»¤ë¦¬ì–´ í•˜ì´</span>
                    <span id="profileHighRank" class="font-black text-amber-600 text-lg"></span>
                </div>
                <div>
                    <span class="text-xs font-bold text-gray-400 block mb-2">ğŸ†š ìƒì„± ë¶„ì„</span>
                    <div id="profileMatchupAnalysis" class="space-y-1"></div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // ============================================================
        // [ì¤‘ìš”] ì—¬ê¸°ì— ë³¸ì¸ì˜ firebaseConfigë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”!
        const firebaseConfig = {
  apiKey: "AIzaSyDlj68ex-fM0ExRdD-tvCy-UyIneVoPmGk",
  authDomain: "rfk-ranking.firebaseapp.com",
  projectId: "rfk-ranking",
  storageBucket: "rfk-ranking.firebasestorage.app",
  messagingSenderId: "675366165774",
  appId: "1:675366165774:web:795d34c56eab630b4dcb5f",
  measurementId: "G-CXPDZQ8GTL"
};
        // ============================================================

        const appId = 'ranking-manager-default'; // ê´€ë¦¬ì í˜ì´ì§€ì™€ ë™ì¼í•˜ê²Œ ì„¤ì •
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // ì „ì—­ ë³€ìˆ˜
        let rankingsData = [];
        let matchHistoryData = [];
        let previousRankingsData = [];
        let activeSeason = "ì‹œì¦Œ 1";
        let viewSeason = "ì‹œì¦Œ 1";
        let currentSeasonTitle = "ì‹œì¦Œ 1";
        let seasonArchives = {};
        let currentSeasonBestMatch = "";
        let tournamentData = { active: false, size: 0, rounds: [] };
        let currentRankingDate = "";

        // ë°ì´í„° ë¡œë“œ (ì‹¤ì‹œê°„)
        const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'rankings', 'main');
        onSnapshot(docRef, (docSnapshot) => {
            document.getElementById('loading').style.display = 'none';
            if (docSnapshot.exists()) {
                const data = docSnapshot.data();
                
                // ë°ì´í„° ë™ê¸°í™”
                rankingsData = data.rankings || [];
                matchHistoryData = data.matchHistory || [];
                activeSeason = data.activeSeason || "ì‹œì¦Œ 1";
                seasonArchives = data.seasonArchives || {};
                currentSeasonTitle = data.seasonTitle || activeSeason;
                currentSeasonBestMatch = data.seasonBestMatch || "";
                tournamentData = data.tournamentData || { active: false, rounds: [] };
                currentRankingDate = data.date || "";
                
                if (viewSeason === "ì‹œì¦Œ 1" && activeSeason !== "ì‹œì¦Œ 1") viewSeason = activeSeason;

                // ì´ì „ ë­í‚¹ ê³„ì‚°
                let baseline = rankingsData.map(item => ({...item}));
                baseline.sort((a, b) => a.previousRank - b.previousRank);
                previousRankingsData = baseline;

                // ë‚ ì§œ í‘œì‹œ
                document.getElementById('dateDisplay').textContent = currentRankingDate || "ë‚ ì§œ ë¯¸ì •";

                // í™”ë©´ ê°±ì‹ 
                renderRankings();
                updateSeasonSelector();
                renderMatchHistory();
                populateH2HSelectors();
                renderHallOfFame();
                renderTournament();
                
                // í˜„ì¬ ë³´ê³  ìˆëŠ” íƒ­ì˜ ë‚´ìš© ê°±ì‹  (ì „ì  ë¶„ì„ ë“±)
                if(!document.getElementById('headToHeadSection').classList.contains('hidden')) {
                    renderHeadToHeadAnalysis();
                }
            }
        });

        // íƒ­ ì „í™˜ í•¨ìˆ˜
        window.switchTab = function(tab) {
            const sections = ['rankingSection', 'matchHistorySection', 'headToHeadSection', 'hallOfFameSection', 'tournamentSection'];
            const tabs = ['tabRanking', 'tabMatchHistory', 'tabHeadToHead', 'tabHallOfFame', 'tabTournament'];
            
            sections.forEach(id => document.getElementById(id)?.classList.add('hidden'));
            tabs.forEach(id => {
                const el = document.getElementById(id);
                el.className = "tab-btn flex-1 py-3 px-1 text-sm font-medium text-gray-400 border-b-2 border-transparent hover:text-gray-600";
            });

            document.getElementById(tab + 'Section').classList.remove('hidden');
            document.getElementById('tab' + tab.charAt(0).toUpperCase() + tab.slice(1)).className = 
                "tab-btn active flex-1 py-3 px-1 text-sm font-bold text-blue-600 border-b-2 border-blue-500";
            
            if(tab === 'matchHistory') renderMatchHistory();
            if(tab === 'hallOfFame') renderHallOfFame();
            if(tab === 'tournament') renderTournament();
            if(tab === 'headToHead') populateH2HSelectors();
        };

        // ë­í‚¹ ë Œë”ë§
        function renderRankings() {
            const listContainer = document.getElementById('rankingList');
            listContainer.innerHTML = '';
            
            const previousRankMap = new Map();
            previousRankingsData.forEach(item => previousRankMap.set(item.id, item.previousRank));
            
            const maxDefense = Math.max(...rankingsData.map(i => i.defenseCount || 0), 0);

            rankingsData.forEach((item, index) => {
                const currentRank = index + 1;
                const prevRank = previousRankMap.get(item.id);
                
                // ë³€ë™ ê³„ì‚°
                let changeHtml = '<span class="text-gray-400">-</span>';
                if (prevRank !== undefined) {
                    const diff = prevRank - currentRank;
                    if (diff > 0) changeHtml = `<span class="text-red-500 font-bold">â–²${diff}</span>`;
                    else if (diff < 0) changeHtml = `<span class="text-blue-500 font-bold">â–¼${Math.abs(diff)}</span>`;
                }

                // ìŠ¤íƒ€ì¼ë§
                let rowBg = 'bg-white';
                let borderClass = 'border-l-4 border-gray-300';
                let rankColor = 'text-gray-500';
                let nameClass = 'text-gray-800 font-bold';
                
                if (!item.isParticipating) {
                    rowBg = 'bg-gray-50';
                    nameClass = 'text-gray-400 line-through';
                } else if (currentRank <= 3) {
                    rowBg = 'bg-sky-50';
                    borderClass = 'border-l-8 border-sky-500';
                    rankColor = 'text-sky-600';
                } else if (currentRank <= 10) {
                    rowBg = 'bg-teal-50';
                    borderClass = 'border-l-4 border-teal-400';
                    rankColor = 'text-teal-600';
                }

                // ì‹¬ë³¼
                let symbol = '';
                if (currentRank === 1) symbol = 'ğŸ¥‡';
                else if (currentRank === 2) symbol = 'ğŸ¥ˆ';
                else if (currentRank === 3) symbol = 'ğŸ¥‰';
                
                let defSymbol = '';
                if (maxDefense > 0 && item.defenseCount >= maxDefense && item.defenseCount > 0) defSymbol = 'ğŸ–ï¸';
                else if ((item.defenseCount || 0) >= 5) defSymbol = 'ğŸ›¡ï¸';

                // ìŠ¹ë¥ 
                const total = (item.wins || 0) + (item.losses || 0);
                const rate = total > 0 ? Math.round((item.wins / total) * 100) : 0;

                // HTML ìƒì„±
                const div = document.createElement('div');
                div.className = `rank-item flex items-center p-3 rounded-xl shadow-sm ${rowBg} ${borderClass}`;
                div.innerHTML = `
                    <div class="rank-number text-2xl ${rankColor}" onclick="openProfile('${item.id}')">${currentRank}</div>
                    <div class="w-12 text-center text-xl flex justify-center space-x-1">
                        <span>${symbol}</span><span>${defSymbol}</span>
                    </div>
                    <div class="flex-grow pl-4 overflow-hidden">
                        <div class="text-lg ${nameClass} read-only-text cursor-pointer hover:text-blue-600" onclick="openProfile('${item.id}')">
                            ${item.name}
                            ${(Date.now() - (item.entryTime || 0) < 86400000) ? '<span class="text-[10px] text-red-500 font-bold ml-1 align-top">NEW</span>' : ''}
                        </div>
                    </div>
                    <div class="w-16 text-center flex flex-col justify-center">
                        <span class="text-sm font-bold text-gray-800">${item.wins}ìŠ¹ ${item.losses}íŒ¨</span>
                        <span class="text-xs text-gray-400">(${rate}%)</span>
                    </div>
                    <div class="w-12 text-center text-sm font-bold">${changeHtml}</div>
                    <div class="w-16 text-center text-sm font-bold text-gray-600">${item.defenseCount > 0 ? item.defenseCount : '-'}</div>
                `;
                listContainer.appendChild(div);
            });
        }

        // í”„ë¡œí•„ ë³´ê¸° í•¨ìˆ˜
        window.openProfile = function(id) {
            const player = rankingsData.find(p => p.id === id);
            if (!player) return;
            
            const modal = document.getElementById('profileModal');
            const rank = rankingsData.indexOf(player) + 1;
            
            // ë°ì´í„° ì±„ìš°ê¸°
            document.getElementById('profileName').textContent = player.name;
            document.getElementById('profileRank').textContent = rank + 'ìœ„';
            document.getElementById('profileGameId').textContent = player.gameId || '';
            document.getElementById('profileHighRank').textContent = (player.careerHighRank || rank) + 'ìœ„';
            document.getElementById('profileRecord').textContent = `${player.wins||0}ìŠ¹ ${player.losses||0}íŒ¨`;
            
            const total = (player.wins||0) + (player.losses||0);
            document.getElementById('profileWinRate').textContent = total > 0 ? Math.round((player.wins/total)*100) + '%' : '0%';
            
            // ì´ë¯¸ì§€ ì²˜ë¦¬ (í…Œë‘ë¦¬ ìƒ‰ìƒ ë¡œì§ í¬í•¨)
            const imgEl = document.getElementById('profileImage');
            const imgContainer = document.getElementById('profileImageContainer');
            
            if (player.imageUrl) {
                imgEl.src = player.imageUrl;
                imgEl.classList.remove('p-8');
            } else {
                imgEl.src = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%239ca3af' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2'/%3E%3Ccircle cx='12' cy='7' r='4'/%3E%3C/svg%3E";
                imgEl.classList.add('p-8');
            }
            
            // ë­í‚¹ë³„ í…Œë‘ë¦¬ ìƒ‰ìƒ
            let borderColor = '#9ca3af'; 
            if (rank <= 3) borderColor = '#0ea5e9';
            else if (rank <= 10) borderColor = '#2dd4bf';
            
            imgContainer.style.border = `4px solid ${borderColor}`;

            // íƒœê·¸
            const tagContainer = document.getElementById('profileTags');
            tagContainer.innerHTML = (player.tags || []).map(t => `<span class="tag-badge">#${t}</span>`).join('');
            
            // ìƒì„± ë¶„ì„ (ê°„ì†Œí™”)
            const analysisEl = document.getElementById('profileMatchupAnalysis');
            analysisEl.innerHTML = '<div class="text-xs text-gray-400 text-center">ì „ì  íƒ­ì—ì„œ ìì„¸íˆ í™•ì¸í•˜ì„¸ìš”.</div>';

            modal.classList.remove('hidden');
        }

        // ì‹œì¦Œ ì„ íƒê¸° ì—…ë°ì´íŠ¸
        function updateSeasonSelector() {
            const selector = document.getElementById('seasonSelector');
            selector.innerHTML = '';
            Object.keys(seasonArchives).sort().forEach(s => {
                const opt = document.createElement('option');
                opt.value = s; opt.textContent = s + " (ì¢…ë£Œ)";
                selector.appendChild(opt);
            });
            const activeOpt = document.createElement('option');
            activeOpt.value = activeSeason;
            activeOpt.textContent = activeSeason + " (ì§„í–‰)";
            selector.appendChild(activeOpt);
            selector.value = viewSeason;
            
            selector.onchange = (e) => {
                viewSeason = e.target.value;
                renderMatchHistory();
            };
        }

        // ê²½ê¸° ê¸°ë¡ ë Œë”ë§
        function renderMatchHistory() {
            const container = document.getElementById('matchHistoryList');
            container.innerHTML = '';
            
            const filtered = matchHistoryData.filter(m => (m.season || "ì‹œì¦Œ 1") === viewSeason);
            if(filtered.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-400 italic py-4">ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }

            // ë‚ ì§œë³„ ê·¸ë£¹í•‘ ë¡œì§ ìƒëµí•˜ê³  ë‹¨ìˆœ ë¦¬ìŠ¤íŠ¸ë¡œ í‘œì‹œ (ë˜ëŠ” ê¸°ì¡´ ë¡œì§ í™œìš©)
            filtered.forEach(match => {
                const card = document.createElement('div');
                let typeClass = 'border-gray-300';
                let resultBadge = '';
                
                if (match.type === 'defense') { typeClass = 'match-card defense-success'; resultBadge = 'ğŸ›¡ï¸ ë°©ì–´'; }
                else if (match.type === 'challenge_success') { typeClass = 'match-card challenge-success'; resultBadge = 'ğŸš€ ì„±ê³µ'; }
                else { typeClass = 'match-card'; resultBadge = 'ê²½ê¸°'; }

                card.className = typeClass;
                card.innerHTML = `
                    <div class="text-xs text-gray-400 font-bold w-12 text-center">${match.date}</div>
                    <div class="flex-grow flex items-center justify-center text-sm">
                        <span class="font-bold w-[40%] text-right truncate ${match.winner===match.blue ? 'text-blue-600' : 'text-red-600'}">${match.winner}</span>
                        <span class="text-xs text-gray-300 mx-2">VS</span>
                        <span class="text-gray-500 w-[40%] text-left truncate">${match.loser}</span>
                    </div>
                    <div class="w-16 text-right text-xs font-bold text-gray-500">${resultBadge}</div>
                `;
                container.appendChild(card);
            });
        }

        // ëª…ì˜ˆì˜ ì „ë‹¹ ë Œë”ë§
        function renderHallOfFame() {
            const container = document.getElementById('hofContent');
            
            // í˜„ì¬ ì‹œì¦Œ ë°ì´í„° or ì•„ì¹´ì´ë¸Œ ë°ì´í„°
            let displayData = { champion: '-', rank2: '-', rank3: '-', defenseKing: '-', defenseCount: 0, bestMatch: '-' };
            
            if (viewSeason === activeSeason) {
                if (rankingsData.length > 0) displayData.champion = rankingsData[0].name;
                if (rankingsData.length > 1) displayData.rank2 = rankingsData[1].name;
                if (rankingsData.length > 2) displayData.rank3 = rankingsData[2].name;
                
                const maxDef = Math.max(...rankingsData.map(i => i.defenseCount || 0), 0);
                if (maxDef > 0) {
                    displayData.defenseCount = maxDef;
                    displayData.defenseKing = rankingsData.filter(i => (i.defenseCount||0) === maxDef).map(i => i.name).join(', ');
                }
                displayData.bestMatch = currentSeasonBestMatch || "ì„ ì • ì¤‘";
            } else if (seasonArchives[viewSeason]) {
                displayData = seasonArchives[viewSeason];
            }

            container.innerHTML = `
                <h3 class="text-center text-lg font-bold text-gray-700 mb-4">${viewSeason} ëª…ì˜ˆì˜ ì „ë‹¹</h3>
                <div class="grid grid-cols-3 gap-2 text-center items-end mb-6">
                    <div class="hof-card hof-silver order-1"><div class="text-xl">ğŸ¥ˆ</div><div class="font-bold truncate">${displayData.rank2}</div></div>
                    <div class="hof-card hof-champion order-2 transform scale-110"><div class="text-3xl">ğŸ‘‘</div><div class="font-black text-lg truncate">${displayData.champion}</div></div>
                    <div class="hof-card hof-bronze order-3"><div class="text-xl">ğŸ¥‰</div><div class="font-bold truncate">${displayData.rank3}</div></div>
                </div>
                <div class="grid grid-cols-1 gap-3">
                    <div class="hof-card hof-defense p-3 flex justify-between items-center">
                        <span class="font-bold text-blue-600">ğŸ›¡ï¸ ë°©ì–´ì™•</span>
                        <span class="font-bold">${displayData.defenseKing} (${displayData.defenseCount}íšŒ)</span>
                    </div>
                    <div class="bg-white border rounded-xl p-3 shadow-sm text-center">
                        <div class="text-xs text-gray-400 font-bold mb-1">ğŸ”¥ ì‹œì¦Œ ë² ìŠ¤íŠ¸ ë§¤ì¹˜</div>
                        <div class="font-bold text-gray-800">${displayData.bestMatch || '-'}</div>
                    </div>
                </div>
            `;
        }

        // ì „ì  ë¶„ì„ìš© ì„ íƒê¸° ì±„ìš°ê¸°
        function populateH2HSelectors() {
            const selA = document.getElementById('h2hPlayerA');
            const selB = document.getElementById('h2hPlayerB');
            
            // ê¸°ì¡´ ì„ íƒê°’ ìœ ì§€
            const valA = selA.value;
            const valB = selB.value;
            
            selA.innerHTML = '<option value="">ì„ ìˆ˜ A ì„ íƒ</option>';
            selB.innerHTML = '<option value="">ì„ ìˆ˜ B ì„ íƒ</option>';
            
            rankingsData.forEach((item, idx) => {
                const txt = `${idx+1}ìœ„ ${item.name}`;
                selA.add(new Option(txt, item.name));
                selB.add(new Option(txt, item.name));
            });
            
            selA.value = valA;
            selB.value = valB;
            
            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            const updateAnalysis = () => renderHeadToHeadAnalysis();
            selA.onchange = updateAnalysis;
            selB.onchange = updateAnalysis;
        }

        // ì „ì  ë¶„ì„ ê²°ê³¼
        function renderHeadToHeadAnalysis() {
            const pA = document.getElementById('h2hPlayerA').value;
            const pB = document.getElementById('h2hPlayerB').value;
            const container = document.getElementById('h2hResult');
            
            if(!pA || !pB) return;
            
            let wins = 0, losses = 0;
            const matches = matchHistoryData.filter(m => {
                if((m.season || "ì‹œì¦Œ 1") !== viewSeason) return false;
                if(m.winner === pA && m.loser === pB) { wins++; return true; }
                if(m.winner === pB && m.loser === pA) { losses++; return true; }
                return false;
            });
            
            container.innerHTML = `
                <div class="bg-white p-4 rounded-xl border mb-4">
                    <div class="flex justify-center items-center space-x-4 text-xl font-black">
                        <span class="text-gray-800">${pA}</span>
                        <span class="text-red-500">${wins}</span>
                        <span class="text-gray-300">:</span>
                        <span class="text-blue-500">${losses}</span>
                        <span class="text-gray-800">${pB}</span>
                    </div>
                </div>
                <div class="space-y-2 text-left">
                    ${matches.map(m => `
                        <div class="bg-white p-2 rounded border text-xs flex justify-between">
                            <span class="text-gray-400">${m.date}</span>
                            <span class="${m.winner===pA ? 'text-red-500 font-bold' : 'text-blue-500 font-bold'}">
                                ${m.winner===pA ? 'ìŠ¹ë¦¬' : 'íŒ¨ë°°'}
                            </span>
                        </div>
                    `).join('')}
                    ${matches.length === 0 ? '<div class="text-center text-gray-400 text-xs">ê¸°ë¡ ì—†ìŒ</div>' : ''}
                </div>
            `;
        }

        // í† ë„ˆë¨¼íŠ¸ ë Œë”ë§ (ë‹¨ìˆœí™”)
        function renderTournament() {
            const container = document.getElementById('bracketContainer');
            if (!tournamentData.active) {
                container.innerHTML = '<div class="w-full text-center text-gray-400 italic py-10">ì§„í–‰ ì¤‘ì¸ í† ë„ˆë¨¼íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }
            
            let html = '';
            tournamentData.rounds.forEach((round, rIndex) => {
                html += `<div class="bracket-round"><div class="bracket-matches">`;
                round.forEach(match => {
                    const p1 = match.p1 ? match.p1.name : '-';
                    const p2 = match.p2 ? match.p2.name : '-';
                    const w = match.winner ? match.winner.id : null;
                    
                    html += `
                        <div class="bracket-match mb-4">
                            <div class="bracket-team ${w===match.p1?.id ? 'winner' : ''}">${p1}</div>
                            <div class="border-t my-1"></div>
                            <div class="bracket-team ${w===match.p2?.id ? 'winner' : ''}">${p2}</div>
                        </div>
                    `;
                });
                html += `</div></div>`;
            });
            container.innerHTML = html;
        }

    </script>
</body>
</html>

