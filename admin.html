<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RFC ë­í‚¹ ë§¤ë‹ˆì € (v3.5 Simple)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Pretendard', sans-serif; background-color: #f8fafc; }
        .rank-card { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .highlight-change { animation: highlightPulse 2s ease-out; background-color: #fef9c3; border-left: 4px solid #facc15; }
        @keyframes highlightPulse {
            0% { transform: scale(1.02); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
            100% { transform: scale(1); box-shadow: none; }
        }
        .rank-up { color: #dc2626; font-weight: 800; }
        .rank-down { color: #2563eb; font-weight: 800; }
        .rank-keep { color: #9ca3af; }
        .style-checkbox:checked + label { background-color: #3b82f6; color: white; border-color: #3b82f6; }
        
        .tab-btn { @apply text-slate-500 border-b-2 border-transparent hover:text-slate-700 font-medium transition-colors; }
        .tab-btn.active { @apply text-blue-600 border-blue-600 font-bold; }

        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="text-slate-800">

    <div id="loginOverlay" class="fixed inset-0 bg-slate-900/95 z-50 flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-sm text-center border border-slate-200">
            <div class="text-4xl mb-2">ğŸ¥Š</div>
            <h2 class="text-2xl font-black text-slate-800 mb-6">RFC Admin v3.5</h2>
            <input type="email" id="adminEmail" placeholder="admin@rfc.com" class="w-full p-3 border border-slate-300 rounded-lg mb-3 focus:outline-none focus:ring-2 focus:ring-blue-500 bg-slate-50 transition">
            <input type="password" id="adminPw" placeholder="Password" class="w-full p-3 border border-slate-300 rounded-lg mb-6 focus:outline-none focus:ring-2 focus:ring-blue-500 bg-slate-50 transition">
            <button id="btnLogin" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3.5 rounded-lg transition transform active:scale-95 shadow-lg shadow-blue-500/30">ì‹œìŠ¤í…œ ì ‘ì†</button>
        </div>
    </div>

    <div id="mainContent" class="max-w-6xl mx-auto p-4 hidden min-h-screen flex flex-col">
        <header class="flex flex-col md:flex-row justify-between items-center mb-4 bg-white p-4 rounded-2xl shadow-sm border border-slate-100">
            <div class="flex items-center gap-3">
                <h1 class="text-2xl font-black bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-indigo-600">RFC ë§¤ë‹ˆì €</h1>
                <span id="currentSeasonBadge" class="bg-slate-800 text-white text-xs font-bold px-3 py-1 rounded-full shadow-md">Loading...</span>
                <span id="saveStatus" class="text-xs font-medium text-emerald-500 transition-opacity opacity-0">âœ… ì €ì¥ë¨</span>
            </div>
            <div class="mt-2 md:mt-0 text-xs text-slate-400 font-medium">
                v3.5 Simple
            </div>
        </header>

        <div class="bg-white rounded-t-2xl border-b border-slate-200 px-4 flex gap-6 mb-4 shadow-sm overflow-x-auto">
            <button onclick="switchTab('main')" id="tabMain" class="tab-btn active py-4 whitespace-nowrap">ğŸ”¥ ë­í‚¹/ê²½ê¸°</button>
            <button onclick="switchTab('season')" id="tabSeason" class="tab-btn py-4 whitespace-nowrap">ğŸ“… ì‹œì¦Œ ê´€ë¦¬</button>
            <button onclick="switchTab('tools')" id="tabTools" class="tab-btn py-4 whitespace-nowrap">ğŸ› ï¸ ë°ì´í„°/ë°±ì—…</button>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 flex-grow">
            
            <div class="lg:col-span-4 space-y-6">
                
                <div id="mainSection" class="tab-content">
                    
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden mb-6">
                        <div class="bg-slate-50 p-4 border-b border-slate-100 flex justify-between items-center">
                            <h3 class="font-bold text-slate-700">âš”ï¸ ê²½ê¸° ê²°ê³¼ ì…ë ¥</h3>
                        </div>
                        <div class="p-5">
                            <div class="space-y-4">
                                <div class="grid grid-cols-2 gap-3">
                                    <div>
                                        <label class="block text-xs font-bold text-blue-600 mb-1 pl-1">ğŸ”µ Blue</label>
                                        <select id="p1Select" class="w-full text-sm border-slate-200 rounded-lg p-2.5 bg-blue-50/50 outline-none"></select>
                                    </div>
                                    <div>
                                        <label class="block text-xs font-bold text-red-600 mb-1 pl-1">ğŸ”´ Red</label>
                                        <select id="p2Select" class="w-full text-sm border-slate-200 rounded-lg p-2.5 bg-red-50/50 outline-none"></select>
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-3 bg-slate-50 p-2 rounded-xl border border-slate-200">
                                    <label class="cursor-pointer flex flex-col items-center gap-1 p-3 rounded-lg hover:bg-blue-100 transition border border-transparent has-[:checked]:bg-blue-100 has-[:checked]:border-blue-300">
                                        <input type="radio" name="winner" value="blue" class="w-5 h-5 accent-blue-600">
                                        <span class="text-sm font-bold text-blue-600">Blue ìŠ¹</span>
                                    </label>
                                    <label class="cursor-pointer flex flex-col items-center gap-1 p-3 rounded-lg hover:bg-red-100 transition border border-transparent has-[:checked]:bg-red-100 has-[:checked]:border-red-300">
                                        <input type="radio" name="winner" value="red" class="w-5 h-5 accent-red-600">
                                        <span class="text-sm font-bold text-red-600">Red ìŠ¹</span>
                                    </label>
                                </div>
                                <div id="matchPreview" class="bg-gray-50 rounded-lg p-3 text-xs text-gray-600 border border-gray-200 hidden">
                                    <div id="previewContent" class="space-y-1"></div>
                                </div>
                                <button onclick="applyMatch()" class="w-full bg-gradient-to-r from-slate-800 to-slate-900 hover:from-black text-white font-bold py-3 rounded-xl shadow-lg transition transform active:scale-95">ê²½ê¸° í™•ì •</button>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden p-5">
                        <h3 class="font-bold text-slate-700 mb-4 border-b pb-2">ğŸ‘¤ ì„ ìˆ˜ ê´€ë¦¬ ë„êµ¬</h3>
                        <button onclick="addNewPlayer()" class="w-full bg-emerald-50 text-emerald-600 hover:bg-emerald-100 font-bold py-3 rounded-xl border border-emerald-100 mb-3 transition">+ ìƒˆ ì„ ìˆ˜ ë“±ë¡</button>
                        
                        <div class="bg-orange-50 border border-orange-200 rounded-xl p-3 mb-3">
                            <div class="flex justify-between items-center mb-2">
                                <h4 class="text-xs font-bold text-orange-700">â³ íœ´ë©´ ì ìˆ˜ ì°¨ê°</h4>
                                <span class="text-[10px] text-orange-600">5ì¼ ë¯¸í™œë™ -5ì </span>
                            </div>
                            <button onclick="applyDecay()" class="w-full bg-white text-orange-700 hover:bg-orange-100 font-bold py-2 rounded-lg text-xs border border-orange-200 transition">ğŸ”» ì°¨ê° ì‹¤í–‰</button>
                        </div>

                        <button onclick="updateRankBaseline()" class="w-full bg-slate-100 text-slate-600 hover:bg-slate-200 font-bold py-3 rounded-xl text-xs transition">ğŸ“‰ ìˆœìœ„ ë³€ë™(â–²â–¼) ë¦¬ì…‹</button>
                    </div>

                </div>

                <div id="seasonSection" class="tab-content hidden">
                    <div class="space-y-4">
                        <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden p-5">
                            <h3 class="font-bold text-slate-700 mb-3 border-b pb-2">ğŸ“… ì‹œì¦Œ ëª©ë¡</h3>
                            <div id="seasonListContainer" class="space-y-2 max-h-60 overflow-y-auto mb-2"></div>
                            <p class="text-[10px] text-slate-400 mt-2">* ëª©ë¡ì—ì„œ ì‚­ì œí•˜ë©´ ì‚¬ìš©ì í™”ë©´ì—ì„œë„ ì¦‰ì‹œ ì‚¬ë¼ì§‘ë‹ˆë‹¤.</p>
                        </div>
                        <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden p-5">
                            <div class="flex justify-between items-center mb-2">
                                <h3 class="font-bold text-slate-700">ğŸ˜´ ë¯¸ì°¸ì—¬ ì„ ìˆ˜</h3>
                                <span id="seasonInactiveCount" class="bg-slate-100 text-slate-600 text-xs font-bold px-2 py-1 rounded">0ëª…</span>
                            </div>
                            <div class="text-xs text-slate-500 mb-3">í˜„ì¬ ì‹œì¦Œ(<span class="currentSeasonName font-bold"></span>) ê²½ê¸° ê¸°ë¡ ì—†ìŒ</div>
                            <button onclick="toggleInactiveList()" class="text-xs text-blue-500 font-bold underline mb-2">ëª©ë¡ ë³´ê¸°/ìˆ¨ê¸°ê¸°</button>
                            <ul id="seasonInactiveList" class="hidden bg-slate-50 p-2 rounded text-xs text-slate-600 space-y-1 mb-3 max-h-40 overflow-y-auto border border-slate-200"></ul>
                        </div>
                        <div class="bg-purple-50 rounded-2xl shadow-sm border border-purple-100 overflow-hidden p-5">
                            <h3 class="font-bold text-purple-800 mb-2">ğŸš€ ì‹œì¦Œ ì¢…ë£Œ ë° ì‹œì‘</h3>
                            <p class="text-xs text-purple-600 mb-4">í˜„ì¬ ì‹œì¦Œì„ ë§ˆê°í•˜ê³  ìƒˆ ì‹œì¦Œì„ ì‹œì‘í•©ë‹ˆë‹¤.</p>
                            <div class="flex gap-2">
                                <input type="text" id="newSeasonNameInput" class="flex-grow border border-purple-200 rounded-lg p-2 text-sm focus:outline-none focus:border-purple-400" placeholder="ìƒˆ ì‹œì¦Œ ì´ë¦„">
                                <button onclick="finishAndStartNewSeason()" class="bg-purple-600 hover:bg-purple-700 text-white font-bold px-4 py-2 rounded-lg text-xs shadow transition whitespace-nowrap">ì‹œì¦Œ ì‹œì‘</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="toolsSection" class="tab-content hidden">
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden p-5 space-y-4">
                        <h3 class="font-bold text-slate-700">ğŸ› ï¸ ë°ì´í„° ë„êµ¬</h3>
                        <div class="grid grid-cols-2 gap-2">
                            <input type="file" id="importFile" accept=".json" class="hidden">
                            <button onclick="document.getElementById('importFile').click()" class="bg-slate-700 hover:bg-slate-800 text-white font-bold py-3 rounded-lg text-xs">ğŸ“‚ ë°ì´í„° ë³µì›</button>
                            <button onclick="backupData()" class="bg-slate-100 hover:bg-slate-200 text-slate-600 font-bold py-3 rounded-lg text-xs">ğŸ’¾ ë°ì´í„° ë°±ì—…</button>
                        </div>
                        <div class="pt-4 border-t border-slate-100 space-y-2">
                            <h4 class="text-xs font-bold text-red-500">ì´ˆê¸°í™” (ì£¼ì˜)</h4>
                            <button onclick="resetAllStats()" class="w-full bg-gray-50 text-gray-500 hover:bg-gray-100 font-bold py-2 rounded-lg text-xs border border-gray-200">ğŸ“Š í˜„ì¬ ì‹œì¦Œ ì „ì  ì´ˆê¸°í™”</button>
                            <button onclick="resetAllElo()" class="w-full bg-gray-50 text-gray-500 hover:bg-gray-100 font-bold py-2 rounded-lg text-xs border border-gray-200">âš¡ í˜„ì¬ ì‹œì¦Œ ELO ì´ˆê¸°í™”</button>
                            <button onclick="resetEverything()" class="w-full bg-red-50 text-red-600 hover:bg-red-100 font-bold py-3 rounded-lg text-xs border border-red-200 mt-2">ğŸ§¨ ì‹œìŠ¤í…œ ì „ì²´ ë¦¬ì…‹</button>
                        </div>
                    </div>
                </div>

            </div>

            <div class="lg:col-span-8 bg-white rounded-2xl shadow-sm border border-slate-100 flex flex-col h-[calc(100vh-140px)]">
                <div class="bg-slate-50 p-4 border-b border-slate-100 flex justify-between items-center rounded-t-2xl">
                    <div>
                        <h3 class="font-bold text-slate-700">ğŸ”¥ ì‹¤ì‹œê°„ ë­í‚¹</h3>
                        <p class="text-[10px] text-slate-400 font-medium mt-0.5">í˜„ì¬ í™œì„± ì‹œì¦Œ: <span class="currentSeasonName text-blue-600 font-bold"></span></p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="window.open('index.html')" class="bg-white border border-slate-200 text-slate-600 text-xs font-bold py-2 px-3 rounded-lg hover:bg-slate-50">ğŸŒ ì‚¬ì´íŠ¸ ë³´ê¸°</button>
                        <button onclick="saveRankings()" class="bg-indigo-600 text-white text-xs font-bold py-2 px-3 rounded-lg shadow hover:bg-indigo-700">ğŸ’¾ ì €ì¥</button>
                    </div>
                </div>
                <div id="rankingList" class="flex-grow overflow-y-auto p-2 space-y-1.5 bg-slate-50/50"></div>
            </div>
        </div>
    </div>

    <div id="editModal" class="fixed inset-0 bg-black/50 hidden z-[9999] flex items-center justify-center">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-11/12 max-w-lg max-h-[90vh] overflow-y-auto">
            <h3 class="text-lg font-bold text-slate-800 mb-4 border-b pb-2">âœï¸ ì„ ìˆ˜ ì •ë³´ ìˆ˜ì •</h3>
            <input type="hidden" id="editPlayerId"><input type="hidden" id="editOriginalName">
            <div class="grid grid-cols-2 gap-3 mb-3">
                <div><label class="text-xs text-gray-500 block mb-1">ì´ë¦„</label><input type="text" id="editName" class="w-full border p-2 rounded text-sm font-bold"></div>
                <div><label class="text-xs text-gray-500 block mb-1">ë°©ì–´ì „ íšŸìˆ˜ (ì œê±°ë¨)</label><input type="number" id="editDefenses" class="w-full border p-2 rounded text-sm bg-gray-100 text-gray-400" disabled></div>
            </div>
            <div class="grid grid-cols-2 gap-3 mb-3">
                 <div><label class="text-xs text-gray-500 block mb-1">Game ID</label><input type="text" id="editGameId" class="w-full border p-2 rounded text-sm" placeholder="ID ì…ë ¥"></div>
                <div><label class="text-xs text-gray-500 block mb-1">ELO ì ìˆ˜ (ìˆ˜ë™)</label><input type="number" id="editElo" class="w-full border p-2 rounded text-sm text-amber-600 font-bold bg-amber-50"></div>
            </div>
            <div class="mb-3 p-3 bg-gray-50 rounded border border-gray-200">
                <label class="block text-xs font-bold text-gray-600 mb-2">ğŸ“Š ì‹œì¦Œ ì „ì  ìˆ˜ë™ ì¡°ì ˆ</label>
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="text-xs text-gray-400">ìŠ¹ (Wins)</label><input type="number" id="editWins" class="w-full border p-2 rounded text-sm text-center font-bold text-green-600"></div>
                    <div><label class="text-xs text-gray-400">íŒ¨ (Losses)</label><input type="number" id="editLosses" class="w-full border p-2 rounded text-sm text-center font-bold text-red-600"></div>
                </div>
            </div>
            <div class="grid grid-cols-3 gap-3 mb-3">
                <div><label class="text-xs text-gray-500 block mb-1">í‚¤ (cm)</label><input type="text" id="editHeight" class="w-full border p-2 rounded text-sm"></div>
                <div><label class="text-xs text-gray-500 block mb-1">ë¦¬ì¹˜ (cm)</label><input type="text" id="editReach" class="w-full border p-2 rounded text-sm"></div>
                <div>
                    <label class="text-xs text-gray-500 block mb-1">ìŠ¤íƒ ìŠ¤</label>
                    <select id="editStance" class="w-full border p-2 rounded text-sm bg-white">
                        <option value="Orthodox">Orthodox</option>
                        <option value="Southpaw">Southpaw</option>
                        <option value="Switch">Switch</option>
                    </select>
                </div>
            </div>
            <div class="mb-4"><label class="text-xs text-gray-500 block mb-1">í”„ë¡œí•„ ì´ë¯¸ì§€ URL</label><input type="text" id="editImage" class="w-full border p-2 rounded text-sm text-gray-600" placeholder="https://..."></div>
            <div class="mb-6 p-3 bg-slate-50 rounded border border-slate-200">
                <label class="block text-xs font-bold text-slate-600 mb-2">ğŸ¥Š íŒŒì´íŒ… ìŠ¤íƒ€ì¼ íƒœê·¸</label>
                <div id="styleTagsContainer" class="flex flex-wrap gap-2"></div>
            </div>
            <div class="flex justify-end gap-2">
                <button onclick="document.getElementById('editModal').classList.add('hidden')" class="bg-gray-100 text-gray-600 hover:bg-gray-200 px-4 py-2 rounded-lg text-sm font-bold transition">ì·¨ì†Œ</button>
                <button onclick="savePlayerDetails()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg text-sm font-bold shadow transition">ì €ì¥í•˜ê¸°</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

        const firebaseConfig = { apiKey: "AIzaSyDlj68ex-fM0ExRdD-tvCy-UyIneVoPmGk", authDomain: "rfk-ranking.firebaseapp.com", projectId: "rfk-ranking", storageBucket: "rfk-ranking.firebasestorage.app", messagingSenderId: "675366165774", appId: "1:675366165774:web:795d34c56eab630b4dcb5f", measurementId: "G-CXPDZQ8GTL" };
        const app = initializeApp(firebaseConfig); const db = getFirestore(app); const auth = getAuth(app); const appId = 'ranking-manager-default';
        let rankingsData = []; let matchHistoryData = []; let seasonArchives = {}; let activeSeason = "ì‹œì¦Œ 1";
        const STYLE_OPTIONS = ["ì¸íŒŒì´í„°", "ì•„ì›ƒë³µì„œ", "ìŠ¬ëŸ¬ê±°", "ì¹´ìš´í„°", "ìŠ¤ì›Œë¨¸", "í•˜ë“œí€ì²˜", "í…Œí¬ë‹ˆì…˜", "ë§·ì§‘ì™•", "ë³€ì¹™"];

        document.getElementById('btnLogin').addEventListener('click', () => { const email = document.getElementById('adminEmail').value; const pw = document.getElementById('adminPw').value; signInWithEmailAndPassword(auth, email, pw).catch((e) => alert("ë¡œê·¸ì¸ ì‹¤íŒ¨: " + e.message)); });
        onAuthStateChanged(auth, (user) => { if (user) { document.getElementById('loginOverlay').classList.add('hidden'); document.getElementById('mainContent').classList.remove('hidden'); loadData(); } });

        function loadData() {
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'rankings', 'main');
            onSnapshot(docRef, (doc) => {
                if (doc.exists()) {
                    const data = doc.data(); rankingsData = data.rankings || []; matchHistoryData = data.matchHistory || []; seasonArchives = data.seasonArchives || {}; activeSeason = data.activeSeason || "ì‹œì¦Œ 1";
                    updateSeasonUI();
                    rankingsData.forEach((p, i) => { if(p.defenseCount === undefined) p.defenseCount = 0; if(p.previousRank === undefined) p.previousRank = i + 1; if(p.careerHighRank === undefined) p.careerHighRank = i + 1; if(p.elo === undefined) p.elo = 1000; if(p.careerHighElo === undefined) p.careerHighElo = p.elo; });
                    rankingsData.sort((a, b) => b.elo - a.elo); renderRankings(); populateMatchSelectors(); 
                    renderSeasonList(); checkSeasonInactive();
                }
            });
        }

        window.saveRankings = async function() {
            const statusEl = document.getElementById('saveStatus'); const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'rankings', 'main');
            try { const now = new Date(); const kstDate = new Date(now.getTime() + (9 * 60 * 60 * 1000)).toISOString().split('T')[0]; await setDoc(docRef, { rankings: rankingsData, matchHistory: matchHistoryData, seasonArchives: seasonArchives, activeSeason: activeSeason, date: kstDate }, { merge: false }); statusEl.style.opacity = 1; setTimeout(() => statusEl.style.opacity = 0, 2000); } catch (e) { alert("ì €ì¥ ì˜¤ë¥˜: " + e.message); }
        }

        // ... (Season Logic: renderSeasonList, deleteSeason, etc. - kept same) ...
        function updateSeasonUI() {
            document.getElementById('currentSeasonBadge').textContent = activeSeason; document.querySelectorAll('.currentSeasonName').forEach(el => el.textContent = activeSeason);
            const num = parseInt(activeSeason.replace(/[^0-9]/g, '')) || 0; document.getElementById('newSeasonNameInput').value = `ì‹œì¦Œ ${num + 1}`;
        }
        function renderSeasonList() {
            const container = document.getElementById('seasonListContainer'); container.innerHTML = '';
            const seasons = [activeSeason, ...Object.keys(seasonArchives).sort().reverse().filter(s => s !== activeSeason)];
            seasons.forEach(sName => {
                const isActive = sName === activeSeason;
                const div = document.createElement('div');
                div.className = `flex justify-between items-center p-3 rounded-lg border ${isActive ? 'bg-blue-50 border-blue-300' : 'bg-white border-slate-200'}`;
                div.innerHTML = `<div class="flex items-center gap-2"><span class="${isActive ? 'text-blue-700 font-bold' : 'text-slate-600'} text-sm">${sName}</span>${isActive ? '<span class="text-[10px] bg-blue-600 text-white px-1.5 py-0.5 rounded">Active</span>' : ''}</div><div class="flex gap-1">${!isActive ? `<button onclick="switchActiveSeason('${sName}')" class="text-xs bg-slate-100 hover:bg-slate-200 text-slate-700 px-2 py-1 rounded border border-slate-200">ì„ íƒ</button>` : ''}<button onclick="renameSeason('${sName}')" class="text-xs bg-slate-100 hover:bg-slate-200 text-slate-500 px-2 py-1 rounded border border-slate-200">ì´ë¦„ë³€ê²½</button>${!isActive ? `<button onclick="deleteSeason('${sName}')" class="text-xs bg-red-50 hover:bg-red-100 text-red-500 px-2 py-1 rounded border border-red-100">ì‚­ì œ</button>` : ''}</div>`;
                container.appendChild(div);
            });
        }
        window.deleteSeason = (targetName) => {
            if (targetName === activeSeason) return alert("í˜„ì¬ í™œì„± ì‹œì¦Œì€ ì‚­ì œ ë¶ˆê°€"); if (!confirm(`[${targetName}] ë° ê¸°ë¡ ì‚­ì œ?`)) return;
            delete seasonArchives[targetName];
            matchHistoryData = matchHistoryData.filter(m => m.season !== targetName);
            saveRankings().then(() => { renderSeasonList(); alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤."); });
        };
        window.switchActiveSeason = (targetName) => { if (!confirm(`[${targetName}] ì „í™˜?`)) return; seasonArchives[activeSeason] = { rankings: JSON.parse(JSON.stringify(rankingsData)) }; const t = seasonArchives[targetName]; if (t) rankingsData = t.rankings || []; delete seasonArchives[targetName]; activeSeason = targetName; saveRankings(); alert("ì „í™˜ ì™„ë£Œ"); };
        window.renameSeason = (old) => { const n = prompt("ìƒˆ ì´ë¦„:", old); if(!n||n===old)return; if(n===activeSeason||seasonArchives[n])return alert("ì¤‘ë³µ ì´ë¦„"); if(old===activeSeason)activeSeason=n; else { seasonArchives[n]=seasonArchives[old]; delete seasonArchives[old]; } matchHistoryData.forEach(m => { if(m.season===old) m.season=n; }); saveRankings(); };
        window.finishAndStartNewSeason = () => { const n = document.getElementById('newSeasonNameInput').value.trim(); if(!n)return alert("ì´ë¦„ ì…ë ¥"); if(n===activeSeason||seasonArchives[n])return alert("ì¤‘ë³µ ì´ë¦„"); if(!confirm(`[${activeSeason}] ì¢…ë£Œ í›„ [${n}] ì‹œì‘?`))return; seasonArchives[activeSeason]={rankings:JSON.parse(JSON.stringify(rankingsData))}; activeSeason=n; rankingsData.forEach(p => { p.previousRank=p.rank||rankingsData.indexOf(p)+1; p.wins=0; p.losses=0; p.draws=0; p.defenseCount=0; p.elo=1000; }); saveRankings(); alert("ì‹œì‘ë¨"); };

        // [ì¤‘ìš” Fix] ë°©ì–´ì „ ë¡œì§ ì œê±° (Pure Ranking Match)
        window.applyMatch = () => {
            const p1Idx = parseInt(document.getElementById('p1Select').value); const p2Idx = parseInt(document.getElementById('p2Select').value); const winnerVal = document.querySelector('input[name="winner"]:checked')?.value;
            if (!winnerVal || isNaN(p1Idx) || isNaN(p2Idx)) return alert("ì„ íƒ ì˜¤ë¥˜"); if (p1Idx === p2Idx) return alert("ë™ì¼ ì„ ìˆ˜");
            const p1 = rankingsData[p1Idx]; const p2 = rankingsData[p2Idx];
            const isBlueWin = winnerVal === 'blue'; const winner = isBlueWin ? p1 : p2; const loser = isBlueWin ? p2 : p1;
            const winCalc = calculateHybridEloChange(winner.elo, loser.elo, true, winner); const loseCalc = calculateHybridEloChange(loser.elo, winner.elo, false, loser);
            winner.elo += winCalc.change; loser.elo += loseCalc.change;
            if (winner.elo > (winner.careerHighElo || 0)) winner.careerHighElo = winner.elo; if (loser.elo > (loser.careerHighElo || 0)) loser.careerHighElo = loser.elo;
            
            // [Fix] íƒ€ì… ë‹¨ìˆœí™” & ë°©ì–´ ì¹´ìš´íŠ¸ ì œê±°
            let type = 'ranking'; 

            winner.wins++; loser.losses++;
            const today = new Date().toISOString().split('T')[0]; winner.lastMatchDate = today; loser.lastMatchDate = today;
            rankingsData.sort((a, b) => b.elo - a.elo);
            matchHistoryData.unshift({ date: today, winner: isBlueWin ? p1.name : p2.name, loser: isBlueWin ? p2.name : p1.name, type, season: activeSeason, blue: p1.name });
            saveRankings(); renderRankings(); alert(`ë°˜ì˜ ì™„ë£Œ!\n${winner.name}: +${winCalc.change}\n${loser.name}: ${loseCalc.change}`);
        };

        // ... (Common functions) ...
        function getTierBonus(matchCount, isWin) { if (matchCount < 4) return { mult: 1.0, reduction: 0, tier: 'Bronze' }; if (matchCount < 7) return { mult: 1.1, reduction: 0, tier: 'Silver' }; return { mult: 1.2, reduction: 0.1, tier: 'Gold' }; }
        function calculateHybridEloChange(p1Elo, p2Elo, isWin, p1Stats) { const result = isWin ? 1 : 0; const K = 20; const expected = 1 / (1 + Math.pow(10, (p2Elo - p1Elo) / 400)); let baseChange = K * (result - expected); const matchCount = (p1Stats.wins || 0) + (p1Stats.losses || 0); const { mult, reduction, tier } = getTierBonus(matchCount, isWin); let finalChange = 0; let breakdown = ""; if (isWin) { finalChange = (baseChange * mult) + 10; breakdown = `ê¸°ë³¸(+${Math.round(baseChange)}) x ${mult}(${tier}) + 10`; } else { let loss = baseChange; if (reduction > 0) loss = loss * (1 - reduction); finalChange = loss + 10; if (finalChange < -20) { finalChange = -20; breakdown = `í•˜í•œì„ (-20)`; } else { breakdown = `ê¸°ë³¸(${Math.round(baseChange)}) ${reduction>0 ? '+ë°©ì–´' : ''} + 10`; } } return { change: Math.round(finalChange), msg: breakdown }; }
        function updateMatchPreview() { const p1Val = document.getElementById('p1Select').value; const p2Val = document.getElementById('p2Select').value; if (p1Val === "" || p2Val === "" || p1Val === p2Val) { document.getElementById('matchPreview').classList.add('hidden'); return; } document.getElementById('matchPreview').classList.remove('hidden'); const p1 = rankingsData[parseInt(p1Val)]; const p2 = rankingsData[parseInt(p2Val)]; const blueWin = calculateHybridEloChange(p1.elo, p2.elo, true, p1); const redLose = calculateHybridEloChange(p2.elo, p1.elo, false, p2); const redWin = calculateHybridEloChange(p2.elo, p1.elo, true, p2); const blueLose = calculateHybridEloChange(p1.elo, p2.elo, false, p1); document.getElementById('previewContent').innerHTML = `<div class="font-bold text-blue-600">ğŸ”µ BlueìŠ¹: +${blueWin.change} / ğŸ”´ RedíŒ¨: ${redLose.change}</div><div class="font-bold text-red-600 mt-1">ğŸ”´ RedìŠ¹: +${redWin.change} / ğŸ”µ BlueíŒ¨: ${blueLose.change}</div>`; }
        document.getElementById('p1Select').addEventListener('change', updateMatchPreview); document.getElementById('p2Select').addEventListener('change', updateMatchPreview);
        window.resetAllElo = () => { if(!confirm("ELO 1000 ì´ˆê¸°í™”?")) return; rankingsData.forEach(p => p.elo = 1000); saveRankings(); renderRankings(); };
        window.resetAllStats = () => { if(!confirm("ì „ì  0 ì´ˆê¸°í™”?")) return; rankingsData.forEach(p => { p.wins = 0; p.losses = 0; }); saveRankings(); renderRankings(); };
        window.resetEverything = () => { if(!confirm("ğŸš¨ ì „ì²´ ë¦¬ì…‹?")) return; matchHistoryData = []; seasonArchives = {}; activeSeason = "ì‹œì¦Œ 1"; rankingsData.forEach(p => { p.wins=0; p.losses=0; p.defenseCount=0; p.elo=1000; p.careerHighElo=1000; }); saveRankings(); location.reload(); };
        window.updateRankBaseline = () => { if(confirm("ë³€ë™í­ ë¦¬ì…‹?")) { rankingsData.forEach((p, i) => p.previousRank = i + 1); saveRankings(); renderRankings(); } };
        window.applyDecay = () => { if (!confirm("5ì¼ ë¯¸í™œë™ ì°¨ê°?")) return; const now = new Date(); let c=0; rankingsData.forEach(p => { if(!p.lastMatchDate) return; if(Math.ceil(Math.abs(now-new Date(p.lastMatchDate))/(86400000))>5) { p.elo-=5; c++; } }); if(c>0) { rankingsData.sort((a,b)=>b.elo-a.elo); saveRankings(); renderRankings(); alert(`${c}ëª… ì°¨ê°`); } else alert("ëŒ€ìƒ ì—†ìŒ"); };
        function checkSeasonInactive() { const list = document.getElementById('seasonInactiveList'); list.innerHTML = ''; const m = matchHistoryData.filter(m => m.season === activeSeason); const an = new Set(); m.forEach(m => { an.add(m.winner); an.add(m.loser); }); const inact = rankingsData.filter(p => !an.has(p.name)); document.getElementById('seasonInactiveCount').textContent = inact.length + "ëª…"; inact.forEach(p => { list.innerHTML += `<li>${p.name}</li>`; }); }
        window.toggleInactiveList = () => document.getElementById('seasonInactiveList').classList.toggle('hidden');
        
        // [Fix] ë­í‚¹ ë¦¬ìŠ¤íŠ¸ ë Œë”ë§ - ë°©íŒ¨ ì•„ì´ì½˜ ì œê±°
        function renderRankings() { 
            const list = document.getElementById('rankingList'); list.innerHTML = ''; 
            rankingsData.forEach((item, index) => { 
                const diff = (item.previousRank || (index + 1)) - (index + 1); 
                let ch = diff > 0 ? `<span class="rank-up">â–²${diff}</span>` : (diff < 0 ? `<span class="rank-down">â–¼${Math.abs(diff)}</span>` : '<span class="rank-keep">-</span>'); 
                
                list.innerHTML += `
                    <div class="rank-card flex items-center p-3 border rounded-xl mb-2 bg-white hover:shadow-md">
                        <div class="w-10 text-center mr-2">
                            <span class="text-lg font-black text-slate-800">${index+1}</span>
                            <div class="text-[10px]">${ch}</div>
                        </div>
                        <div class="flex-grow">
                            <div class="font-bold text-sm text-slate-800 flex items-center gap-2">
                                ${item.name} 
                                <span class="bg-amber-100 text-amber-800 text-xs px-1.5 rounded border border-amber-200">âš¡${item.elo}</span>
                            </div>
                            <div class="text-xs text-slate-500 mt-0.5">${item.wins}ìŠ¹ ${item.losses}íŒ¨</div>
                        </div>
                        <button onclick="openEditModal(${index})" class="p-2 text-slate-400 hover:text-blue-600">âœï¸</button>
                    </div>`; 
            }); 
            populateMatchSelectors(); 
        }
        
        window.populateMatchSelectors = () => { const s1 = document.getElementById('p1Select'); const s2 = document.getElementById('p2Select'); let opts = '<option value="">ì„ ìˆ˜ ì„ íƒ</option>'; rankingsData.forEach((p, i) => opts += `<option value="${i}">${i+1}ìœ„ ${p.name} (${p.elo})</option>`); s1.innerHTML = opts; s2.innerHTML = opts; };
        window.addNewPlayer = () => { const name = prompt("ì´ë¦„:"); if(name) { rankingsData.push({ id: crypto.randomUUID(), name, wins:0, losses:0, defenseCount:0, previousRank: rankingsData.length+1, careerHighRank: rankingsData.length+1, elo: 1000, careerHighElo: 1000, lastMatchDate: new Date().toISOString().split('T')[0] }); saveRankings(); renderRankings(); } };
        window.openEditModal = (idx) => { const p = rankingsData[idx]; document.getElementById('editPlayerId').value = idx; document.getElementById('editName').value = p.name; document.getElementById('editOriginalName').value = p.name; document.getElementById('editDefenses').value = 0; document.getElementById('editImage').value = p.imageUrl || ''; document.getElementById('editGameId').value = p.gameId || ''; document.getElementById('editHeight').value = p.height || ''; document.getElementById('editReach').value = p.reach || ''; document.getElementById('editStance').value = p.stance || 'Orthodox'; document.getElementById('editElo').value = p.elo || 1000; document.getElementById('editWins').value = p.wins || 0; document.getElementById('editLosses').value = p.losses || 0; renderStyleTags(p.tags || []); document.getElementById('editModal').classList.remove('hidden'); };
        function renderStyleTags(cT) { const c = document.getElementById('styleTagsContainer'); c.innerHTML = ''; STYLE_OPTIONS.forEach(s => { const id = `style-${s}`; c.innerHTML += `<div><input type="checkbox" id="${id}" value="${s}" class="style-checkbox hidden" ${cT.includes(s)?'checked':''}><label for="${id}" class="inline-block px-3 py-1 text-xs font-bold border border-slate-300 rounded-full cursor-pointer text-slate-500 hover:bg-slate-100 transition select-none ${cT.includes(s)?'bg-blue-500 text-white border-blue-500':''}">${s}</label></div>`; }); }
        window.savePlayerDetails = () => { const idx = document.getElementById('editPlayerId').value; const p = rankingsData[idx]; p.name = document.getElementById('editName').value; p.defenseCount = 0; p.imageUrl = document.getElementById('editImage').value; p.gameId = document.getElementById('editGameId').value; p.height = document.getElementById('editHeight').value; p.reach = document.getElementById('editReach').value; p.stance = document.getElementById('editStance').value; p.elo = parseInt(document.getElementById('editElo').value)||1000; p.wins = parseInt(document.getElementById('editWins').value)||0; p.losses = parseInt(document.getElementById('editLosses').value)||0; const ct = document.querySelectorAll('.style-checkbox:checked'); p.tags = Array.from(ct).map(cb => cb.value); rankingsData.sort((a, b) => b.elo - a.elo); saveRankings(); document.getElementById('editModal').classList.add('hidden'); renderRankings(); };
        window.updateSeasonName = () => { activeSeason = document.getElementById('seasonNameInput').value; saveRankings(); };
    </script>
</body>
</html>
