<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RFC ë­í‚¹ì „ ìˆœìœ„ ê´€ë¦¬ê¸° v1.74</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Nanum+Gothic+Coding:wght@400;700&display=swap');
        
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fb; }
        .rank-item { cursor: grab; transition: background-color 0.2s, border-width 0.1s; }
        .rank-item:active { cursor: grabbing; }
        .rank-item.dragging { opacity: 0.5; border: 2px dashed #3b82f6; }
        .rank-number { font-weight: 800; width: 3.5rem; text-align: center; cursor: pointer; transition: color 0.2s; } 
        .rank-number:hover { color: #3b82f6 !important; text-decoration: underline; }

        .note-input {
            border: none; outline: none; background-color: transparent; padding: 0;
            text-overflow: ellipsis; overflow: hidden; white-space: nowrap; 
        }
        .note-input:focus {
            background-color: rgba(255, 255, 255, 0.8); padding: 0.25rem 0.5rem; border-radius: 6px; box-shadow: 0 0 0 2px #3b82f6;
        }

        .change-input { text-align: center !important; }
        #rankingList { height: auto; overflow-y: visible; } 
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.5); display: flex; justify-content: center; align-items: center; z-index: 1000;
        }
        
        #exportContent.font-mono, #vsExportContent.font-mono { 
            font-family: 'Nanum Gothic Coding', 'D2Coding', Consolas, monospace !important; 
            line-height: 1.5;
            white-space: pre;
            tab-size: 4; 
        }
        
        #dragStatusBadge {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 9999;
            background-color: rgba(31, 41, 55, 0.9); color: white; padding: 10px 20px; border-radius: 9999px; font-weight: 600;
            pointer-events: none; opacity: 0; transition: opacity 0.2s, transform 0.2s;
        }
        #dragStatusBadge.visible { opacity: 1; transform: translateX(-50%) translateY(0); }

        .highlighted-row { background-color: #fef9c3 !important; border-left-color: #eab308 !important; border-left-width: 8px !important; }
        .winner-pulse { animation: highlight-winner 10s ease-out; z-index: 20; position: relative; border-left-color: #22c55e !important; }
        .loser-pulse { animation: highlight-loser 10s ease-out; z-index: 19; position: relative; border-left-color: #ef4444 !important; }
        @keyframes highlight-winner {
            0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); background-color: #dcfce7; transform: scale(1.02); }
            50% { box-shadow: 0 0 0 8px rgba(34, 197, 94, 0); background-color: #dcfce7; transform: scale(1.02); }
            100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); transform: scale(1); }
        }
        @keyframes highlight-loser {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); background-color: #fee2e2; transform: scale(0.98); }
            50% { box-shadow: 0 0 0 8px rgba(239, 68, 68, 0); background-color: #fee2e2; transform: scale(0.98); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); transform: scale(1); }
        }

        .log-container { max-height: 200px; overflow-y: auto; scrollbar-width: thin; font-size: 0.8rem; }
        .log-entry { padding: 4px 8px; border-bottom: 1px solid #f3f4f6; color: #4b5563; display: flex; justify-content: space-between; align-items: flex-start; }
        .log-entry:last-child { border-bottom: none; }
        .log-time { color: #9ca3af; margin-right: 6px; font-size: 0.75rem; white-space: nowrap; }
        .delete-log-btn { opacity: 0; transition: opacity 0.2s; cursor: pointer; }
        .log-entry:hover .delete-log-btn { opacity: 1; }

        .tab-btn { border-bottom: 2px solid transparent; transition: all 0.2s; }
        .hof-card { background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); text-align: center; border: 1px solid #e5e7eb; }
        .hof-champion { background: linear-gradient(135deg, #fffbeb 0%, #fff 100%); border: 2px solid #fbbf24; }
        .hof-silver { background: linear-gradient(135deg, #f8fafc 0%, #fff 100%); border: 2px solid #94a3b8; }
        .hof-bronze { background: linear-gradient(135deg, #fff7ed 0%, #fff 100%); border: 2px solid #fdba74; }
        .hof-defense { background: linear-gradient(135deg, #eff6ff 0%, #fff 100%); border: 2px solid #60a5fa; }
        .hof-passion { background: linear-gradient(135deg, #fef2f2 0%, #fff 100%); border: 2px solid #ef4444; }
        
        .match-card { background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 12px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; border-left: 4px solid #9ca3af; }
        .match-card.defense-success { border-left-color: #3b82f6; background-color: #eff6ff; } 
        .match-card.challenge-success { border-left-color: #ef4444; background-color: #fef2f2; } 
        .match-card.challenge-fail { border-left-color: #9ca3af; background-color: #f3f4f6; } 
        .match-vs { font-size: 0.8rem; color: #9ca3af; margin: 0 8px; font-weight: bold; }
        
        .win-loss-input { -moz-appearance: textfield; text-align: center; background: transparent; font-family: 'Inter', sans-serif; border-radius: 4px; }
        .win-loss-input::-webkit-outer-spin-button, .win-loss-input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .win-loss-input:focus { background-color: white; box-shadow: 0 0 0 2px #e5e7eb; outline: none; }
        
        #h2hPlayerA, #h2hPlayerB { font-family: 'Nanum Gothic Coding', 'Courier New', monospace !important; font-size: 15px !important; padding-top: 0.6rem !important; padding-bottom: 0.6rem !important; white-space: pre; }

        /* Tournament Styles */
        .bracket-container {
            display: flex; flex-direction: row; justify-content: flex-start;
            overflow-x: auto; padding: 20px 0; min-height: 500px;
        }
        .bracket-round {
            display: flex; flex-direction: column;
            min-width: 180px; margin-right: 30px; position: relative;
        }
        .bracket-matches {
            flex: 1; display: flex; flex-direction: column; justify-content: space-around; width: 100%;
        }
        .bracket-pair {
            display: flex; flex-direction: column; justify-content: space-around;
            flex: 1; position: relative; margin-bottom: 10px;
        }
        .bracket-match {
            background: white; border: 1px solid #e5e7eb; border-radius: 8px;
            padding: 8px; margin: 4px 0; box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            position: relative; cursor: pointer; transition: all 0.2s; z-index: 10;
        }
        .bracket-match:hover { box-shadow: 0 4px 6px rgba(0,0,0,0.1); border-color: #3b82f6; }
        .bracket-team { padding: 4px; border-radius: 4px; font-size: 13px; display: flex; justify-content: space-between; }
        .bracket-team.winner { background-color: #eff6ff; color: #1d4ed8; font-weight: bold; }
        .bracket-team.loser { color: #9ca3af; text-decoration: line-through; }
        
        /* Prediction Styles */
        .prediction-bar-container { background-color: #e5e7eb; border-radius: 9999px; height: 12px; width: 100%; position: relative; overflow: hidden; margin-top: 4px; }
        .prediction-bar-fill { height: 100%; transition: width 0.5s ease-out; }
        .prediction-vs-badge { position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); background: white; padding: 0 6px; font-size: 10px; font-weight: bold; color: #6b7280; border-radius: 10px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }

        /* Connector Styles */
        .pair-connector {
            position: absolute; top: 25%; bottom: 25%; right: -20px; width: 20px;
            border-right: 2px solid #cbd5e1; border-top: 2px solid #cbd5e1; border-bottom: 2px solid #cbd5e1;
            pointer-events: none;
        }
        .pair-connector::after {
            content: ''; position: absolute; top: 50%; right: -20px; width: 20px; height: 2px;
            background-color: #cbd5e1; transform: translateY(-50%);
        }
        .final-connector {
            position: absolute; right: -30px; top: 50%; width: 30px; height: 2px;
            background-color: #cbd5e1; z-index: 0;
        }

        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .recent-dot { cursor: pointer; transition: transform 0.1s; }
        .recent-dot:hover { transform: scale(1.2); }
        .recent-dot:active { transform: scale(0.9); }
        
        /* Profile Image Styles (Trading Card Style) */
        .profile-image-container {
            width: 100%; 
            height: 350px; /* ì„¸ë¡œë¡œ ê¸¸ê²Œ ì„¤ì •í•˜ì—¬ ì „ì‹ /ì¥ë¹„ê°€ ì˜ ë³´ì´ë„ë¡ í•¨ */
            background-color: #e5e7eb; 
            position: relative; 
            cursor: pointer; 
            z-index: 10;
            overflow: hidden;
        }
        .profile-image-container img { 
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
            object-position: top center; /* ì–¼êµ´ ìœ„ì£¼ë¡œ ì •ë ¬í•˜ë˜ ì•„ë˜ë¡œ í™•ì¥ */
        }
        .profile-image-container:hover::after {
            content: 'ì‚¬ì§„ ë³€ê²½'; 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.3); color: white; 
            display: flex; justify-content: center; align-items: center;
            font-size: 16px; font-weight: bold;
            pointer-events: none; /* í´ë¦­ ì´ë²¤íŠ¸ë¥¼ ì•„ë˜ ì´ë¯¸ì§€ ì»¨í…Œì´ë„ˆë¡œ í†µê³¼ì‹œí‚´ */
            backdrop-filter: blur(2px);
        }
        .profile-stat-box { background-color: #f9fafb; border-radius: 8px; padding: 8px; text-align: center; border: 1px solid #e5e7eb; }

        /* Matchup Analysis Styles */
        .matchup-item { display: flex; align-items: center; justify-content: space-between; padding: 6px 8px; background-color: #f8fafc; border-radius: 6px; margin-bottom: 4px; font-size: 12px; }
        .matchup-label { font-weight: bold; width: 80px; flex-shrink: 0; } 
        .matchup-name { flex-grow: 1; text-align: left; padding-left: 8px; font-weight: 600; color: #374151; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .matchup-score { font-family: 'Nanum Gothic Coding', monospace; font-weight: bold; color: #6b7280; margin-left: 4px; }

        /* Log List Styles */
        .profile-log-container { overflow-y: auto; background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; padding: 4px; margin-top: 4px; }
        .profile-log-item { display: flex; align-items: center; justify-content: space-between; padding: 6px 8px; border-bottom: 1px solid #f3f4f6; font-size: 11px; }
        .profile-log-item:last-child { border-bottom: none; }
        .log-badge { padding: 2px 6px; border-radius: 4px; font-weight: 800; font-size: 10px; min-width: 30px; text-align: center; margin-right: 8px; }
        .log-badge.win { background-color: #fef2f2; color: #dc2626; border: 1px solid #fecaca; }
        .log-badge.loss { background-color: #eff6ff; color: #2563eb; border: 1px solid #dbeafe; }
        .log-vs-name { font-weight: 600; color: #374151; flex-grow: 1; text-align: left; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .log-date { color: #9ca3af; font-size: 10px; margin-left: 4px; white-space: nowrap; }

        /* Tag Styles */
        .tag-badge { display: inline-block; padding: 2px 8px; margin: 2px; border-radius: 9999px; font-size: 15px; font-weight: 600; background-color: #f3f4f6; color: #4b5563; border: 1px solid #d1d5db; transition: all 0.2s; }
        .tag-badge:hover { background-color: #e5e7eb; border-color: #9ca3af; }
        .tag-empty { color: #9ca3af; font-size: 15px; border: 1px dashed #d1d5db; padding: 2px 8px; border-radius: 9999px; }

        /* Debug Mode Styles */
        body.debug-mode * { outline: 1px dashed rgba(255, 0, 0, 0.5) !important; }
        body.debug-mode .rank-item > div, body.debug-mode #rankingHeader > div { background-color: rgba(255, 255, 0, 0.1); outline: 1px solid red !important; }

        /* Accordion Styles */
        details > summary { list-style: none; }
        details > summary::-webkit-details-marker { display: none; }
        
        @media print {
            .max-w-xl, .max-w-2xl, #controlButtons, #searchSortBar, #noteBlock, #loading, #exportModal, #printPreviewModal, #matchModal, #dragStatusBadge, #logSection, #tabContainer, #nonPartModal, #confirmModal, #seasonControlBar, #tournamentSetupModal, #randomTournamentModal, #backupRestoreModal, #vsExportModal, #profileModal, #tagSelectionModal, #imageEditModal { display: none !important; }
            #printableArea { display: block !important; width: 100%; margin: 0; padding: 0; zoom: 0.7; }
            body, html { background-color: white !important; padding: 0 !important; margin: 0 !important; }
            @page { size: landscape; margin: 5mm; }
        }
    </style>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'ranking-manager-default';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const LOCAL_STORAGE_KEY = 'ranking-manager-data-v10';

        let db = null;
        let auth = null;
        let rankingsData = [];
        let logsData = []; 
        let matchHistoryData = []; 
        let previousRankingsData = []; 
        let seasonArchives = {}; 
        
        let tournamentData = { active: false, size: 0, rounds: [] };
        let randomSelectionCandidates = [];
        
        let dragSrcEl = null;
        let dragStartIndex = -1; 
        let loadingElement = null; 
        let syncTimeout = null; 
        let oldIndexMap = new Map(); 
        let currentRankingDate = ''; 
        let defenseSnapshot = null; 
        
        let currentSeasonTitle = "ì‹œì¦Œ 1"; 
        let activeSeason = "ì‹œì¦Œ 1"; 
        let viewSeason = "ì‹œì¦Œ 1";   
        let currentSeasonBestMatch = "";
        
        let historyStack = [];
        const MAX_HISTORY = 20; 
        const MAX_LOGS = 400; 
        let confirmCallback = null; 
        
        // ë¯¸ë¦¬ ì •ì˜ëœ ìŠ¤íƒ€ì¼ íƒœê·¸ ëª©ë¡
        const PREDEFINED_TAGS = ["ì˜¤ì†Œë…ìŠ¤", "ì‚¬ìš°ìŠ¤í¬", "ì¸íŒŒì´í„°", "ì•„ì›ƒë³µì„œ", "ìŠ¬ëŸ¬ê±°", "ìŠ¤ì›Œë¨¸", "ì¹´ìš´í„°", "ìŠ¤ìœ„ì¹˜", "í•˜ë“œí€ì²˜", "í…Œí¬ë‹ˆì…˜"];
        let currentTagEditPlayerId = null;
        
        // [ì¶”ê°€] í”„ë¡œí•„ ì´ë¯¸ì§€ í¸ì§‘ì„ ìœ„í•œ ì „ì—­ ë³€ìˆ˜
        let currentProfileId = null;
        let currentEditingPlayerId = null; // ì´ë¯¸ì§€ í¸ì§‘ìš©

        const structuredSeedData = [
            { name: "ë‹¤ë‹ˆì—˜", notes: "S ë°©ì–´ì „ 1", previousRank: 1, isParticipating: true, wins: 0, losses: 0, recentMatchResults: [0,0,0,0,0,0], careerHighRank: 1, tags: [], adminMemo: '', gameId: '' },
            { name: "ë§ë”©ë™", notes: "S ë°©ì–´ì „ 1", previousRank: 2, isParticipating: true, wins: 1, losses: 0, recentMatchResults: [0,0,0,0,0,0], careerHighRank: 2, tags: [], adminMemo: '', gameId: '' },
            { name: "ë¹„ë²„", notes: "S ë°©ì–´ì „ 5", previousRank: 3, isParticipating: true, wins: 2, losses: 0, recentMatchResults: [0,0,0,0,0,0], careerHighRank: 3, tags: [], adminMemo: '', gameId: '' },
            { name: "ì¡°ìŠˆì•„", notes: "ë°©ì–´ì „ 1", previousRank: 4, isParticipating: true, wins: 0, losses: 0, recentMatchResults: [0,0,0,0,0,0], careerHighRank: 4, tags: [], adminMemo: '', gameId: '' },
            { name: "ë¡œë§ˆì²¸ì½”", notes: "-", previousRank: 5, isParticipating: false, wins: 0, losses: 0, recentMatchResults: [0,0,0,0,0,0], careerHighRank: 5, tags: [], adminMemo: '', gameId: '' },
            { name: "í†µ", notes: "ë°©ì–´ì „ 1", previousRank: 6, isParticipating: true, wins: 1, losses: 2, recentMatchResults: [0,0,0,0,0,0], careerHighRank: 6, tags: [], adminMemo: '', gameId: '' },
            { name: "ì†œë°©ë§ì´", notes: "ë°©ì–´ì „ 1", previousRank: 11, isParticipating: true, wins: 1, losses: 0, recentMatchResults: [0,0,0,0,0,0], careerHighRank: 11, tags: [], adminMemo: '', gameId: '' },
            { name: "ë¼ˆì•½ì", notes: "ë°©ì–´ì „ 2", previousRank: 7, isParticipating: true, wins: 0, losses: 2, recentMatchResults: [0,0,0,0,0,0], careerHighRank: 7, tags: [], adminMemo: '', gameId: '' },
            { name: "ê±¸ìƒŒ", notes: "-", previousRank: 8, isParticipating: false, wins: 0, losses: 0, recentMatchResults: [0,0,0,0,0,0], careerHighRank: 8, tags: [], adminMemo: '', gameId: '' },
            { name: "ë¦¬ë²„ë¦°", notes: "-", previousRank: 9, isParticipating: false, wins: 0, losses: 0, recentMatchResults: [0,0,0,0,0,0], careerHighRank: 9, tags: [], adminMemo: '', gameId: '' },
            { name: "ë²„í•", notes: "ë°©ì–´ì „ 4", previousRank: 10, isParticipating: true, wins: 0, losses: 0, recentMatchResults: [0,0,0,0,0,0], careerHighRank: 10, tags: [], adminMemo: '', gameId: '' },
            { name: "íŒŒì´ëˆ", notes: "-", previousRank: 12, isParticipating: false, wins: 0, losses: 0, recentMatchResults: [0,0,0,0,0,0], careerHighRank: 12, tags: [], adminMemo: '', gameId: '' },
            { name: "ìŠ¤íƒ€ì¹´í† ", notes: "-", previousRank: 13, isParticipating: false, wins: 0, losses: 0, recentMatchResults: [0,0,0,0,0,0], careerHighRank: 13, tags: [], adminMemo: '', gameId: '' },
            { name: "cm", notes: "-", previousRank: 14, isParticipating: false, wins: 0, losses: 0, recentMatchResults: [0,0,0,0,0,0], careerHighRank: 14, tags: [], adminMemo: '', gameId: '' },
            { name: "ìš°íˆí", notes: "ë°©ì–´ì „ 1", previousRank: 15, isParticipating: true, wins: 1, losses: 0, recentMatchResults: [0,0,0,0,0,0], careerHighRank: 15, tags: [], adminMemo: '', gameId: '' },
            { name: "ë•¡í¬", notes: "-", previousRank: 16, isParticipating: false, wins: 0, losses: 0, recentMatchResults: [0,0,0,0,0,0], careerHighRank: 16, tags: [], adminMemo: '', gameId: '' },
            { name: "ë§ê³ ë§", notes: "ë°©ì–´ì „ 3", previousRank: 17, isParticipating: true, wins: 1, losses: 0, recentMatchResults: [0,0,0,0,0,0], careerHighRank: 17, tags: [], adminMemo: '', gameId: '' },
            { name: "ì´ë³µì„œ", notes: "ë°©ì–´ì „ 1", previousRank: 18, isParticipating: true, wins: 1, losses: 0, recentMatchResults: [0,0,0,0,0,0], careerHighRank: 18, tags: [], adminMemo: '', gameId: '' },
            { name: "ê³ ë§¥", notes: "ë°©ì–´ì „ 1", previousRank: 20, isParticipating: true, wins: 0, losses: 1, recentMatchResults: [0,0,0,0,0,0], careerHighRank: 20, tags: [], adminMemo: '', gameId: '' },
            { name: "í¬ë¡±", notes: "ë°©ì–´ì „ 3", previousRank: 19, isParticipating: true, wins: 1, losses: 1, recentMatchResults: [0,0,0,0,0,0], careerHighRank: 19, tags: [], adminMemo: '', gameId: '' },
            { name: "ì™¼ì†ì¨‰ë§¨", notes: "ë°©ì–´ì „ 3", previousRank: 21, isParticipating: true, wins: 0, losses: 0, recentMatchResults: [0,0,0,0,0,0], careerHighRank: 21, tags: [], adminMemo: '', gameId: '' },
            { name: "ë°", notes: "ë°©ì–´ì „ 1", previousRank: 22, isParticipating: true, wins: 0, losses: 0, recentMatchResults: [0,0,0,0,0,0], careerHighRank: 22, tags: [], adminMemo: '', gameId: '' },
            { name: "ë·ë·", notes: "-", previousRank: 27, isParticipating: true, wins: 1, losses: 1, recentMatchResults: [0,0,0,0,0,0], careerHighRank: 27, tags: [], adminMemo: '', gameId: '' },
            { name: "ë¬´ë¦°ì´", notes: "ë°©ì–´ì „ 3", previousRank: 23, isParticipating: true, wins: 1, losses: 1, recentMatchResults: [0,0,0,0,0,0], careerHighRank: 23, tags: [], adminMemo: '', gameId: '' },
            { name: "ì—´í˜ˆì¤‘ë³µí•™ìƒ", notes: "-", previousRank: 24, isParticipating: false, wins: 0, losses: 0, recentMatchResults: [0,0,0,0,0,0], careerHighRank: 24, tags: [], adminMemo: '', gameId: '' },
            { name: "ë¬¼ì£¼ë¨¹ì™•", notes: "-", previousRank: 25, isParticipating: false, wins: 0, losses: 0, recentMatchResults: [0,0,0,0,0,0], careerHighRank: 25, tags: [], adminMemo: '', gameId: '' },
            { name: "@@@", notes: "-", previousRank: 26, isParticipating: false, wins: 0, losses: 0, recentMatchResults: [0,0,0,0,0,0], careerHighRank: 26, tags: [], adminMemo: '', gameId: '' },
            { name: "ì´ˆë³´ë³µì„œ", notes: "-", previousRank: 28, isParticipating: true, wins: 0, losses: 0, recentMatchResults: [0,0,0,0,0,0], careerHighRank: 28, tags: [], adminMemo: '', gameId: '' },
            { name: "ìˆ˜ë©´ë³µì„œ", notes: "ë°©ì–´ì „ 1", previousRank: 29, isParticipating: true, wins: 0, losses: 0, recentMatchResults: [0,0,0,0,0,0], careerHighRank: 29, tags: [], adminMemo: '', gameId: '' },
            { name: "ì¡°ì§€í¬ë¨¼", notes: "ë°©ì–´ì „ 1", previousRank: 30, isParticipating: true, wins: 0, losses: 0, recentMatchResults: [0,0,0,0,0,0], careerHighRank: 30, tags: [], adminMemo: '', gameId: '' }
        ];
        
        function parseDefenseCount(notes) {
            if (!notes || notes === '-') return 0;
            const match = notes.match(/ë°©ì–´ì „\s*(\d+)/); 
            return (match && match[1]) ? parseInt(match[1], 10) : 0;
        }

        function getDisplayLength(str) { 
            let length = 0; 
            for (const char of String(str)) { 
                const charCode = char.codePointAt(0); 
                if (charCode === undefined) continue; 
                if ((charCode >= 0xFE00 && charCode <= 0xFE0F) || charCode === 0x200D) { continue; }
                if (charCode >= 0x4E00 && charCode <= 0x9FFF || charCode >= 0x3040 && charCode <= 0x30FF || charCode >= 0xAC00 && charCode <= 0xD7A3 || charCode >= 0x1F000) { length += 2; } 
                else if (charCode >= 0x0020 && charCode <= 0x007E) { length += 1; } else { length += 2; } 
            } return length; 
        }

        function padString(str, targetLength) { 
            const currentLength = getDisplayLength(str); 
            let paddingNeeded = targetLength - currentLength; 
            return paddingNeeded <= 0 ? str : str + ' '.repeat(paddingNeeded); 
        }

        function padStringLeft(str, targetLength) {
            const currentLength = getDisplayLength(str);
            let paddingNeeded = targetLength - currentLength;
            return paddingNeeded <= 0 ? str : ' '.repeat(paddingNeeded) + str;
        }

        function showSyncStatus(message, isError = false) { const statusEl = document.getElementById('syncStatus'); if (!statusEl) return; clearTimeout(syncTimeout); statusEl.textContent = message; statusEl.classList.remove('hidden', 'text-green-500', 'text-red-500', 'text-blue-600'); statusEl.classList.add(isError ? 'text-red-500' : 'text-green-500'); if (!isError) { syncTimeout = setTimeout(() => { statusEl.classList.add('hidden'); }, 1500); } }
        function updateLoadingState(message = null) { if (loadingElement) { if (message) { loadingElement.textContent = message; loadingElement.classList.remove('hidden'); } else { loadingElement.classList.add('hidden'); } } }
        function addToHistory() { const snapshot = { rankings: JSON.parse(JSON.stringify(rankingsData)), logs: JSON.parse(JSON.stringify(logsData)), matchHistory: JSON.parse(JSON.stringify(matchHistoryData)), seasonArchives: JSON.parse(JSON.stringify(seasonArchives)), date: currentRankingDate, activeSeason: activeSeason, seasonTitle: currentSeasonTitle, seasonBestMatch: currentSeasonBestMatch, tournamentData: JSON.parse(JSON.stringify(tournamentData)) }; historyStack.push(snapshot); if (historyStack.length > MAX_HISTORY) { historyStack.shift(); } updateUndoButtonState(); }
        async function performUndo() { if (historyStack.length === 0) { showSyncStatus('ë˜ëŒë¦´ ì‘ì—…ì´ ì—†ìŠµë‹ˆë‹¤.', true); return; } const previousState = historyStack.pop(); rankingsData = previousState.rankings; logsData = previousState.logs || []; matchHistoryData = previousState.matchHistory || []; seasonArchives = previousState.seasonArchives || {}; currentRankingDate = previousState.date; if(previousState.seasonTitle !== undefined) currentSeasonTitle = previousState.seasonTitle; if(previousState.seasonBestMatch !== undefined) currentSeasonBestMatch = previousState.seasonBestMatch; if(previousState.activeSeason !== undefined) activeSeason = previousState.activeSeason; if(previousState.tournamentData) tournamentData = previousState.tournamentData; const dateInput = document.getElementById('rankingDateInput'); if (dateInput) dateInput.value = currentRankingDate; updateSeasonSelector(); saveRankings(); updateUndoButtonState(); renderRankings(); renderLogs(); renderMatchHistory(); renderHallOfFame(); if (document.getElementById('tabHeadToHead').classList.contains('active')) { renderHeadToHeadAnalysis(); } if (document.getElementById('tabTournament').classList.contains('active')) { renderTournament(); } showSyncStatus('ì‘ì—…ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.'); }
        function updateUndoButtonState() { const undoBtn = document.getElementById('undoButton'); if (undoBtn) { if (historyStack.length > 0) { undoBtn.classList.remove('opacity-50', 'cursor-not-allowed'); undoBtn.disabled = false; } else { undoBtn.classList.add('opacity-50', 'cursor-not-allowed'); undoBtn.disabled = true; } } }
        function addLogEntry(message) { const now = new Date(); const timeString = now.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit', second: '2-digit' }); logsData.unshift({ id: crypto.randomUUID(), time: timeString, message: message }); if (logsData.length > MAX_LOGS) { logsData.pop(); } renderLogs(); }
        function deleteLog(logId) { logsData = logsData.filter(log => log.id !== logId); saveRankings(); renderLogs(); }
        function renderLogs() { const logContainer = document.getElementById('logContainer'); if (!logContainer) return; logContainer.innerHTML = ''; if (logsData.length === 0) { logContainer.innerHTML = '<div class="text-gray-400 text-center italic p-2">ê¸°ë¡ëœ í™œë™ì´ ì—†ìŠµë‹ˆë‹¤.</div>'; return; } logsData.forEach(log => { const div = document.createElement('div'); div.className = 'log-entry group'; div.innerHTML = ` <div class="flex-grow pr-2"> <span class="log-time">[${log.time}]</span> <span class="text-gray-700">${log.message}</span> </div> <button class="delete-log-btn text-gray-400 hover:text-red-500 p-1 rounded flex-shrink-0" data-id="${log.id}" title="ë¡œê·¸ ì‚­ì œ"> <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg> </button> `; logContainer.appendChild(div); }); document.querySelectorAll('.delete-log-btn').forEach(btn => { btn.addEventListener('click', (e) => { const id = e.currentTarget.dataset.id; deleteLog(id); }); }); }

        async function setupFirebase() {
            loadingElement = document.getElementById('loading');
            if (!firebaseConfig) { updateLoadingState('âš ï¸ ë¡œì»¬ ëª¨ë“œ (ìë™ ì €ì¥ ë¨)'); seedInitialData(true); return; }
            try { const app = initializeApp(firebaseConfig); db = getFirestore(app); auth = getAuth(app); if (initialAuthToken) { await signInWithCustomToken(auth, initialAuthToken); } else { await signInAnonymously(auth); } updateLoadingState(); loadRankings(); } catch (error) { updateLoadingState('âš ï¸ ë¡œì»¬ ëª¨ë“œ (ìë™ ì €ì¥ ë¨)'); seedInitialData(true); }
        }

        const getRankingRef = () => { return doc(db, 'artifacts', appId, 'public', 'data', 'rankings', 'main'); };

        function loadRankings() {
            if (!db) return;
            onSnapshot(getRankingRef(), async (docSnapshot) => {
                if (docSnapshot.exists()) {
                    const data = docSnapshot.data();
                    if (data.date) { currentRankingDate = data.date; const dateInput = document.getElementById('rankingDateInput'); if (dateInput) dateInput.value = currentRankingDate; }
                    if (data.activeSeason) activeSeason = data.activeSeason;
                    if (data.seasonArchives) seasonArchives = data.seasonArchives;
                    if (data.seasonBestMatch) currentSeasonBestMatch = data.seasonBestMatch;
                    if (data.seasonTitle) currentSeasonTitle = data.seasonTitle;
                    if (data.tournamentData) tournamentData = data.tournamentData;
                    if (activeSeason && viewSeason === "ì‹œì¦Œ 1") viewSeason = activeSeason; 
                    if (data.logs && Array.isArray(data.logs)) { logsData = data.logs; }
                    if (data.matchHistory && Array.isArray(data.matchHistory)) { matchHistoryData = data.matchHistory; }
                    if (data && Array.isArray(data.rankings) && data.rankings.length > 0) {
                        rankingsData = data.rankings.map((item, index) => ({ 
                            ...item, 
                            isParticipating: item.isParticipating === undefined ? true : item.isParticipating, 
                            defenseCount: item.defenseCount !== undefined ? item.defenseCount : parseDefenseCount(item.notes), 
                            wins: item.wins || 0, 
                            losses: item.losses || 0,
                            recentMatchResults: item.recentMatchResults || [0,0,0,0,0,0],
                            entryTime: item.entryTime,
                            imageUrl: item.imageUrl || '',
                            careerHighRank: item.careerHighRank || (index + 1),
                            tags: item.tags || [],
                            adminMemo: item.adminMemo || '',
                            gameId: item.gameId || ''
                        }));
                        let baselineTemp = rankingsData.map(item => ({...item})); baselineTemp.sort((a, b) => a.previousRank - b.previousRank); previousRankingsData = baselineTemp;
                    } else { await seedInitialData(false); }
                } else { await seedInitialData(false); }
                updateSeasonSelector();
                renderRankings(); renderLogs(); renderMatchHistory(); renderHallOfFame(); populateH2HSelectors(); renderTournament();
            }, (error) => { updateLoadingState('âš ï¸ ë°ì´í„° ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ.'); });
        }

        async function seedInitialData(isLocalMode) { 
            if (isLocalMode) { 
                try { 
                    const localDataRaw = localStorage.getItem(LOCAL_STORAGE_KEY); 
                    if (localDataRaw) { 
                        const localData = JSON.parse(localDataRaw); 
                        if (localData.rankings && Array.isArray(localData.rankings)) { 
                            rankingsData = localData.rankings.map((item, index) => ({ 
                                ...item, 
                                isParticipating: item.isParticipating === undefined ? true : item.isParticipating, 
                                defenseCount: item.defenseCount || parseDefenseCount(item.notes), 
                                wins: item.wins || 0, 
                                losses: item.losses || 0, 
                                recentMatchResults: item.recentMatchResults || [0,0,0,0,0,0],
                                entryTime: item.entryTime,
                                imageUrl: item.imageUrl || '',
                                careerHighRank: item.careerHighRank || (index + 1),
                                tags: item.tags || [],
                                adminMemo: item.adminMemo || '',
                                gameId: item.gameId || ''
                            })); 
                            if (localData.date) { currentRankingDate = localData.date; const dateInput = document.getElementById('rankingDateInput'); if (dateInput) dateInput.value = currentRankingDate; } 
                            if (localData.logs) logsData = localData.logs; 
                            if (localData.matchHistory) matchHistoryData = localData.matchHistory; 
                            if (localData.activeSeason) activeSeason = localData.activeSeason;
                            if (localData.seasonArchives) seasonArchives = localData.seasonArchives;
                            if (localData.seasonBestMatch) currentSeasonBestMatch = localData.seasonBestMatch;
                            if (localData.seasonTitle) currentSeasonTitle = localData.seasonTitle; 
                            if (localData.tournamentData) tournamentData = localData.tournamentData;
                            viewSeason = activeSeason;
                            let baselineTemp = rankingsData.map(item => ({...item})); 
                            baselineTemp.sort((a, b) => a.previousRank - b.previousRank); 
                            previousRankingsData = baselineTemp; 
                            showSyncStatus('ë¡œì»¬ ë°ì´í„° ë¶ˆëŸ¬ì˜´', false); 
                            updateSeasonSelector();
                            renderRankings(); renderLogs(); renderMatchHistory(); renderHallOfFame(); populateH2HSelectors(); renderTournament();
                            return; 
                        } 
                    } 
                } catch (e) { console.error("Local storage parsing error", e); } 
            } 
            
            let seedDataToUse = structuredSeedData; 
            const rankingsToSave = seedDataToUse.map((item, index) => ({ id: crypto.randomUUID(), name: item.name, notes: item.notes, previousRank: item.previousRank !== undefined ? item.previousRank : (index + 1), isParticipating: item.isParticipating, defenseCount: parseDefenseCount(item.notes), wins: item.wins || 0, losses: item.losses || 0, recentMatchResults: item.recentMatchResults || [0,0,0,0,0,0], imageUrl: '', careerHighRank: index + 1, tags: [], adminMemo: '', gameId: '' })); 
            rankingsData = rankingsToSave; 
            previousRankingsData = JSON.parse(JSON.stringify(rankingsToSave)); 
            previousRankingsData.sort((a, b) => a.previousRank - b.previousRank); 
            logsData = []; 
            matchHistoryData = []; 
            activeSeason = "ì‹œì¦Œ 1"; seasonArchives = {}; currentSeasonBestMatch = ""; viewSeason = "ì‹œì¦Œ 1"; currentSeasonTitle = "ì‹œì¦Œ 1"; tournamentData = { active: false, size: 0, rounds: [] };
            updateSeasonSelector();
            renderRankings(); renderLogs(); renderMatchHistory(); renderHallOfFame(); populateH2HSelectors(); renderTournament();
            if (isLocalMode) return; 
            if (db) { try { await setDoc(getRankingRef(), { rankings: rankingsToSave, logs: [], matchHistory: [], activeSeason: "ì‹œì¦Œ 1", seasonArchives: {}, seasonBestMatch: "", seasonTitle: "ì‹œì¦Œ 1", tournamentData: tournamentData }); } catch (e) { console.error("Error saving initial document: ", e); } } 
        }
        
        async function saveRankings() { 
            const rankingsToSave = rankingsData.map((item, index) => {
                const currentRank = index + 1;
                const newHigh = (!item.careerHighRank || currentRank < item.careerHighRank) ? currentRank : item.careerHighRank;
                item.careerHighRank = newHigh;

                return { 
                    id: item.id, 
                    name: item.name, 
                    notes: item.notes || '-', 
                    previousRank: item.previousRank, 
                    isParticipating: item.isParticipating === undefined ? true : item.isParticipating, 
                    defenseCount: item.defenseCount || 0, 
                    wins: item.wins || 0, 
                    losses: item.losses || 0, 
                    recentMatchResults: item.recentMatchResults || [0,0,0,0,0,0],
                    entryTime: item.entryTime || null,
                    imageUrl: item.imageUrl || '',
                    careerHighRank: newHigh,
                    tags: item.tags || [],
                    adminMemo: item.adminMemo || '',
                    gameId: item.gameId || ''
                };
            }); 
            const dataToSave = { rankings: rankingsToSave, date: currentRankingDate, logs: logsData, matchHistory: matchHistoryData, activeSeason: activeSeason, seasonArchives: seasonArchives, seasonBestMatch: currentSeasonBestMatch, seasonTitle: currentSeasonTitle, tournamentData: tournamentData }; 
            try { localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(dataToSave)); } catch (e) { console.error("Local save failed", e); } 
            if (!db) { showSyncStatus('ìë™ ì €ì¥ë¨ (ë¡œì»¬)'); renderRankings(); renderLogs(); renderMatchHistory(); renderHallOfFame(); renderTournament(); return; } 
            try { await setDoc(getRankingRef(), dataToSave); showSyncStatus('ì‹¤ì‹œê°„ ë™ê¸°í™” ì™„ë£Œ'); } catch (e) { showSyncStatus('ì €ì¥ ì˜¤ë¥˜!', true); console.error(e); } 
        }

        // --- Drag & Drop Functions Restored ---
        function handleDragStart(e) { dragSrcEl = e.currentTarget; e.dataTransfer.effectAllowed = 'move'; e.dataTransfer.setData('text/html', dragSrcEl.innerHTML); dragStartIndex = rankingsData.findIndex(item => item.id === dragSrcEl.dataset.id); oldIndexMap.clear(); rankingsData.forEach((item, index) => { oldIndexMap.set(item.id, index + 1); }); setTimeout(() => { if (e.currentTarget) e.currentTarget.classList.add('dragging'); }, 0); updateDragStatusBadge(dragStartIndex, dragStartIndex); }
        function handleDragOver(e) { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; const targetEl = e.currentTarget.closest('.rank-item'); if (targetEl && dragStartIndex !== -1) { const targetId = targetEl.dataset.id; const targetIndex = rankingsData.findIndex(item => item.id === targetId); if (targetIndex !== -1) updateDragStatusBadge(dragStartIndex, targetIndex); } return false; }
        function updateDragStatusBadge(startIndex, targetIndex) { const badge = document.getElementById('dragStatusBadge'); if (!badge) return; const diff = startIndex - targetIndex; let text = ""; if (diff > 0) { text = `â–² ${diff} (ìˆœìœ„ ìƒìŠ¹)`; badge.style.backgroundColor = "rgba(22, 163, 74, 0.9)"; } else if (diff < 0) { text = `â–¼ ${Math.abs(diff)} (ìˆœìœ„ í•˜ë½)`; badge.style.backgroundColor = "rgba(220, 38, 38, 0.9)"; } else { text = "ë³€ë™ ì—†ìŒ"; badge.style.backgroundColor = "rgba(75, 85, 99, 0.9)"; } badge.textContent = text; badge.classList.add('visible'); }
        function handleDragEnter(e) { if (e.currentTarget) e.currentTarget.classList.add('border-blue-500', 'border-2'); }
        function handleDragLeave(e) { if (e.currentTarget) e.currentTarget.classList.remove('border-blue-500', 'border-2'); }
        function handleDrop(e) { e.stopPropagation(); const badge = document.getElementById('dragStatusBadge'); if (badge) badge.classList.remove('visible'); if (e.currentTarget) e.currentTarget.classList.remove('border-blue-500', 'border-2'); if (dragSrcEl && e.currentTarget && dragSrcEl !== e.currentTarget) { addToHistory(); const sourceId = dragSrcEl.dataset.id; const targetId = e.currentTarget.dataset.id; const sourceIndex = rankingsData.findIndex(item => item.id === sourceId); const targetIndex = rankingsData.findIndex(item => item.id === targetId); const item = rankingsData[sourceIndex]; const [draggedItem] = rankingsData.splice(sourceIndex, 1); rankingsData.splice(targetIndex, 0, draggedItem); const sourceRankDisp = `${sourceIndex + 1}ìœ„`; const targetRankDisp = `${targetIndex + 1}ìœ„`; addLogEntry(`ğŸ¤ ë“œë˜ê·¸ ì´ë™: ${item.name} (${sourceRankDisp} â†’ ${targetRankDisp})`); rankingsData.forEach((item, newIndex) => { const oldRank = oldIndexMap.get(item.id); const newRank = newIndex + 1; const oldIsSpecial = oldRank <= 3; const newIsSpecial = newRank <= 3; if (oldRank !== undefined && oldIsSpecial !== newIsSpecial) { if (item.notes !== '-' || item.defenseCount !== 0) { item.notes = '-'; item.defenseCount = 0; } } }); renderRankings(); saveRankings(); } return false; }
        function handleDragEnd(e) { if (e.currentTarget) e.currentTarget.classList.remove('dragging'); document.querySelectorAll('.rank-item').forEach(item => { if (item) item.classList.remove('border-blue-500', 'border-2') }); oldIndexMap.clear(); const badge = document.getElementById('dragStatusBadge'); if (badge) badge.classList.remove('visible'); dragStartIndex = -1; }
        
        function updateSeasonSelector() {
            const selector = document.getElementById('seasonSelector');
            if (!selector) return;
            selector.innerHTML = '';
            Object.keys(seasonArchives).sort().forEach(season => { const opt = document.createElement('option'); opt.value = season; opt.textContent = season + " (ì¢…ë£Œ)"; selector.appendChild(opt); });
            const activeOpt = document.createElement('option'); activeOpt.value = activeSeason; activeOpt.textContent = activeSeason + " (ì§„í–‰ì¤‘)"; selector.appendChild(activeOpt);
            selector.value = viewSeason;
        }
        function handleSeasonChange(e) { viewSeason = e.target.value; renderMatchHistory(); populateH2HSelectors(); renderHallOfFame(); }
        
        function startNewSeason() {
            const nonPartCount = rankingsData.filter(item => !item.isParticipating).length;
            let confirmMsg = `í˜„ì¬ [${activeSeason}]ì„ ì¢…ë£Œí•˜ê³  ìƒˆë¡œìš´ ì‹œì¦Œì„ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?<br><div class="mt-2 text-sm font-normal text-gray-500">í˜„ì¬ ë­í‚¹ê³¼ ê¸°ë¡ì´ ì•„ì¹´ì´ë¸Œì— ì €ì¥ë˜ë©°,<br>ìŠ¹íŒ¨ì™€ ë°©ì–´ì „ íšŸìˆ˜ëŠ” ì´ˆê¸°í™”ë©ë‹ˆë‹¤.</div>`;
            if (nonPartCount > 0) {
                confirmMsg += `
                <div class="mt-4 text-left bg-red-50 p-3 rounded border border-red-200">
                    <label class="flex items-center cursor-pointer select-none">
                        <input type="checkbox" id="seasonRemoveNonPart" class="w-5 h-5 text-red-600 rounded focus:ring-red-500 border-gray-300 mr-3" checked>
                        <div class="flex flex-col">
                            <span class="text-sm font-bold text-red-700">ë¯¸ì°¸ì—¬ ì¸ì› ${nonPartCount}ëª… ì‚­ì œ ë° ê³µì„ ì±„ì›€</span>
                            <span class="text-xs text-red-500 mt-0.5">ì‚­ì œëœ ìë¦¬ë§Œí¼ í•˜ìœ„ ë­í‚¹(30ìœ„~)ì— 'ê³µì„'ì´ ìƒì„±ë©ë‹ˆë‹¤.</span>
                        </div>
                    </label>
                </div>`;
            }
            showConfirmModal(confirmMsg, async () => {
                addToHistory();
                const removeCheckbox = document.getElementById('seasonRemoveNonPart');
                const shouldRemove = removeCheckbox ? removeCheckbox.checked : false;
                const champion = rankingsData[0]; const rank2 = rankingsData[1]; const rank3 = rankingsData[2];
                let defenseKingName = "-"; let maxDef = 0;
                const allCounts = rankingsData.map(i => i.defenseCount || 0);
                if (allCounts.length > 0) { maxDef = Math.max(...allCounts); if (maxDef > 0) { defenseKingName = rankingsData.filter(i => (i.defenseCount||0) === maxDef).map(i => i.name).join(', '); } }
                seasonArchives[activeSeason] = { champion: champion ? champion.name : "-", rank2: rank2 ? rank2.name : "-", rank3: rank3 ? rank3.name : "-", defenseKing: defenseKingName, defenseCount: maxDef, bestMatch: currentSeasonBestMatch, endDate: currentRankingDate || new Date().toISOString().split('T')[0] };
                const seasonNum = parseInt(activeSeason.replace(/[^0-9]/g, '')) || 1;
                activeSeason = `ì‹œì¦Œ ${seasonNum + 1}`; viewSeason = activeSeason; currentSeasonTitle = activeSeason; 
                if (shouldRemove) {
                    rankingsData = rankingsData.filter(item => item.isParticipating);
                    addLogEntry(`ğŸ—‘ï¸ ì‹œì¦Œ ì „í™˜: ë¯¸ì°¸ì—¬ ì¸ì› ì‚­ì œë¨`);
                    let vacantCount = 0;
                    while (rankingsData.length < 30) {
                        rankingsData.push({
                            id: crypto.randomUUID(),
                            name: "ê³µì„",
                            notes: "-",
                            previousRank: rankingsData.length + 1,
                            isParticipating: false,
                            defenseCount: 0,
                            wins: 0,
                            losses: 0,
                            recentMatchResults: [0,0,0,0,0,0],
                            entryTime: Date.now(),
                            imageUrl: ''
                        });
                        vacantCount++;
                    }
                    if (vacantCount > 0) { addLogEntry(`â• ì¸ì› ìœ ì§€ë¥¼ ìœ„í•´ 'ê³µì„' ${vacantCount}ê°œ ìƒì„±ë¨`); }
                }
                rankingsData.forEach((item, index) => { 
                    item.wins = 0; item.losses = 0; item.defenseCount = 0; item.notes = '-'; item.recentMatchResults = [0,0,0,0,0,0]; item.previousRank = index + 1; 
                });
                previousRankingsData = JSON.parse(JSON.stringify(rankingsData));
                currentSeasonBestMatch = ""; tournamentData = { active: false, size: 0, rounds: [] };
                addLogEntry(`ğŸ‰ ${activeSeason} ê°œë§‰! (ì´ ${rankingsData.length}ëª…)`); 
                updateSeasonSelector(); saveRankings(); renderRankings(); renderMatchHistory(); renderHallOfFame(); renderTournament();
            });
        }

        function handleSeasonTitleChange(e) { addToHistory(); currentSeasonTitle = e.target.value; saveRankings(); }
        function switchTab(tab) {
            const sections = ['rankingSection', 'hallOfFameSection', 'matchHistorySection', 'headToHeadSection', 'tournamentSection'];
            const tabs = ['tabRanking', 'tabHallOfFame', 'tabMatchHistory', 'tabHeadToHead', 'tabTournament'];
            const setActive = (el) => { if(el) el.className = "tab-btn active flex-1 py-3 px-1 sm:px-2 text-xs sm:text-sm text-center font-bold text-blue-600 border-b-2 border-blue-500 flex justify-center items-center gap-1 transition-colors duration-200"; };
            const setInactive = (el) => { if(el) el.className = "tab-btn flex-1 py-3 px-1 sm:px-2 text-xs sm:text-sm text-center font-medium text-gray-400 hover:text-gray-600 hover:border-gray-200 border-b-2 border-transparent flex justify-center items-center gap-1 transition-colors duration-200"; };
            sections.forEach(id => document.getElementById(id)?.classList.add('hidden'));
            tabs.forEach(id => setInactive(document.getElementById(id)));
            if (tab === 'ranking') { document.getElementById('rankingSection').classList.remove('hidden'); setActive(document.getElementById('tabRanking')); } 
            else if (tab === 'hallOfFame') { document.getElementById('hallOfFameSection').classList.remove('hidden'); setActive(document.getElementById('tabHallOfFame')); renderHallOfFame(); } 
            else if (tab === 'matchHistory') { document.getElementById('matchHistorySection').classList.remove('hidden'); setActive(document.getElementById('tabMatchHistory')); renderMatchHistory(); } 
            else if (tab === 'headToHead') { document.getElementById('headToHeadSection').classList.remove('hidden'); setActive(document.getElementById('tabHeadToHead')); populateH2HSelectors(); } 
            else if (tab === 'tournament') { document.getElementById('tournamentSection').classList.remove('hidden'); setActive(document.getElementById('tabTournament')); renderTournament(); }
        }
        function handleBestMatchChange(e) { addToHistory(); currentSeasonBestMatch = e.target.value; saveRankings(); }
        
        function renderMatchHistory() { 
            const container = document.getElementById('matchHistoryList'); if (!container) return; container.innerHTML = ''; 
            let filteredData = (matchHistoryData || []).filter(m => { const s = m.season || "ì‹œì¦Œ 1"; return s === viewSeason; });
            if (filteredData.length === 0) { container.innerHTML = `<div class="text-center text-gray-400 py-10 italic">${viewSeason} ê²½ê¸° ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>`; return; } 
            const groups = [];
            filteredData.forEach(match => {
                const date = match.date || 'ë‚ ì§œ ì—†ìŒ';
                if (groups.length === 0 || groups[groups.length - 1].date !== date) { groups.push({ date: date, matches: [] }); }
                groups[groups.length - 1].matches.push(match);
            });
            groups.forEach(group => {
                const groupWrapper = document.createElement('div');
                groupWrapper.className = "bg-white rounded-xl shadow-sm border border-gray-200 p-3 mb-4 last:mb-0";
                groupWrapper.innerHTML = ` <div class="flex justify-between items-center border-b border-gray-100 pb-2 mb-2"> <div class="font-bold text-gray-700 flex items-center text-sm"> <span class="mr-1 text-lg">ğŸ“…</span> ${group.date} </div> <div class="text-[10px] text-gray-400 font-medium bg-gray-50 px-2 py-1 rounded border border-gray-100"> ì´ ${group.matches.length}ê²½ê¸° </div> </div> <div class="match-list-inner flex flex-col gap-2"></div> `;
                const listInner = groupWrapper.querySelector('.match-list-inner');
                group.matches.forEach(match => {
                    const card = document.createElement('div'); 
                    let typeClass = 'border-gray-300'; let resultBadge = ''; let displayDetail = match.detail || '';
                    if (displayDetail === 'ìë¦¬ ëºê¸° (Rank Swap)' && match.loserRank && match.winner) { displayDetail = `<span class="font-bold text-gray-700">${match.winner}</span> ${match.loserRank}ìœ„ íƒˆí™˜`; } 
                    else if (displayDetail === 'ë„ì „ì 1ë‹¨ê³„ í•˜ë½' && match.loserRank && match.loser) { const droppedRank = parseInt(match.loserRank) + 1; displayDetail = `<span class="font-bold text-gray-700">${match.loser}</span> ${droppedRank}ìœ„ í•˜ë½`; } 
                    else if (displayDetail === 'ì™¸ë¶€ ë„ì „ì ì§„ì… (New Entry)' && match.winnerRank && match.winner) { displayDetail = `<span class="font-bold text-gray-700">${match.winner}</span> ${match.winnerRank}ìœ„ ì§„ì…`; }
                    if (match.type === 'friendly') { typeClass = 'border-l-4 border-green-500 bg-green-50'; resultBadge = `<span class="bg-green-100 text-green-700 text-xs font-bold px-2 py-0.5 rounded">ğŸ¤ ì¹œì„  ë§¤ì¹˜</span>`; }
                    else if (match.type === 'defense') { typeClass = 'defense-success'; resultBadge = `<span class="bg-blue-100 text-blue-800 text-xs font-bold px-2 py-0.5 rounded">ğŸ›¡ï¸ ë°©ì–´ ì„±ê³µ</span>`; } 
                    else if (match.type === 'challenge_success') { typeClass = 'challenge-success'; resultBadge = `<span class="bg-red-100 text-red-800 text-xs font-bold px-2 py-0.5 rounded">ğŸš€ ë„ì „ ì„±ê³µ</span>`; } 
                    else if (match.type === 'challenge_fail') { resultBadge = `<span class="bg-gray-100 text-gray-800 text-xs font-bold px-2 py-0.5 rounded">ğŸ’€ ë„ì „ ì‹¤íŒ¨</span>`; } 
                    let leftContent = ''; let rightContent = '';
                    if (match.blue && match.red) {
                        const isBlueWin = match.winner === match.blue;
                        const blueBg = isBlueWin ? "bg-blue-600 shadow-sm border border-blue-700" : "bg-blue-50 border border-blue-200"; const blueText = isBlueWin ? "text-white" : "text-blue-600"; const blueNameWeight = isBlueWin ? "font-extrabold" : "font-medium"; const blueRankColor = isBlueWin ? "text-blue-200" : "text-blue-400";
                        const blueRankDisplay = match.blueRank === 'UR' ? 'UR' : `${match.blueRank}ìœ„`; const blueRankText = match.blueRank ? `<span class="text-base font-normal ml-1 ${blueRankColor}">(${blueRankDisplay})</span>` : '';
                        leftContent = ` <div class="flex justify-end w-[42%]"> <div class="${blueBg} ${blueText} px-2 py-1 rounded flex items-baseline justify-end truncate" style="max-width: 100%;"> <span class="${blueNameWeight} text-base truncate">${match.blue}</span>${blueRankText} </div> </div>`;
                        const redBg = !isBlueWin ? "bg-red-600 shadow-sm border border-red-700" : "bg-red-50 border border-red-200"; const redText = !isBlueWin ? "text-white" : "text-red-600"; const redNameWeight = !isBlueWin ? "font-extrabold" : "font-medium"; const redRankColor = !isBlueWin ? "text-red-200" : "text-red-400";
                        const redRankDisplay = match.redRank === 'UR' ? 'UR' : `${match.redRank}ìœ„`; const redRankText = match.redRank ? `<span class="text-base font-normal ml-1 ${redRankColor}">(${redRankDisplay})</span>` : '';
                        rightContent = ` <div class="flex justify-start w-[42%]"> <div class="${redBg} ${redText} px-2 py-1 rounded flex items-baseline justify-start truncate" style="max-width: 100%;"> <span class="${redNameWeight} text-base truncate">${match.red}</span>${redRankText} </div> </div>`;
                    } else {
                        const wRankDisplay = match.winnerRank === 'UR' ? 'UR' : `${match.winnerRank}ìœ„`; let wRankText = match.winnerRank ? `(${wRankDisplay})` : '';
                        const lRankDisplay = match.loserRank === 'UR' ? 'UR' : `${match.loserRank}ìœ„`; let lRankText = match.loserRank ? `(${lRankDisplay})` : '';
                        if (match.detail && (match.detail.includes('ì™¸ë¶€') || match.detail.includes('New Entry'))) { if (match.type === 'challenge_success') wRankText = '(UR)'; else if (match.type === 'defense') lRankText = '(UR)'; }
                        leftContent = `<div class="text-right w-[40%] font-bold text-gray-800 truncate">${match.winner} <span class="text-[11px] text-gray-400 font-normal">${wRankText}</span></div>`; rightContent = `<div class="text-left w-[40%] text-gray-600 truncate"><span class="text-[11px] text-gray-400 font-normal">${lRankText}</span> ${match.loser}</div>`;
                    }
                    card.className = `match-card ${typeClass} !mb-0`; 
                    card.innerHTML = ` <div class="flex flex-col w-12 flex-shrink-0 text-center border-r border-gray-100 mr-2 pr-2 justify-center"> <span class="text-xs text-gray-500 font-bold">${match.time || ''}</span> </div> <div class="flex-grow flex items-center justify-center"> ${leftContent} <div class="match-vs text-[10px] text-gray-300 mx-1">VS</div> ${rightContent} </div> <div class="w-32 flex-shrink-0 text-right"> ${resultBadge} <div class="text-[10px] text-gray-500 mt-1 whitespace-nowrap overflow-hidden text-ellipsis" title="${displayDetail.replace(/<[^>]*>?/gm, '')}">${displayDetail}</div> </div> `; 
                    listInner.appendChild(card); 
                });
                container.appendChild(groupWrapper);
            });
        }
        
        function generateVsListText(count) {
            const currentData = (matchHistoryData || []).filter(m => { const s = m.season || "ì‹œì¦Œ 1"; return s === viewSeason; });
            if (currentData.length === 0) { return "ê¸°ë¡ëœ ê²½ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤."; }
            const limit = count === 0 ? currentData.length : count;
            const targetData = currentData.slice(0, limit);
            let resultText = ""; let lastDate = "";
            targetData.forEach((m, index) => {
                if (m.date && m.date !== lastDate) { if (index > 0) resultText += "\n"; resultText += `ğŸ“… ${m.date}\n`; lastDate = m.date; }
                let line = ""; const isFriendly = m.type === 'friendly'; 
                if (m.blue && m.red) {
                    let bRank = ''; let rRank = '';
                    if (!isFriendly) { const bRankDisplay = m.blueRank === 'UR' ? 'UR' : `${m.blueRank}ìœ„`; bRank = m.blueRank ? `(${bRankDisplay})` : ''; const rRankDisplay = m.redRank === 'UR' ? 'UR' : `${m.redRank}ìœ„`; rRank = m.redRank ? `(${rRankDisplay})` : ''; }
                    line = `${m.blue}${bRank} VS ${m.red}${rRank}`;
                } else {
                    let wRank = ''; let lRank = '';
                    if (!isFriendly) { const wRankDisplay = m.winnerRank === 'UR' ? 'UR' : `${m.winnerRank}ìœ„`; wRank = m.winnerRank ? `(${wRankDisplay})` : ''; const lRankDisplay = m.loserRank === 'UR' ? 'UR' : `${m.loserRank}ìœ„`; lRank = m.loserRank ? `(${lRankDisplay})` : ''; if (m.detail && (m.detail.includes('ì™¸ë¶€') || m.detail.includes('New Entry'))) { if (m.type === 'challenge_success') wRank = '(UR)'; else if (m.type === 'defense') lRank = '(UR)'; } }
                    line = `${m.winner}${wRank} VS ${m.loser}${lRank}`;
                }
                resultText += line + "\n";
            });
            return resultText.trim();
        }
        function showVsExportModal() {
            const modal = document.getElementById('vsExportModal'); const content = document.getElementById('vsExportContent'); const select = document.getElementById('vsExportCountSelect'); const copyBtn = document.getElementById('vsCopyButton'); if (!modal) return; select.value = "15";
            const updateContent = () => { const count = parseInt(select.value, 10); content.value = generateVsListText(count); }; select.onchange = updateContent; updateContent(); 
            copyBtn.onclick = () => { content.select(); document.execCommand('copy'); copyBtn.textContent = 'ë³µì‚¬ ì™„ë£Œ!'; setTimeout(() => { copyBtn.textContent = 'ë‚´ìš© ë³µì‚¬'; }, 2000); }; modal.classList.remove('hidden');
        }
        function hideVsExportModal() { document.getElementById('vsExportModal')?.classList.add('hidden'); }

        function populateH2HSelectors() { 
            const selA = document.getElementById('h2hPlayerA'); if (!selA) return; const currentA = selA.value; selA.innerHTML = '<option value="">ì„ ìˆ˜ A ì„ íƒ</option>'; 
            let maxPrefixLen = 0; const prefixes = rankingsData.map((item, index) => `${index + 1}ìœ„ ${item.name}`);
            prefixes.forEach(p => { const len = getDisplayLength(p); if (len > maxPrefixLen) maxPrefixLen = len; });
            rankingsData.forEach((item, index) => { 
                const prefix = prefixes[index]; const wins = item.wins || 0; const losses = item.losses || 0; const currentLen = getDisplayLength(prefix); const paddingCount = (maxPrefixLen - currentLen) + 4; const padding = '\u00A0'.repeat(paddingCount); const totalRec = `( ${wins}ìŠ¹ ${losses}íŒ¨ )`; const optionText = `${prefix}${padding}${totalRec}`; 
                const optA = document.createElement('option'); optA.value = item.name; optA.textContent = optionText; 
                if (wins > 0 || losses > 0) { if (wins > losses) { optA.style.color = '#dc2626'; optA.style.fontWeight = 'bold'; } else if (losses > wins) { optA.style.color = '#2563eb'; optA.style.fontWeight = 'bold'; } }
                selA.appendChild(optA); 
            }); 
            if (currentA) selA.value = currentA; updateOpponentSelector(); 
        }

        function updateOpponentSelector() { 
            const selA = document.getElementById('h2hPlayerA'); const selB = document.getElementById('h2hPlayerB'); if (!selA || !selB) return; 
            const selectedPlayerA = selA.value; const currentB = selB.value; selB.innerHTML = '<option value="">ì„ ìˆ˜ B ì„ íƒ</option>'; 
            let maxPrefixLen = 0; const candidates = rankingsData.filter(item => !selectedPlayerA || item.name !== selectedPlayerA); const prefixes = candidates.map((item) => { const index = rankingsData.findIndex(r => r.id === item.id); return `${index + 1}ìœ„ ${item.name}`; });
            prefixes.forEach(p => { const len = getDisplayLength(p); if (len > maxPrefixLen) maxPrefixLen = len; });
            const h2hMap = new Map();
            if (selectedPlayerA && matchHistoryData) { 
                matchHistoryData.forEach(m => { 
                    const s = m.season || "ì‹œì¦Œ 1"; 
                    if (s !== viewSeason) return; 
                    if (m.type === 'friendly') return; 
                    if (m.winner === selectedPlayerA) { const rec = h2hMap.get(m.loser) || { w: 0, l: 0 }; rec.w++; h2hMap.set(m.loser, rec); } 
                    else if (m.loser === selectedPlayerA) { const rec = h2hMap.get(m.winner) || { w: 0, l: 0 }; rec.l++; h2hMap.set(m.winner, rec); } 
                }); 
            }
            candidates.forEach((item, i) => { 
                const prefix = prefixes[i]; const currentLen = getDisplayLength(prefix); const paddingCount = (maxPrefixLen - currentLen) + 4; const padding = '\u00A0'.repeat(paddingCount); let optionText = `${prefix}${padding}`; 
                const optB = document.createElement('option'); optB.value = item.name; 
                if (selectedPlayerA) { 
                    const rec = h2hMap.get(item.name); 
                    if (rec) { 
                        if (rec.w > rec.l) { optionText += `[VS ${rec.w}ìŠ¹ ${rec.l}íŒ¨] ğŸ”¥`; optB.style.color = '#dc2626'; optB.style.fontWeight = 'bold'; optB.style.backgroundColor = '#fef2f2'; } 
                        else if (rec.l > rec.w) { optionText += `[VS ${rec.w}ìŠ¹ ${rec.l}íŒ¨] â„ï¸`; optB.style.color = '#2563eb'; optB.style.fontWeight = 'bold'; optB.style.backgroundColor = '#eff6ff'; } 
                        else { optionText += `[VS ${rec.w}ìŠ¹ ${rec.l}íŒ¨] ğŸ¤`; optB.style.color = '#4b5563'; optB.style.fontWeight = 'bold'; optB.style.backgroundColor = '#f3f4f6'; }
                    } else { optB.style.color = '#6b7280'; } 
                }
                optB.textContent = optionText; selB.appendChild(optB); 
            }); 
            if (currentB) { let exists = false; for (let i = 0; i < selB.options.length; i++) { if (selB.options[i].value === currentB) { exists = true; break; } } if (exists) selB.value = currentB; else selB.value = ""; } renderHeadToHeadAnalysis(); 
        }

        function renderHeadToHeadAnalysis() { 
            const pA = document.getElementById('h2hPlayerA').value; const pB = document.getElementById('h2hPlayerB').value; const container = document.getElementById('h2hResult'); 
            if (!pA) { container.innerHTML = '<div class="text-gray-400 italic py-10">ì„ ìˆ˜ Aë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.</div>'; return; } 
            if (!pB) { container.innerHTML = '<div class="text-gray-400 italic py-10">ìƒëŒ€í•  ì„ ìˆ˜ Bë¥¼ ì„ íƒí•˜ì„¸ìš”.<br><span class="text-xs text-gray-300">(ì „ì ì´ ìˆëŠ” ì„ ìˆ˜ë§Œ ëª©ë¡ì— í‘œì‹œë©ë‹ˆë‹¤)</span></div>'; return; } 
            if (pA === pB) { container.innerHTML = '<div class="text-red-500 font-bold py-10">ë™ì¼í•œ ì„ ìˆ˜ë¥¼ ì„ íƒí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>'; return; } 
            let wins = 0; let losses = 0; const matches = []; 
            if (matchHistoryData) { 
                matchHistoryData.forEach(m => { 
                    const s = m.season || "ì‹œì¦Œ 1"; if (s !== viewSeason) return; if (m.type === 'friendly') return; 
                    if (m.winner === pA && m.loser === pB) { wins++; matches.push({ ...m, winnerIsA: true }); } 
                    else if (m.winner === pB && m.loser === pA) { losses++; matches.push({ ...m, winnerIsA: false }); } 
                }); 
            } 
            const total = wins + losses; const winRate = total > 0 ? ((wins / total) * 100).toFixed(1) : "0.0"; 
            let resultHtml = ` <div class="bg-white p-4 rounded-xl shadow-md border border-blue-100 mb-6"> <div class="text-sm font-bold text-gray-500 mb-1">[${viewSeason}] ìƒëŒ€ ì „ì  ìš”ì•½</div> <div class="flex items-center justify-center space-x-4 mb-2"> <div class="text-xl font-bold text-gray-800">${pA}</div> <div class="text-2xl font-black text-blue-600">VS</div> <div class="text-xl font-bold text-gray-800">${pB}</div> </div> <div class="flex items-center justify-center gap-3 bg-gray-100 px-4 py-2 rounded-lg shadow-inner mb-2 w-fit mx-auto"> <span class="text-3xl font-black text-red-600">${wins}</span> <span class="text-gray-400 text-xl font-bold pb-1">:</span> <span class="text-3xl font-black text-blue-600">${losses}</span> </div> <div class="text-sm font-medium text-gray-500"> ìŠ¹ë¥  <span class="text-gray-800">${winRate}%</span> (ì´ ${total}ì „) </div> </div> <h4 class="text-left text-sm font-bold text-gray-600 mb-2 ml-1">ğŸ“ ë§ëŒ€ê²° ê¸°ë¡</h4> `; 
            if (matches.length === 0) { resultHtml += '<div class="text-gray-400 italic text-sm py-4">ë§ëŒ€ê²° ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>'; } else { resultHtml += '<div class="space-y-2">'; matches.forEach(m => { const resultBadge = m.winnerIsA ? `<span class="bg-red-100 text-red-700 text-xs px-2 py-1 rounded font-bold">ìŠ¹ë¦¬</span>` : `<span class="bg-blue-100 text-blue-700 text-xs px-2 py-1 rounded font-bold">íŒ¨ë°°</span>`; const typeText = m.type === 'defense' ? 'ë°©ì–´ì „' : 'ë„ì „ ë§¤ì¹˜'; resultHtml += ` <div class="bg-white p-3 rounded-lg shadow-sm border border-gray-100 flex justify-between items-center"> <div class="text-left"> <div class="text-xs text-gray-400 font-medium mb-0.5">${m.date}</div> <div class="text-xs text-gray-500">${typeText}</div> </div> <div class="text-right"> ${resultBadge} <div class="text-[10px] text-gray-400 mt-1">${m.detail || ''}</div> </div> </div> `; }); resultHtml += '</div>'; } container.innerHTML = resultHtml; 
        }

        function renderHallOfFame() {
            const container = document.getElementById('hofContent'); const seasonTitleInput = document.getElementById('seasonTitleInput'); const bestMatchInput = document.getElementById('bestMatchInput');
            if (seasonTitleInput && seasonTitleInput.value !== currentSeasonTitle) { seasonTitleInput.value = currentSeasonTitle; }
            if (bestMatchInput && bestMatchInput.value !== currentSeasonBestMatch) { bestMatchInput.value = currentSeasonBestMatch; }
            if (!container) return;
            let rank1 = "-", rank2 = "-", rank3 = "-", defenseKing = "-", defenseCountMax = 0;
            if (rankingsData.length > 0) rank1 = rankingsData[0].name; if (rankingsData.length > 1) rank2 = rankingsData[1].name; if (rankingsData.length > 2) rank3 = rankingsData[2].name; 
            const maxDef = Math.max(...rankingsData.map(i => i.defenseCount || 0));
            if (maxDef > 0) { const kings = []; rankingsData.forEach((item, index) => { if ((item.defenseCount || 0) === maxDef) { kings.push(`${item.name} <span class="text-base text-gray-500 font-medium">(${index + 1}ìœ„)</span>`); } }); defenseKing = kings.join(', '); defenseCountMax = maxDef; } else { defenseKing = "ì•„ì§ ì—†ìŒ"; }
            const maxMatches = Math.max(...rankingsData.map(i => (i.wins || 0) + (i.losses || 0)));
            let participationKing = "-";
            if (maxMatches > 0) { const pKings = []; rankingsData.forEach((item, index) => { const total = (item.wins || 0) + (item.losses || 0); if (total === maxMatches) { pKings.push(`${item.name} <span class="text-base text-gray-500 font-medium">(${index + 1}ìœ„)</span>`); } }); participationKing = pKings.join(', '); } else { participationKing = "ì•„ì§ ì—†ìŒ"; }
            container.innerHTML = ` <div class="mb-6"> <h3 class="text-center text-lg font-bold text-gray-700 mb-3">ğŸ† ${viewSeason} TOP 3</h3> <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-center items-end"> <div class="hof-card hof-silver order-2 sm:order-1 transform sm:scale-95"> <div class="text-2xl mb-1">ğŸ¥ˆ 2ìœ„</div> <p class="text-xl font-bold text-gray-800 break-words">${rank2}</p> </div> <div class="hof-card hof-champion order-1 sm:order-2 transform sm:scale-105 z-10 shadow-lg"> <div class="text-4xl mb-2">ğŸ‘‘</div> <div class="text-amber-500 font-bold mb-1">CHAMPION</div> <p class="text-2xl font-black text-gray-900 break-words">${rank1}</p> </div> <div class="hof-card hof-bronze order-3 transform sm:scale-95"> <div class="text-2xl mb-1">ğŸ¥‰ 3ìœ„</div> <p class="text-xl font-bold text-gray-800 break-words">${rank3}</p> </div> </div> </div> <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6"> <div class="hof-card hof-defense"> <div class="flex items-center justify-center mb-1"> <span class="text-2xl mr-2">ğŸ›¡ï¸</span> <h3 class="text-lg font-bold text-blue-600">ì² ë²½ ë°©ì–´ì™•</h3> </div> <p class="text-2xl font-bold text-gray-800">${defenseKing}</p> <p class="text-sm text-gray-500 mt-1">${defenseCountMax > 0 ? defenseCountMax + 'íšŒ ë°©ì–´' : 'ê¸°ë¡ ì—†ìŒ'}</p> </div> <div class="hof-card hof-passion"> <div class="flex items-center justify-center mb-1"> <span class="text-2xl mr-2">ğŸ”¥</span> <h3 class="text-lg font-bold text-red-600">ì—´í˜ˆ íŒŒì´í„°</h3> </div> <p class="text-2xl font-bold text-gray-800">${participationKing}</p> <p class="text-sm text-gray-500 mt-1">${maxMatches > 0 ? maxMatches + 'ì „ ì¹˜ë¦„' : 'ê¸°ë¡ ì—†ìŒ'}</p> </div> </div> <div class="bg-white rounded-xl shadow p-4 border border-gray-200 mb-6 mt-6"> <h3 class="text-md font-bold text-gray-700 flex items-center mb-2"><span class="mr-2">ğŸ”¥</span> ${viewSeason} ìµœê³ ì˜ ëª…ê²½ê¸°</h3> </div> `;
            const bestMatchContainer = container.querySelector('.bg-white.rounded-xl.shadow .text-md').parentNode;
            if (viewSeason === activeSeason) { const input = document.createElement('input'); input.type = 'text'; input.id = 'bestMatchInput'; input.placeholder = "ì˜ˆ: í™ê¸¸ë™ vs ê¹€ì² ìˆ˜ (í´ë¦­í•˜ì—¬ ì…ë ¥)"; input.className = "w-full p-2 bg-gray-5 rounded italic text-center border border-gray-200 focus:ring-blue-500 focus:border-blue-500 text-gray-800"; input.value = currentSeasonBestMatch; input.addEventListener('change', handleBestMatchChange); bestMatchContainer.appendChild(input); } else { const archive = seasonArchives[viewSeason]; const staticDiv = document.createElement('div'); staticDiv.className = "w-full p-2 bg-gray-100 rounded italic text-center text-gray-600 font-bold"; staticDiv.textContent = archive ? (archive.bestMatch || "-") : "ë°ì´í„° ì—†ìŒ"; bestMatchContainer.appendChild(staticDiv); }
        }

        function showMatchModal() { 
            const modal = document.getElementById('matchModal'); const player1Select = document.getElementById('matchPlayer1'); const player2Select = document.getElementById('matchPlayer2'); const externalInputDiv = document.getElementById('externalInputDiv'); const externalNameInput = document.getElementById('externalNameInput'); const radios = document.getElementsByName('matchResult');
            if (!modal || !player1Select || !player2Select) return; 
            const externalOption = '<option value="external" class="font-bold text-indigo-600">ğŸ¥· ì™¸ë¶€ ë„ì „ì (ì§ì ‘ ì…ë ¥)</option>';
            player1Select.innerHTML = `<option value="">ì„ ìˆ˜ ì„ íƒ</option>${externalOption}`; player2Select.innerHTML = `<option value="">ì„ ìˆ˜ ì„ íƒ</option>${externalOption}`; 
            rankingsData.forEach((item, index) => { const rankText = `${index + 1}ìœ„`; const optionText = `${rankText} - ${item.name}`; const opt1 = document.createElement('option'); opt1.value = item.id; opt1.textContent = optionText; player1Select.appendChild(opt1); const opt2 = document.createElement('option'); opt2.value = item.id; opt2.textContent = optionText; player2Select.appendChild(opt2); }); 
            if (externalNameInput) externalNameInput.value = ''; if (externalInputDiv) externalInputDiv.classList.add('hidden'); radios.forEach(r => r.checked = false); 
            const previewEl = document.getElementById('matchResultPreview'); previewEl.textContent = "ë‘ ì„ ìˆ˜ë¥¼ ì„ íƒí•˜ê³  ìŠ¹ìë¥¼ ì²´í¬í•˜ì„¸ìš”."; previewEl.className = "text-sm font-bold text-gray-500"; 
            document.getElementById('predictionContainer').classList.add('hidden'); modal.classList.remove('hidden'); 
        }
        function hideMatchModal() { const modal = document.getElementById('matchModal'); if (modal) modal.classList.add('hidden'); }
        function handleMatchSelectChange() {
            const p1Id = document.getElementById('matchPlayer1').value; const p2Id = document.getElementById('matchPlayer2').value; const externalInputDiv = document.getElementById('externalInputDiv');
            if (p1Id === 'external' || p2Id === 'external') { externalInputDiv.classList.remove('hidden'); } else { externalInputDiv.classList.add('hidden'); } updateMatchPrediction(); updateMatchPreview();
        }
        window.handleMatchSelectChange = handleMatchSelectChange;
        function handleMatchResultChange() { updateMatchPreview(); }
        window.handleMatchResultChange = handleMatchResultChange;

        function updateMatchPrediction() {
            const p1Id = document.getElementById('matchPlayer1').value; const p2Id = document.getElementById('matchPlayer2').value; const container = document.getElementById('predictionContainer'); if (!container) return; 
            if (!p1Id || !p2Id || p1Id === p2Id || p1Id === 'external' || p2Id === 'external') { container.classList.add('hidden'); return; }
            const p1 = rankingsData.find(r => r.id === p1Id); const p2 = rankingsData.find(r => r.id === p2Id); if (!p1 || !p2) return;
            let h2hWins = 0; let h2hLosses = 0;
            if (matchHistoryData && Array.isArray(matchHistoryData)) { matchHistoryData.forEach(m => { const s = m.season || "ì‹œì¦Œ 1"; if (s !== viewSeason) return; if (m.type === 'friendly') return; if (m.winner === p1.name && m.loser === p2.name) h2hWins++; else if (m.winner === p2.name && m.loser === p1.name) h2hLosses++; }); }
            let p1Score = 50; let factors = []; const p1Rank = rankingsData.findIndex(r => r.id === p1Id) + 1; const p2Rank = rankingsData.findIndex(r => r.id === p2Id) + 1; const rankDiff = p2Rank - p1Rank; let rankScore = Math.min(Math.max(rankDiff * 1.0, -20), 20); p1Score += rankScore; if (Math.abs(rankScore) >= 5) factors.push(rankScore > 0 ? "ë­í‚¹ ìš°ìœ„" : "ë­í‚¹ ì—´ì„¸");
            const p1Total = (p1.wins || 0) + (p1.losses || 0); const p2Total = (p2.wins || 0) + (p2.losses || 0); const p1Rate = p1Total > 0 ? (p1.wins / p1Total) : 0; const p2Rate = p2Total > 0 ? (p2.wins / p2Total) : 0; p1Score += (p1Rate - p2Rate) * 1;
            const getStreak = (recent) => { let s = 0; let type = 0; for (let i = recent.length - 1; i >= 0; i--) { if (recent[i] === 0) break; if (type === 0) { type = recent[i]; s = type === 1 ? 1 : -1; } else if (recent[i] === type) { s += (type === 1 ? 1 : -1); } else break; } return s; };
            const p1Streak = getStreak(p1.recentMatchResults || []); const p2Streak = getStreak(p2.recentMatchResults || []); p1Score += (p1Streak - p2Streak) * 1; if (p1Streak >= 3) factors.push("ì²­ì½”ë„ˆ ìƒìŠ¹ì„¸ğŸ”¥"); if (p2Streak >= 3) factors.push("í™ì½”ë„ˆ ìƒìŠ¹ì„¸ğŸ”¥");
            p1Score += (h2hWins - h2hLosses) * 2; if (h2hWins > h2hLosses) factors.push(`ìƒëŒ€ ì „ì  ìš°ìœ„`); else if (h2hLosses > h2hWins) factors.push(`ìƒëŒ€ ì „ì  ì—´ì„¸`);
            p1Score = Math.min(Math.max(Math.round(p1Score), 5), 95); const p2Score = 100 - p1Score; let predictionText = "ë°•ë¹™"; if (p1Score >= 60) predictionText = "ì²­ì½”ë„ˆ ìš°ì„¸"; else if (p1Score <= 40) predictionText = "í™ì½”ë„ˆ ìš°ì„¸"; else if (p1Score > 50) predictionText = "ì²­ì½”ë„ˆ ì•½ìš°ì„¸"; else if (p1Score < 50) predictionText = "í™ì½”ë„ˆ ì•½ìš°ì„¸";
            const renderDots = (results) => { const display = results.slice(-6); while(display.length < 6) display.unshift(0); return display.map(r => { let color = 'bg-gray-200'; if (r === 1) color = 'bg-red-500'; if (r === 2) color = 'bg-blue-500'; return `<div class="w-2 h-2 rounded-full ${color}"></div>`; }).join(''); };
            container.innerHTML = ` <div class="bg-white rounded-lg border border-gray-200 p-3 shadow-sm"> <div class="text-sm text-gray-400 text-center mb-2 font-bold">ìƒëŒ€ ì „ì  (Head-to-Head)</div> <div class="flex justify-between items-center mb-3"> <div class="w-[40%] text-left flex flex-col justify-center overflow-hidden"> <span class="text-base text-blue-400 font-bold mb-0.5">${p1Rank}ìœ„</span> <div class="text-blue-600 font-black text-xl truncate leading-tight" title="${p1.name}">${p1.name}</div> </div> <div class="w-[20%] flex justify-center items-center"> <div class="flex items-center justify-center gap-3 bg-gray-100 px-3 py-1 rounded shadow-inner"> <span class="text-gray-800 font-black text-2xl">${h2hWins}</span> <span class="text-gray-400 text-lg font-bold pb-0.5">:</span> <span class="text-gray-800 font-black text-2xl">${h2hLosses}</span> </div> </div> <div class="w-[40%] text-right flex flex-col justify-center overflow-hidden"> <span class="text-base text-red-400 font-bold mb-0.5">${p2Rank}ìœ„</span> <div class="text-red-600 font-black text-xl truncate leading-tight" title="${p2.name}">${p2.name}</div> </div> </div> <div class="flex justify-between items-center mb-4 px-2"> <div class="flex space-x-1">${renderDots(p1.recentMatchResults || [])}</div> <div class="text-[10px] text-gray-400 font-bold">ìµœê·¼ 6ê²½ê¸°</div> <div class="flex space-x-1">${renderDots(p2.recentMatchResults || [])}</div> </div> <div class="border-t border-gray-100 pt-2"> <div class="flex justify-between items-end mb-1"> <span class="text-sm font-bold text-gray-500">AI ì˜ˆì¸¡</span> <span class="text-sm font-bold text-gray-700">${predictionText} (${p1Score > 50 ? p1Score : p2Score}%)</span> </div> <div class="prediction-bar-container shadow-inner bg-gray-200 h-2.5"> <div class="prediction-bar-fill bg-blue-500 absolute left-0 top-0 h-full" style="width: ${p1Score}%"></div> <div class="prediction-bar-fill bg-red-500 absolute right-0 top-0 h-full" style="width: ${p2Score}%"></div> </div> ${factors.length > 0 ? `<div class="text-[10px] text-gray-400 text-center mt-1 truncate">${factors.join(', ')}</div>` : ''} </div> </div> `; container.classList.remove('hidden');
        }

        function updateMatchPreview() { 
            const p1Id = document.getElementById('matchPlayer1').value; const p2Id = document.getElementById('matchPlayer2').value; const previewEl = document.getElementById('matchResultPreview'); const radios = document.getElementsByName('matchResult');
            let selectedWinner = null; for (const radio of radios) { if (radio.checked) selectedWinner = radio.value; }
            if (!p1Id || !p2Id) { previewEl.textContent = "ë‘ ì„ ìˆ˜ë¥¼ ì„ íƒí•˜ì„¸ìš”."; previewEl.className = "text-sm font-bold text-gray-500"; return; } 
            if (p1Id === p2Id) { previewEl.textContent = "ê°™ì€ ì„ ìˆ˜ë¥¼ ì„ íƒí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."; previewEl.className = "mt-2 text-sm font-bold text-red-600"; return; }
            if (!selectedWinner) { previewEl.innerHTML = "ê²½ê¸° ê²°ê³¼ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.<br>(ìŠ¹ë¦¬í•œ ì½”ë„ˆì˜ ì²´í¬ë°•ìŠ¤ë¥¼ í´ë¦­)"; previewEl.className = "mt-2 text-sm font-bold text-orange-600 animate-pulse"; return; }
            let winnerId, loserId; let winnerColor, loserColor;
            if (selectedWinner === 'blue') { winnerId = p1Id; loserId = p2Id; winnerColor = "text-blue-600"; loserColor = "text-red-600"; } else { winnerId = p2Id; loserId = p1Id; winnerColor = "text-red-600"; loserColor = "text-blue-600"; }
            if (winnerId === 'external') { const loserIndex = rankingsData.findIndex(item => item.id === loserId); const loserName = rankingsData[loserIndex].name; const defeatedRank = loserIndex + 1; let message = ""; if (defeatedRank < 25) { message = `[ë„ì¥ ê¹¨ê¸° ì„±ê³µ] <span class="${winnerColor}">ì™¸ë¶€ ë„ì „ì ìŠ¹ë¦¬!</span><br>ìƒìœ„ ë­ì»¤(${defeatedRank}ìœ„ ${loserName})ëŠ” 1ë‹¨ê³„ í•˜ë½ íŒ¨ë„í‹°.<br>ë„ì „ìëŠ” 25ìœ„ë¡œ ì§„ì…í•©ë‹ˆë‹¤.`; } else { message = `[ë„ì¥ ê¹¨ê¸° ì„±ê³µ] <span class="${winnerColor}">ì™¸ë¶€ ë„ì „ì ìŠ¹ë¦¬!</span><br>${defeatedRank}ìœ„(${loserName}) ìë¦¬ë¥¼ ì°¨ì§€í•©ë‹ˆë‹¤.`; } previewEl.innerHTML = message; previewEl.className = "mt-2 text-sm font-bold text-gray-800"; return; }
            if (loserId === 'external') { const winnerIndex = rankingsData.findIndex(item => item.id === winnerId); const winnerName = rankingsData[winnerIndex].name; previewEl.innerHTML = `[ë°©ì–´ ì„±ê³µ] <span class="${winnerColor}">${winnerName}</span>ë‹˜ ë°©ì–´ ì„±ê³µ!<br>(ìŠ¹ìˆ˜/ë°©ì–´ì „ +1, ìˆœìœ„ ìœ ì§€)`; previewEl.className = "mt-2 text-sm font-bold text-gray-800"; return; }
            const winnerIndex = rankingsData.findIndex(item => item.id === winnerId); const loserIndex = rankingsData.findIndex(item => item.id === loserId); const winnerRank = winnerIndex + 1; const loserRank = loserIndex + 1; const escapeHtml = (str) => str.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;"); const winnerName = escapeHtml(rankingsData[winnerIndex].name); const loserName = escapeHtml(rankingsData[loserIndex].name); 
            let message = ""; let baseColorClass = "text-gray-800";
            if (winnerRank < loserRank) { const diff = loserRank - winnerRank; if (diff >= 6) { message = `[ë°©ì–´ ì„±ê³µ] <span class="${winnerColor}">${winnerName}</span> ìŠ¹ë¦¬.<br>ë„ì „ì(${loserName})ëŠ” íŒ¨ë„í‹°ë¡œ <span class="text-red-600">1ë‹¨ê³„ í•˜ë½</span>í•©ë‹ˆë‹¤.`; } else { message = `[ë°©ì–´ ì„±ê³µ] <span class="${winnerColor}">${winnerName}</span> ìŠ¹ë¦¬.<br>ìˆœìœ„ ë³€ë™ì€ ì—†ìŠµë‹ˆë‹¤. (ë°©ì–´ì „ +1)`; } } else { const diff = winnerRank - loserRank; if (diff <= 5) { message = `[ìˆœìœ„ íƒˆí™˜] <span class="${winnerColor}">${winnerName}</span> ìŠ¹ë¦¬!<br>${loserName}ë‹˜ì˜ ìë¦¬(${loserRank}ìœ„)ë¥¼ ì°¨ì§€í•©ë‹ˆë‹¤.`; } else { message = `[ë„ì „ ì„±ê³µ] <span class="${winnerColor}">${winnerName}</span> ìŠ¹ë¦¬!<br>ìŠ¹ì <span class="text-red-600">1ë‹¨ê³„ ìƒìŠ¹</span>, íŒ¨ì <span class="text-blue-600">1ë‹¨ê³„ í•˜ë½</span>.`; } } 
            previewEl.innerHTML = message; previewEl.className = `mt-2 text-sm font-bold ${baseColorClass}`; 
        }

        function applyMatchResult(matchMode = 'ranking') { 
            const p1Id = document.getElementById('matchPlayer1').value; const p2Id = document.getElementById('matchPlayer2').value; const externalNameInput = document.getElementById('externalNameInput'); const radios = document.getElementsByName('matchResult');
            let selectedWinner = null; for (const radio of radios) { if (radio.checked) selectedWinner = radio.value; }
            if (!p1Id || !p2Id || p1Id === p2Id) return; if (!selectedWinner) { alert("ìŠ¹ë¦¬í•œ ì„ ìˆ˜ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”."); return; }
            const rawExternalName = externalNameInput ? (externalNameInput.value.trim() || 'ì™¸ë¶€ ë„ì „ì') : 'ì™¸ë¶€ ë„ì „ì';
            let p1Name, p1Rank, p2Name, p2Rank;
            if (p1Id === 'external') { p1Name = rawExternalName; p1Rank = 'UR'; } else { const p1Data = rankingsData.find(r => r.id === p1Id); p1Name = p1Data ? p1Data.name : '-'; p1Rank = p1Data ? (rankingsData.indexOf(p1Data) + 1) : 'UR'; }
            if (p2Id === 'external') { p2Name = rawExternalName; p2Rank = 'UR'; } else { const p2Data = rankingsData.find(r => r.id === p2Id); p2Name = p2Data ? p2Data.name : '-'; p2Rank = p2Data ? (rankingsData.indexOf(p2Data) + 1) : 'UR'; }
            let winnerId, loserId, winnerName, loserName, winnerRank, loserRank; let blueName = p1Name; let redName = p2Name; let blueRank = p1Rank; let redRank = p2Rank;
            if (selectedWinner === 'blue') { winnerId = p1Id; loserId = p2Id; winnerName = p1Name; loserName = p2Name; winnerRank = p1Rank; loserRank = p2Rank; } else { winnerId = p2Id; loserId = p1Id; winnerName = p2Name; loserName = p1Name; winnerRank = p2Rank; loserRank = p1Rank; }
            addToHistory(); const oldRanksMap = new Map(); rankingsData.forEach((item, index) => { oldRanksMap.set(item.id, index + 1); }); 
            const createMatchRecord = (wName, lName, wRank, lRank, type, detail) => { const now = new Date(); return { id: crypto.randomUUID(), date: now.toLocaleDateString('ko-KR', { month: 'short', day: 'numeric' }), time: now.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' }), winner: wName, loser: lName, winnerRank: wRank, loserRank: lRank, type: type, detail: detail, season: activeSeason, blue: blueName, red: redName, blueRank: blueRank, redRank: redRank }; };
            if (matchMode === 'friendly') {
                const logMsg = `ğŸ¤ ì¹œì„  ë§¤ì¹˜: ${winnerName} ìŠ¹ë¦¬ vs ${loserName} (ìˆœìœ„ ë³€ë™ ì—†ìŒ)`; const matchDetail = "ì¹œì„ /ì¼ë°˜ ë§¤ì¹˜ (ê¸°ë¡ë§Œ)"; const record = createMatchRecord(winnerName, loserName, winnerRank, loserRank, 'friendly', matchDetail);
                if (!matchHistoryData) matchHistoryData = []; matchHistoryData.unshift(record); if (matchHistoryData.length > MAX_LOGS) matchHistoryData.pop();
                addLogEntry(logMsg); saveRankings(); renderRankings(); hideMatchModal(); alert("ì¹œì„ ì „ ê¸°ë¡ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.\n(ë­í‚¹ê³¼ ì „ì ì€ ë³€ë™ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤)"); return;
            }
            if (winnerId === 'external') {
                const loserIndex = rankingsData.findIndex(item => item.id === loserId); const loserItem = rankingsData[loserIndex]; const defeatedRank = loserIndex + 1;
                loserItem.isParticipating = true; loserItem.losses = (loserItem.losses || 0) + 1; if (!loserItem.recentMatchResults) loserItem.recentMatchResults = [0,0,0,0,0,0]; loserItem.recentMatchResults.shift(); loserItem.recentMatchResults.push(2);
                const newPlayer = { id: crypto.randomUUID(), name: winnerName, notes: '-', previousRank: 30, isParticipating: true, defenseCount: 0, wins: 1, losses: 0, recentMatchResults: [0,0,0,0,0,1], entryTime: Date.now(), imageUrl: '', gameId: '' };
                let logMsg = ""; let targetRank = 0;
                if (defeatedRank < 25) { if (loserIndex < rankingsData.length - 1) { const nextItem = rankingsData[loserIndex + 1]; rankingsData[loserIndex] = nextItem; rankingsData[loserIndex + 1] = loserItem; } rankingsData.splice(24, 0, newPlayer); targetRank = 25; logMsg = `ğŸ†• ì™¸ë¶€ ìŠ¹ë¦¬: ${winnerName} > ${loserItem.name}. ë­ì»¤ í•˜ë½, ë„ì „ì 25ìœ„ ì§„ì….`; } else { rankingsData.splice(loserIndex, 0, newPlayer); targetRank = defeatedRank; logMsg = `ğŸ†• ì™¸ë¶€ ìŠ¹ë¦¬: ${winnerName} > ${loserItem.name}. ${targetRank}ìœ„ ì§„ì….`; }
                if (rankingsData.length > 30) { const rankedOutItem = rankingsData[30]; rankingsData.splice(30, 1); logMsg += `<br>ğŸ“‰ ë­í‚¹ì•„ì›ƒ: ${rankedOutItem.name}`; }
                addLogEntry(logMsg); const record = createMatchRecord(winnerName, loserItem.name, targetRank, defeatedRank, 'challenge_success', 'ì™¸ë¶€ ë„ì „ì ì§„ì… (New Entry)');
                if (!matchHistoryData) matchHistoryData = []; matchHistoryData.unshift(record); if (matchHistoryData.length > MAX_LOGS) matchHistoryData.pop();
                saveRankings(); renderRankings(); hideMatchModal();
                setTimeout(() => { const wRow = document.querySelector(`.rank-item[data-id="${newPlayer.id}"]`); const lRow = document.querySelector(`.rank-item[data-id="${loserItem.id}"]`); if (wRow) { wRow.scrollIntoView({ behavior: 'smooth', block: 'center' }); wRow.classList.add('winner-pulse'); setTimeout(() => wRow.classList.remove('winner-pulse'), 10000); } if (lRow) { lRow.classList.add('loser-pulse'); setTimeout(() => lRow.classList.remove('loser-pulse'), 10000); } }, 300); return;
            }
            if (loserId === 'external') {
                const winnerIndex = rankingsData.findIndex(item => item.id === winnerId); const winnerItem = rankingsData[winnerIndex]; const finalWinnerRank = winnerIndex + 1;
                winnerItem.isParticipating = true; winnerItem.wins = (winnerItem.wins || 0) + 1; winnerItem.defenseCount = (winnerItem.defenseCount || 0) + 1; if (!winnerItem.recentMatchResults) winnerItem.recentMatchResults = [0,0,0,0,0,0]; winnerItem.recentMatchResults.shift(); winnerItem.recentMatchResults.push(1);
                if (finalWinnerRank <= 3) winnerItem.notes = `S ë°©ì–´ì „ ${winnerItem.defenseCount}`; else winnerItem.notes = `ë°©ì–´ì „ ${winnerItem.defenseCount}`;
                addLogEntry(`ğŸ›¡ï¸ ì™¸ë¶€ ë°©ì–´: ${winnerItem.name} > ${loserName}`); const record = createMatchRecord(winnerItem.name, loserName, finalWinnerRank, null, 'defense', 'ì™¸ë¶€ ë„ì „ì ë°©ì–´');
                if (!matchHistoryData) matchHistoryData = []; matchHistoryData.unshift(record); if (matchHistoryData.length > MAX_LOGS) matchHistoryData.pop();
                saveRankings(); renderRankings(); hideMatchModal();
                setTimeout(() => { const wRow = document.querySelector(`.rank-item[data-id="${winnerItem.id}"]`); if (wRow) { wRow.scrollIntoView({ behavior: 'smooth', block: 'center' }); wRow.classList.add('winner-pulse'); setTimeout(() => wRow.classList.remove('winner-pulse'), 10000); } }, 300); return;
            }
            const winnerIndex = rankingsData.findIndex(item => item.id === winnerId); const loserIndex = rankingsData.findIndex(item => item.id === loserId); const winnerItem = rankingsData[winnerIndex]; const loserItem = rankingsData[loserIndex]; 
            winnerItem.isParticipating = true; loserItem.isParticipating = true; winnerItem.wins = (winnerItem.wins || 0) + 1; loserItem.losses = (loserItem.losses || 0) + 1; 
            if (!winnerItem.recentMatchResults) winnerItem.recentMatchResults = [0,0,0,0,0,0]; winnerItem.recentMatchResults.shift(); winnerItem.recentMatchResults.push(1);
            if (!loserItem.recentMatchResults) loserItem.recentMatchResults = [0,0,0,0,0,0]; loserItem.recentMatchResults.shift(); loserItem.recentMatchResults.push(2);
            const internalWinnerRank = winnerIndex + 1; const internalLoserRank = loserIndex + 1; let logMsg = ""; let matchType = ""; let matchDetail = ""; 
            if (internalWinnerRank < internalLoserRank) { 
                matchType = "defense"; const diff = internalLoserRank - internalWinnerRank; winnerItem.defenseCount = (winnerItem.defenseCount || 0) + 1; 
                if (diff >= 6) { if (loserIndex < rankingsData.length - 1) { const nextItem = rankingsData[loserIndex + 1]; rankingsData[loserIndex] = nextItem; rankingsData[loserIndex + 1] = loserItem; logMsg = `ğŸ›¡ï¸ ë°©ì–´&íŒ¨ë„í‹°: ${winnerItem.name} ìŠ¹. ${loserItem.name} 1ë‹¨ê³„ í•˜ë½.`; matchDetail = "ë„ì „ì 1ë‹¨ê³„ í•˜ë½"; } else { logMsg = `ğŸ›¡ï¸ ë°©ì–´ ì„±ê³µ: ${winnerItem.name} ìŠ¹.`; matchDetail = "ìˆœìœ„ ë³€ë™ ì—†ìŒ"; } } else { logMsg = `ğŸ›¡ï¸ ë°©ì–´ ì„±ê³µ: ${winnerItem.name} ìŠ¹.`; matchDetail = `ë°©ì–´ ${winnerItem.defenseCount}ìŠ¹ ë‹¬ì„±`; } 
            } else { 
                matchType = "challenge_success"; const diff = internalWinnerRank - internalLoserRank; 
                if (diff <= 5) { rankingsData.splice(winnerIndex, 1); rankingsData.splice(loserIndex, 0, winnerItem); logMsg = `âš”ï¸ ìˆœìœ„ íƒˆí™˜: ${winnerItem.name} > ${loserItem.name} (${internalLoserRank}ìœ„).`; matchDetail = "ìë¦¬ ëºê¸° (Rank Swap)"; } else { if (winnerIndex > 0) { const upperItem = rankingsData[winnerIndex - 1]; rankingsData[winnerIndex - 1] = winnerItem; rankingsData[winnerIndex] = upperItem; } if (loserIndex < rankingsData.length - 1) { const lowerItem = rankingsData[loserIndex + 1]; rankingsData[loserIndex + 1] = loserItem; rankingsData[loserIndex] = lowerItem; } logMsg = `ğŸš€ ë„ì „ ì„±ê³µ: ${winnerItem.name}(+1), ${loserItem.name}(-1).`; matchDetail = "ë„ì „ì +1 / íŒ¨ì -1"; } 
            } 
            rankingsData.forEach((item, index) => { const newRank = index + 1; const oldRank = oldRanksMap.get(item.id); checkAndApplyRankRules(item, newRank, oldRank); }); 
            const record = createMatchRecord(winnerItem.name, loserItem.name, internalWinnerRank, internalLoserRank, matchType, matchDetail);
            if (!matchHistoryData) matchHistoryData = []; matchHistoryData.unshift(record); if (matchHistoryData.length > MAX_LOGS) matchHistoryData.pop(); 
            addLogEntry(logMsg); saveRankings(); renderRankings(); hideMatchModal(); 
            setTimeout(() => { const wRow = document.querySelector(`.rank-item[data-id="${winnerId}"]`); const lRow = document.querySelector(`.rank-item[data-id="${loserId}"]`); if (wRow) { wRow.scrollIntoView({ behavior: 'smooth', block: 'center' }); wRow.classList.add('winner-pulse'); setTimeout(() => wRow.classList.remove('winner-pulse'), 10000); } if (lRow) { lRow.classList.add('loser-pulse'); setTimeout(() => lRow.classList.remove('loser-pulse'), 10000); } }, 300); 
        }
        
        function handleNameChange(e) { addToHistory(); const targetId = e.target.dataset.id; const newName = e.target.value.trim(); if (newName === "") { e.target.value = rankingsData.find(item => item.id === targetId)?.name || 'ì´ë¦„ ì—†ìŒ'; return; } const itemIndex = rankingsData.findIndex(item => item.id === targetId); if (itemIndex > -1) { rankingsData[itemIndex].name = newName; saveRankings(); } }
        function handleChangeChange(e) { addToHistory(); const targetId = e.target.dataset.id; const rawNewChange = e.target.value.trim(); const itemIndex = rankingsData.findIndex(item => item.id === targetId); if (itemIndex < 0) return; const currentRank = itemIndex + 1; let numericChange = 0; let changeMatch = rawNewChange.match(/([+\-]?\d+)/); if (changeMatch && changeMatch[1]) numericChange = parseInt(changeMatch[1], 10); const newPreviousRank = currentRank + numericChange; rankingsData[itemIndex].previousRank = newPreviousRank; let displayValue = 'â€”'; if (numericChange > 0) displayValue = `+${numericChange}`; else if (numericChange < 0) displayValue = String(numericChange); e.target.value = displayValue; saveRankings(); }
        function handleWinLossChange(e) { addToHistory(); const targetId = e.target.dataset.id; const type = e.target.dataset.type; const rawValue = e.target.value.trim(); const itemIndex = rankingsData.findIndex(item => item.id === targetId); if (itemIndex < 0) return; const val = parseInt(rawValue, 10); if (isNaN(val) || val < 0) { e.target.value = type === 'win' ? (rankingsData[itemIndex].wins || 0) : (rankingsData[itemIndex].losses || 0); return; } if (type === 'win') { rankingsData[itemIndex].wins = val; } else { rankingsData[itemIndex].losses = val; } saveRankings(); }
        function handleNoteChange(e) { addToHistory(); const targetId = e.target.dataset.id; let newNote = e.target.value.trim(); const itemIndex = rankingsData.findIndex(item => item.id === targetId); if (itemIndex < 0) return; const currentRank = itemIndex + 1; const isNumeric = /^\d+$/.test(newNote); if (isNumeric) { const count = parseInt(newNote, 10); if (currentRank <= 3) { newNote = `S ë°©ì–´ì „ ${count}`; } else { newNote = `ë°©ì–´ì „ ${count}`; } rankingsData[itemIndex].defenseCount = count; } else { const count = parseDefenseCount(newNote); rankingsData[itemIndex].defenseCount = count; } rankingsData[itemIndex].notes = newNote; e.target.value = newNote; saveRankings(); }
        function handleParticipationChange(e) { addToHistory(); const targetId = e.target.dataset.id; const isChecked = e.target.checked; const itemIndex = rankingsData.findIndex(item => item.id === targetId); if (itemIndex > -1) { rankingsData[itemIndex].isParticipating = isChecked; saveRankings(); renderRankings(); } }
        function handleDateChange(e) { addToHistory(); currentRankingDate = e.target.value; saveRankings(); }

        function handleDotClick(e, id, index) {
            e.stopPropagation(); addToHistory(); const itemIndex = rankingsData.findIndex(item => item.id === id);
            if (itemIndex > -1) { if (!rankingsData[itemIndex].recentMatchResults) { rankingsData[itemIndex].recentMatchResults = [0,0,0,0,0,0]; } const currentVal = rankingsData[itemIndex].recentMatchResults[index]; let nextVal = 0; if (currentVal === 0) nextVal = 1; else if (currentVal === 1) nextVal = 2; else nextVal = 0; rankingsData[itemIndex].recentMatchResults[index] = nextVal; saveRankings(); renderRankings(); }
        }
        
        function checkAndApplyRankRules(item, newRank, oldRank) { if (oldRank === undefined) return false; const oldIsSpecial = oldRank <= 3; const newIsSpecial = newRank <= 3; if (oldIsSpecial !== newIsSpecial) { item.notes = "-"; item.defenseCount = 0; return true; } const count = item.defenseCount || 0; if (count === 0) return false; if (newRank <= 3) { item.notes = `S ë°©ì–´ì „ ${count}`; } else { item.notes = `ë°©ì–´ì „ ${count}`; } return false; }
        function resetRankChanges() { showConfirmModal("ëª¨ë“  ì„ ìˆ˜ì˜ ìˆœìœ„ ë³€ë™í­ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?", () => { addToHistory(); const rankingsToSave = rankingsData.map((item, index) => ({ ...item, previousRank: index + 1 })); rankingsData = rankingsToSave; previousRankingsData = JSON.parse(JSON.stringify(rankingsToSave)); previousRankingsData.sort((a, b) => a.previousRank - b.previousRank); addLogEntry("ğŸ”„ ë­í‚¹ ë³€ë™í­ ì´ˆê¸°í™”"); saveRankings(); renderRankings(); }); }
        function resetDefenseCounts() { const btn = document.getElementById('resetDefenseButton'); const isRestoring = !!defenseSnapshot; const confirmMsg = isRestoring ? "ë°©ì–´ì „ ê¸°ë¡ì„ ë³µêµ¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?" : "ëª¨ë“  ì„ ìˆ˜ì˜ ë°©ì–´ì „ ê¸°ë¡ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?"; showConfirmModal(confirmMsg, () => { if (defenseSnapshot) { addToHistory(); rankingsData.forEach(item => { const savedItem = defenseSnapshot.find(s => s.id === item.id); if (savedItem) { item.notes = savedItem.notes; item.defenseCount = savedItem.defenseCount; } }); defenseSnapshot = null; addLogEntry("â™»ï¸ ë°©ì–´ì „ ê¸°ë¡ ë³µêµ¬ë¨"); if (btn) { btn.innerHTML = '<span>ë°©ì–´ì „ ì´ˆê¸°í™”</span>'; btn.classList.remove('bg-green-600', 'hover:bg-green-700'); btn.classList.add('bg-amber-500', 'hover:bg-amber-600'); btn.title = "ë°©ì–´ì „ ì´ˆê¸°í™”"; } flashButtonSuccess('resetDefenseButton', '', 'bg-amber-500'); } else { addToHistory(); defenseSnapshot = rankingsData.map(item => ({ id: item.id, notes: item.notes, defenseCount: item.defenseCount })); rankingsData.forEach(item => { item.notes = '-'; item.defenseCount = 0; }); addLogEntry("ğŸ›¡ï¸ ë°©ì–´ì „ ê¸°ë¡ ì „ì²´ ì´ˆê¸°í™”"); if (btn) { btn.innerHTML = '<span>â†©ï¸ ë°©ì–´ì „ ë³µêµ¬</span>'; btn.classList.remove('bg-amber-500', 'hover:bg-amber-600'); btn.classList.add('bg-green-600', 'hover:bg-green-700'); btn.title = "ëˆ„ë¥´ë©´ ì´ˆê¸°í™” ì·¨ì†Œ (ì›ìƒë³µêµ¬)"; } } saveRankings(); renderRankings(); }); }
        function resetRecords() { showConfirmModal("ëª¨ë“  ì„ ìˆ˜ì˜ ì „ì (ìŠ¹/íŒ¨)ì„ 0ìœ¼ë¡œ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?", () => { addToHistory(); rankingsData.forEach(item => { item.wins = 0; item.losses = 0; item.recentMatchResults = [0,0,0,0,0,0]; }); addLogEntry("ğŸ“Š ì „ì  ê¸°ë¡ ì „ì²´ ì´ˆê¸°í™” (0ìŠ¹ 0íŒ¨)"); saveRankings(); renderRankings(); flashButtonSuccess('resetRecordsButton', '', 'bg-gray-500'); }); }
        function resetParticipation() { showConfirmModal("ëª¨ë“  ì„ ìˆ˜ì˜ ì°¸ì—¬ ìƒíƒœë¥¼ ì¼ê´„ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?", () => { addToHistory(); const isAllUnchecked = rankingsData.every(item => !item.isParticipating); const newState = isAllUnchecked ? true : false; const rankingsToSave = rankingsData.map(item => ({ ...item, isParticipating: newState })); rankingsData = rankingsToSave; addLogEntry(`ğŸ“ ì°¸ì—¬ ìƒíƒœ ì „ì²´ ${newState ? 'ì²´í¬' : 'í•´ì œ'}`); saveRankings(); flashButtonSuccess('resetParticipationButton', '', 'bg-green-500'); }); }
        function flashButtonSuccess(buttonId, successText, originalColorClass = 'bg-red-500') { const button = document.getElementById(buttonId); if (button) { const originalContent = button.innerHTML; button.classList.remove('bg-red-500', 'hover:bg-red-600', 'bg-amber-500', 'hover:bg-amber-600', 'bg-amber-600', 'hover:bg-amber-700', 'bg-blue-500', 'hover:bg-blue-600', 'bg-green-500', 'hover:bg-green-600', 'bg-gray-500', 'hover:bg-gray-600'); button.classList.add('bg-green-500', 'hover:bg-green-600'); button.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check"><polyline points="20 6 9 17 4 12"/></svg>`; button.disabled = true; setTimeout(() => { button.innerHTML = originalContent; button.classList.remove('bg-green-500', 'hover:bg-green-600'); button.classList.add(originalColorClass, 'hover:' + originalColorClass.replace('bg-', 'hover:bg-')); button.disabled = false; }, 1500); } }
        function showConfirmModal(content, callback) { const modal = document.getElementById('confirmModal'); const msg = document.getElementById('confirmMessage'); if (modal && msg) { msg.innerHTML = content; confirmCallback = callback; modal.classList.remove('hidden'); } }
        function hideConfirmModal() { const modal = document.getElementById('confirmModal'); if (modal) { modal.classList.add('hidden'); } confirmCallback = null; }
        
        // ... (í”„ë¡œí•„ ëª¨ë‹¬ ê´€ë ¨ í•¨ìˆ˜ë“¤ - ìœ ì§€ë¨) ...
        function openProfileModal(playerId) {
            const player = rankingsData.find(p => p.id === playerId);
            if (!player) return;
            
            const modal = document.getElementById('profileModal'); const nameEl = document.getElementById('profileName'); const rankEl = document.getElementById('profileRank'); const imgEl = document.getElementById('profileImage'); const recordEl = document.getElementById('profileRecord'); const winRateEl = document.getElementById('profileWinRate'); const analysisEl = document.getElementById('profileMatchupAnalysis'); const highRankEl = document.getElementById('profileHighRank'); const logContainerEl = document.getElementById('profileLogList');
            const tagsEl = document.getElementById('profileTags'); const memoEl = document.getElementById('profileAdminMemo');
            const gameIdInput = document.getElementById('profileGameId'); // New Game ID input
            
            if (nameEl) nameEl.textContent = player.name; 
            const rank = rankingsData.indexOf(player) + 1; 

            if (rankEl) rankEl.innerHTML = `${rank}<span class="text-sm font-normal text-gray-400 ml-1">ìœ„</span>`;
            const highRank = player.careerHighRank || rank; 
            if (highRankEl) highRankEl.textContent = `${highRank}ìœ„`;
            
            // --- Game ID Logic ---
            if (gameIdInput) {
                gameIdInput.value = player.gameId || '';
                // Clone to remove old listeners
                const newGameIdInput = gameIdInput.cloneNode(true);
                gameIdInput.parentNode.replaceChild(newGameIdInput, gameIdInput);
                
                newGameIdInput.addEventListener('change', (e) => {
                    const newVal = e.target.value.trim();
                    if (player.gameId !== newVal) {
                        player.gameId = newVal;
                        saveRankings();
                    }
                });
            }

            if (player.imageUrl) { if (imgEl) { imgEl.src = player.imageUrl; imgEl.classList.remove('p-4'); } } else { if (imgEl) { imgEl.src = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%239ca3af' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2'/%3E%3Ccircle cx='12' cy='7' r='4'/%3E%3C/svg%3E"; imgEl.classList.add('p-4'); } }
            
            // [ìˆ˜ì • ì™„ë£Œ] í”„ë¡œí•„ ì‚¬ì§„ ì»¨í…Œì´ë„ˆ: LOL ìŠ¤íƒ€ì¼ í…Œë‘ë¦¬ ì ìš© (ìƒ‰ìƒ ìœ ì§€)
            const imgContainer = document.getElementById('profileImageContainer');
            if (imgContainer) {
                // ê¸°ì¡´ ìŠ¤íƒ€ì¼ ì´ˆê¸°í™”
                imgContainer.style.backgroundOrigin = "";
                imgContainer.style.backgroundClip = "";
                imgContainer.style.backgroundImage = "";
                imgContainer.style.border = "";
                imgContainer.style.boxShadow = "";
                imgContainer.style.borderRadius = "4px";

                let themeColor = '#9ca3af'; // ê¸°ë³¸ íšŒìƒ‰ (31ìœ„~ / ë¯¸ì°¸ì—¬)
                let darkColor = '#4b5563'; // í…Œë‘ë¦¬ ìœ¤ê³½ì„ ìš© ì–´ë‘ìš´ ìƒ‰
                let glowColor = 'rgba(156, 163, 175, 0.5)'; // ê¸€ë¡œìš°

                // ë­í‚¹ ë¦¬ìŠ¤íŠ¸ì™€ ë™ì¼í•œ ìƒ‰ìƒ í…Œë§ˆ ë§¤í•‘
                if (rank <= 3) {
                    themeColor = '#0ea5e9'; // 1-3ìœ„: Sky Blue
                    darkColor = '#0369a1';
                    glowColor = 'rgba(14, 165, 233, 0.8)';
                } else if (rank <= 10) {
                    themeColor = '#2dd4bf'; // 4-10ìœ„: Teal
                    darkColor = '#0f766e';
                    glowColor = 'rgba(45, 212, 191, 0.7)';
                } else if (rank <= 20) {
                    themeColor = '#fbbf24'; // 11-20ìœ„: Amber
                    darkColor = '#b45309';
                    glowColor = 'rgba(251, 191, 36, 0.7)';
                } else if (rank <= 30) {
                    themeColor = '#94a3b8'; // 21-30ìœ„: Slate
                    darkColor = '#475569';
                    glowColor = 'rgba(148, 163, 184, 0.6)';
                }

                // LOL ìŠ¤íƒ€ì¼ í”„ë ˆì„ íš¨ê³¼ (Box-shadow Layering)
                imgContainer.style.border = `3px solid ${themeColor}`;
                
                if (rank <= 3) {
                    // 1-3ìœ„ (ìµœìƒìœ„ê¶Œ): í™”ë ¤í•œ ì´ì¤‘ í”„ë ˆì„, ê°•í•œ ê¸€ë¡œìš°, ëŒ€ê°ì„  ì»·íŒ…
                    imgContainer.style.borderRadius = "2px 20px 2px 20px";
                    imgContainer.style.boxShadow = `
                        inset 0 0 0 1px ${darkColor}, 
                        inset 0 0 0 2px rgba(255,255,255,0.9), 
                        inset 0 0 20px ${themeColor}, 
                        0 0 0 2px ${darkColor}, 
                        0 0 30px 2px ${glowColor}
                    `;
                } else if (rank <= 10) {
                    // 4-10ìœ„: ë‚ ì¹´ë¡œìš´ ëª¨ì„œë¦¬, ì ë‹¹í•œ ê¹Šì´ê°
                    imgContainer.style.borderRadius = "2px";
                    imgContainer.style.boxShadow = `
                        inset 0 0 0 1px ${darkColor}, 
                        inset 0 0 0 2px rgba(255,255,255,0.6), 
                        0 0 0 1px ${darkColor}, 
                        0 0 15px ${glowColor}
                    `;
                } else {
                    // 11ìœ„ ì´í•˜: ê¸°ë³¸ í”„ë ˆì„, ì€ì€í•œ íš¨ê³¼
                    imgContainer.style.borderRadius = "4px";
                    imgContainer.style.boxShadow = `
                        inset 0 0 0 1px rgba(255,255,255,0.4), 
                        0 0 0 1px ${darkColor}, 
                        0 0 10px ${glowColor}
                    `;
                }

                // ì´ë¯¸ì§€ í¸ì§‘ ëª¨ë‹¬ ì—´ê¸° ì´ë²¤íŠ¸ ì—°ê²°
                imgContainer.onclick = function(e) {
                    e.stopPropagation();
                    e.preventDefault();
                    openImageEditModal(playerId);
                };
            }

            const wins = player.wins || 0; const losses = player.losses || 0; const total = wins + losses; const rate = total > 0 ? ((wins / total) * 100).toFixed(1) : 0; 
            if (recordEl) recordEl.textContent = `${wins}ìŠ¹ ${losses}íŒ¨`; 
            if (winRateEl) winRateEl.textContent = `${rate}%`;
            
            // --- íƒœê·¸ & ë©”ëª¨ ë¡œì§ ---
            const renderTags = () => {
                if (!tagsEl) return;
                const tags = player.tags || [];
                if (tags.length === 0) {
                    tagsEl.innerHTML = '<span class="tag-empty">+ ìŠ¤íƒ€ì¼ íƒœê·¸ ì¶”ê°€</span>';
                } else {
                    tagsEl.innerHTML = tags.map(tag => `<span class="tag-badge">#${tag}</span>`).join('');
                }
            };
            renderTags();
            
            if (tagsEl) {
                tagsEl.onclick = () => {
                    openTagSelectionModal(player.id);
                };
            }

            if (memoEl) {
                memoEl.value = player.adminMemo || '';
                // ê¸°ì¡´ ë¦¬ìŠ¤ë„ˆ ì œê±°ë¥¼ ìœ„í•´ cloneNode ì‚¬ìš©
                const newMemoEl = memoEl.cloneNode(true);
                memoEl.parentNode.replaceChild(newMemoEl, memoEl);
                
                newMemoEl.addEventListener('blur', () => {
                    const newVal = newMemoEl.value.trim();
                    if (player.adminMemo !== newVal) {
                        player.adminMemo = newVal;
                        saveRankings();
                    }
                });
            }

            // --- ìƒì„± ë¶„ì„ & ìƒì„¸ ë¡œê·¸ ë¡œì§ ---
            const opponentStats = {}; let recentMatches = [];
            if (matchHistoryData) {
                matchHistoryData.forEach(m => {
                    const s = m.season || "ì‹œì¦Œ 1"; if (s !== viewSeason) return; if (m.type === 'friendly') return; 
                    let opponent = null; let isPlayerWin = false;
                    if (m.winner === player.name) { opponent = m.loser; isPlayerWin = true; } else if (m.loser === player.name) { opponent = m.winner; isPlayerWin = false; }
                    if (opponent) {
                        if (!opponentStats[opponent]) opponentStats[opponent] = { w: 0, l: 0, total: 0 };
                        opponentStats[opponent].total++; if (isPlayerWin) opponentStats[opponent].w++; else opponentStats[opponent].l++;
                        recentMatches.push({ opponent: opponent, result: isPlayerWin ? 'WIN' : 'LOSS', date: m.date });
                    }
                });
            }
            let matzip = { name: '-', w: 0, l: 0, diff: -999 }; let cheonjeok = { name: '-', w: 0, l: 0, diff: -999 }; let rival = { name: '-', w: 0, l: 0, total: 0 }; 
            Object.entries(opponentStats).forEach(([name, stat]) => {
                const winDiff = stat.w - stat.l;
                if (winDiff >= 2) { 
                    if (stat.w > matzip.w) { matzip = { name, ...stat, diff: winDiff }; } 
                    else if (stat.w === matzip.w && winDiff > matzip.diff) { matzip = { name, ...stat, diff: winDiff }; } 
                }
                const lossDiff = stat.l - stat.w;
                if (lossDiff >= 2) { 
                    if (stat.l > cheonjeok.l) { cheonjeok = { name, ...stat, diff: lossDiff }; } 
                    else if (stat.l === cheonjeok.l && lossDiff > cheonjeok.diff) { cheonjeok = { name, ...stat, diff: lossDiff }; } 
                }
                const diff = Math.abs(stat.w - stat.l); if (diff <= 1 && stat.total >= 2) { if (stat.total > rival.total) { rival = { name, ...stat }; } }
            });
            let analysisHtml = '';
            if (matzip.name !== '-') analysisHtml += `<div class="matchup-item"><span class="matchup-label text-blue-500">ğŸ ë³´ë„ˆìŠ¤</span><span class="matchup-name">${matzip.name}</span><span class="matchup-score">${matzip.w}ìŠ¹ ${matzip.l}íŒ¨</span></div>`; else analysisHtml += `<div class="matchup-item opacity-50"><span class="matchup-label text-gray-400">ğŸ ë³´ë„ˆìŠ¤</span><span class="matchup-name text-gray-400 font-normal">ë°ì´í„° ë¶€ì¡±</span></div>`;
            if (cheonjeok.name !== '-') analysisHtml += `<div class="matchup-item"><span class="matchup-label text-red-500">ğŸ§± í†µê³¡ì˜ ë²½</span><span class="matchup-name">${cheonjeok.name}</span><span class="matchup-score">${cheonjeok.w}ìŠ¹ ${cheonjeok.l}íŒ¨</span></div>`; else analysisHtml += `<div class="matchup-item opacity-50"><span class="matchup-label text-gray-400">ğŸ§± í†µê³¡ì˜ ë²½</span><span class="matchup-name text-gray-400 font-normal">ë°ì´í„° ë¶€ì¡±</span></div>`;
            if (rival.name !== '-') analysisHtml += `<div class="matchup-item"><span class="matchup-label text-purple-500">ğŸ¥Š ë¼ì´ë²Œ</span><span class="matchup-name">${rival.name}</span><span class="matchup-score">${rival.w}ìŠ¹ ${rival.l}íŒ¨</span></div>`; else analysisHtml += `<div class="matchup-item opacity-50"><span class="matchup-label text-gray-400">ğŸ¥Š ë¼ì´ë²Œ</span><span class="matchup-name text-gray-400 font-normal">ë°ì´í„° ë¶€ì¡±</span></div>`;
            if (analysisEl) analysisEl.innerHTML = analysisHtml;
            let logHtml = ''; if (recentMatches.length === 0) { logHtml = '<div class="text-center text-gray-400 italic py-2 text-xs">ê²½ê¸° ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>'; } else { recentMatches.forEach(match => { const badgeClass = match.result === 'WIN' ? 'win' : 'loss'; const badgeText = match.result === 'WIN' ? 'ìŠ¹ë¦¬' : 'íŒ¨ë°°'; logHtml += ` <div class="profile-log-item"> <div class="flex items-center flex-grow overflow-hidden"> <span class="log-badge ${badgeClass} flex-shrink-0">${badgeText}</span> <span class="text-gray-400 text-[10px] mr-1 flex-shrink-0">vs</span> <span class="log-vs-name">${match.opponent}</span> </div> <span class="log-date flex-shrink-0">${match.date}</span> </div> `; }); } if (logContainerEl) logContainerEl.innerHTML = logHtml;
            
            // Reset to default tab
            if (window.switchProfileTab) window.switchProfileTab('info');
            
            if (modal) modal.classList.remove('hidden');
        }
        window.openProfileModal = openProfileModal; 
        function closeProfileModal() { document.getElementById('profileModal').classList.add('hidden'); }
        window.closeProfileModal = closeProfileModal;
        
        // --- Profile Tabs Function ---
        function switchProfileTab(tabName) {
            // Reset all tabs
            ['Info', 'History', 'Memo'].forEach(t => {
                const btn = document.getElementById(`btnProfileTab${t}`);
                const content = document.getElementById(`tabProfile${t}`);
                if(btn && content) {
                    btn.className = "flex-1 py-2 text-sm font-medium text-gray-400 border-b-2 border-transparent hover:text-gray-600 transition-colors";
                    content.classList.add('hidden');
                }
            });

            // Set active tab
            const target = tabName.charAt(0).toUpperCase() + tabName.slice(1);
            const activeBtn = document.getElementById(`btnProfileTab${target}`);
            const activeContent = document.getElementById(`tabProfile${target}`);
            
            if(activeBtn && activeContent) {
                activeBtn.className = "flex-1 py-2 text-sm font-bold text-blue-600 border-b-2 border-blue-500 transition-colors";
                activeContent.classList.remove('hidden');
            }
        }
        window.switchProfileTab = switchProfileTab;
        
        // --- Image Edit Modal Functions ---
        function openImageEditModal(playerId) {
            currentEditingPlayerId = playerId;
            const player = rankingsData.find(p => p.id === playerId);
            if (!player) return;
            
            const modal = document.getElementById('imageEditModal');
            const input = document.getElementById('newImageUrlInput');
            
            if (modal && input) {
                input.value = player.imageUrl || '';
                modal.classList.remove('hidden');
                input.focus();
            }
        }
        window.openImageEditModal = openImageEditModal;

        function closeImageEditModal() {
            document.getElementById('imageEditModal')?.classList.add('hidden');
            currentEditingPlayerId = null;
        }
        window.closeImageEditModal = closeImageEditModal;

        function saveProfileImage() {
            if (!currentEditingPlayerId) return;
            const input = document.getElementById('newImageUrlInput');
            const url = input.value.trim();
            
            const playerIndex = rankingsData.findIndex(p => p.id === currentEditingPlayerId);
            if (playerIndex > -1) {
                rankingsData[playerIndex].imageUrl = url;
                saveRankings();
                
                // Update profile modal image immediately if open
                const imgEl = document.getElementById('profileImage');
                if (imgEl) {
                    if (url) {
                        imgEl.src = url;
                        imgEl.classList.remove('p-4');
                    } else {
                        imgEl.src = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%239ca3af' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2'/%3E%3Ccircle cx='12' cy='7' r='4'/%3E%3C/svg%3E";
                        imgEl.classList.add('p-4');
                    }
                }
            }
            closeImageEditModal();
        }
        window.saveProfileImage = saveProfileImage;

        function renderRankings() { 
            const listContainer = document.getElementById('rankingList'); 
            if (!listContainer) return; 
            listContainer.innerHTML = ''; 
            const previousRankMap = new Map(); 
            previousRankingsData.forEach((item) => { previousRankMap.set(item.id, item.previousRank); }); 
            const allCounts = rankingsData.map(item => item.defenseCount || 0); 
            const maxDefenseCount = allCounts.length > 0 ? Math.max(...allCounts) : 0; 
            const now = Date.now(); 

            rankingsData.forEach((item, index) => { 
                const currentRank = index + 1; 
                let changeDisplay = 'â€”'; 
                let changeColorClass = 'text-gray-500 font-semibold'; 
                const previousRank = previousRankMap.get(item.id); 
                if (previousRank !== undefined) { 
                    const rankChange = previousRank - currentRank; 
                    if (rankChange > 0) { changeDisplay = `+${rankChange}`; changeColorClass = 'text-red-500 font-bold'; } 
                    else if (rankChange < 0) { changeDisplay = `${rankChange}`; changeColorClass = 'text-blue-500 font-bold'; } 
                } 
                
                let nameColorClass = 'text-gray-800'; let nameStyleClass = 'font-semibold not-italic'; let rowOpacity = '1'; let nameDecoration = 'none'; let winColorClass = 'text-gray-900'; let lossColorClass = 'text-gray-900'; 
                if (!item.isParticipating) { nameColorClass = 'text-gray-400'; nameStyleClass = 'font-normal not-italic'; rowOpacity = '0.7'; nameDecoration = 'line-through'; winColorClass = 'text-gray-400'; lossColorClass = 'text-gray-400'; } 

                let rankSymbol = ''; if (currentRank === 1) rankSymbol = 'ğŸ¥‡'; else if (currentRank === 2) rankSymbol = 'ğŸ¥ˆ'; else if (currentRank === 3) rankSymbol = 'ğŸ¥‰'; 
                let defenseSymbol = ''; const currentDefenseCount = item.defenseCount || 0; 
                if (maxDefenseCount > 0 && currentDefenseCount >= maxDefenseCount && currentDefenseCount > 0) { defenseSymbol = 'ğŸ–ï¸'; } else if (currentDefenseCount >= 5) { defenseSymbol = 'ğŸ›¡ï¸'; } 
                let noteColorClass = 'text-gray-500'; if (defenseSymbol === 'ğŸ–ï¸') { noteColorClass = 'text-amber-600 font-bold'; } else if (currentRank <= 3 && item.notes && item.notes.includes('S ë°©ì–´ì „')) { noteColorClass = 'text-sky-600 font-bold'; } else if (item.notes && item.notes.includes('ë°©ì–´ì „')) { noteColorClass = 'text-gray-800 font-bold'; } 

                const isNewEntry = item.entryTime && (now - item.entryTime < 24 * 60 * 60 * 1000); 
                let newBadgeHtml = ''; let nameInputPadding = 'pl-3';
                if (isNewEntry) { newBadgeHtml = `<span class="absolute right-1 top-1/2 transform -translate-y-1/2 text-[10px] bg-rose-100 text-rose-600 font-bold px-1.5 py-0.5 rounded border border-rose-200 animate-pulse pointer-events-none select-none">NEW</span>`; nameInputPadding = 'pl-3 pr-10'; }

                let rowBg = ''; let borderLeftColor = ''; let borderLeftWidth = '4px'; let customShadow = ''; let customTransform = ''; let customMargin = 'my-1.5';
                if (currentRank <= 3) { rowBg = '#e0f2fe'; borderLeftColor = '#0ea5e9'; borderLeftWidth = '8px'; customShadow = '0 10px 15px -3px rgba(14, 165, 233, 0.3), 0 4px 6px -2px rgba(14, 165, 233, 0.1)'; customTransform = 'scale(1.015)'; customMargin = 'my-3'; } else if (currentRank <= 10) { rowBg = '#f0fdfa'; borderLeftColor = '#2dd4bf'; } else if (currentRank <= 20) { rowBg = '#fffbeb'; borderLeftColor = '#fbbf24'; } else if (currentRank <= 30) { rowBg = '#f8fafc'; borderLeftColor = '#94a3b8'; } else { rowBg = '#ffffff'; borderLeftColor = '#d1d5db'; }
                
                const listItem = document.createElement('div'); 
                listItem.className = `rank-item flex items-center p-2.5 ${customMargin} rounded-xl shadow hover:shadow-lg transition-all duration-200`; 
                listItem.style.background = rowBg; listItem.style.borderLeft = `${borderLeftWidth} solid ${borderLeftColor}`; listItem.style.opacity = rowOpacity;
                if (customShadow) listItem.style.boxShadow = customShadow; if (customTransform) { listItem.style.transform = customTransform; listItem.style.zIndex = '10'; }
                if (currentRank <= 3) { listItem.dataset.rank = currentRank; } listItem.draggable = true; listItem.dataset.id = item.id; 
                listItem.addEventListener('dragstart', handleDragStart); listItem.addEventListener('dragover', handleDragOver); listItem.addEventListener('dragenter', handleDragEnter); listItem.addEventListener('dragleave', handleDragLeave); listItem.addEventListener('drop', handleDrop); listItem.addEventListener('dragend', handleDragEnd); 

                let displayRankText = currentRank; let displayRankColor = ""; 
                if (!item.isParticipating) { displayRankColor = "text-gray-400"; } else if (currentRank <= 3) { displayRankColor = "text-sky-600"; } else if (currentRank <= 10) { displayRankColor = "text-teal-500"; } else if (currentRank <= 20) { displayRankColor = "text-yellow-600"; } else if (currentRank <= 30) { displayRankColor = "text-slate-500"; } else { displayRankColor = "text-gray-500"; }

                const wins = item.wins || 0; const losses = item.losses || 0; const totalMatches = wins + losses; let winPct = 0; let winPctDisplay = "0%"; 
                if (totalMatches > 0) { winPct = ((item.wins || 0) / totalMatches) * 100; if (Number.isInteger(winPct)) { winPctDisplay = winPct.toFixed(0) + "%"; } else { winPctDisplay = winPct.toFixed(1) + "%"; } } 

                const recentResults = item.recentMatchResults || [0,0,0,0,0,0];
                let currentStreak = 0; let currentStreakType = 0; 
                for (let i = recentResults.length - 1; i >= 0; i--) { const val = recentResults[i]; if (val === 0) break; if (currentStreakType === 0) { currentStreakType = val; currentStreak = 1; } else { if (val === currentStreakType) { currentStreak++; } else { break; } } }

                let streakStyleClass = "px-1"; let streakTooltip = "(ìµœê·¼6)";
                if (currentStreak >= 3) { if (currentStreakType === 1) { streakTooltip = `ğŸ”¥${currentStreak}`; } else if (currentStreakType === 2) { streakTooltip = `â„ï¸${currentStreak}`; } }

                let recentHtml = '';
                recentResults.forEach((val, i) => { let colorClass = 'bg-gray-200'; if (val === 1) colorClass = 'bg-red-500'; else if (val === 2) colorClass = 'bg-blue-500'; recentHtml += `<div class="w-2 h-2 rounded-full ${colorClass} mr-0.5 recent-dot" data-player-id="${item.id}" data-dot-index="${i}" title="í´ë¦­í•˜ì—¬ ìƒíƒœ ë³€ê²½"></div>`; });
                let tooltipClass = "text-gray-400 text-[9px]";
                if (currentStreak >= 3) { if (currentStreakType === 1) tooltipClass = "text-red-500 font-black text-xs animate-pulse ml-1 transform scale-110 inline-block"; else if (currentStreakType === 2) tooltipClass = "text-blue-500 font-black text-xs ml-1 transform scale-110 inline-block"; } else { tooltipClass += " ml-1 tracking-tight whitespace-nowrap hidden sm:inline"; }

                recentHtml += `<span class="${tooltipClass} transition-all duration-300">${streakTooltip}</span>`;
                const dotsContainer = `<div class="flex justify-start items-center h-4 w-full transition-all duration-300 ${streakStyleClass}">${recentHtml}</div>`;

                listItem.innerHTML = ` <div class="rank-number text-3xl ${displayRankColor} mr-1" style="width: 3.5rem;" onclick="openProfileModal('${item.id}')" title="í´ë¦­í•˜ì—¬ í”„ë¡œí•„ ë³´ê¸°">${displayRankText}</div> <div class="w-12 text-center text-2xl mr-1 flex justify-center items-center space-x-1"> <span class="text-2xl">${rankSymbol}</span> <span class="text-2xl">${defenseSymbol}</span> </div> <div class="w-[29%] mr-1 relative"> <input type="text" data-id="${item.id}" data-field="name" value="${item.name}" placeholder="ë‹‰ë„¤ì„ ì…ë ¥..." class="name-input text-lg ${nameStyleClass} ${nameColorClass} transition duration-100 note-input text-left ${nameInputPadding}" style="width: 100%; text-decoration: ${nameDecoration};"> ${newBadgeHtml} </div> <div class="flex flex-col justify-center items-center w-[15%]"> <div class="flex items-center justify-center space-x-0.5 mb-1 w-full"> <input type="number" data-id="${item.id}" data-type="win" value="${wins}" class="win-loss-input ${winColorClass} font-bold text-center w-5 sm:w-6 p-0 text-sm" title="ìŠ¹" min="0"> <span class="text-gray-400 text-xs font-light">-</span> <input type="number" data-id="${item.id}" data-type="loss" value="${losses}" class="win-loss-input ${lossColorClass} font-bold text-center w-5 sm:w-6 p-0 text-sm" title="íŒ¨" min="0"> <span class="text-[10px] text-gray-500 font-semibold ml-1 whitespace-nowrap">(${winPctDisplay})</span> </div> ${dotsContainer} </div> <input type="text" data-id="${item.id}" data-field="change" value="${changeDisplay}" placeholder="ë³€ë™" class="change-input w-[12%] text-lg ${changeColorClass} transition duration-100 note-input" style="min-width: 30px; text-align: center;"> <input type="text" data-id="${item.id}" data-field="notes" value="${item.notes || ''}" placeholder="ë°©ì–´ì „ ì…ë ¥..." class="note-input text-sm ${noteColorClass} w-[16%] text-center transition duration-100" style="min-width: 60px;"> <div class="w-8 text-center flex justify-center items-center ml-auto"> <input type="checkbox" data-id="${item.id}" data-field="isParticipating" class="h-5 w-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500 cursor-pointer" ${item.isParticipating ? 'checked' : ''}> </div> `; 
        
                listItem.querySelectorAll('.recent-dot').forEach(dot => { dot.addEventListener('click', (e) => { handleDotClick(e, dot.dataset.playerId, parseInt(dot.dataset.dotIndex)); }); dot.addEventListener('mousedown', (e) => e.stopPropagation()); });
                const nameInput = listItem.querySelector('[data-field="name"]'); const changeInput = listItem.querySelector('[data-field="change"]'); const noteInput = listItem.querySelector('[data-field="notes"]'); const participationInput = listItem.querySelector('[data-field="isParticipating"]'); const winInput = listItem.querySelector('input[data-type="win"]'); const lossInput = listItem.querySelector('input[data-type="loss"]'); if (nameInput) { nameInput.addEventListener('change', handleNameChange); nameInput.addEventListener('click', (e) => e.stopPropagation()); nameInput.addEventListener('mousedown', (e) => e.stopPropagation()); nameInput.addEventListener('focus', () => listItem.draggable = false); nameInput.addEventListener('blur', () => listItem.draggable = true); } if (changeInput) { changeInput.addEventListener('change', handleChangeChange); changeInput.addEventListener('click', (e) => e.stopPropagation()); changeInput.addEventListener('mousedown', (e) => e.stopPropagation()); changeInput.addEventListener('focus', () => listItem.draggable = false); changeInput.addEventListener('blur', () => listItem.draggable = true); } if (noteInput) { noteInput.addEventListener('change', handleNoteChange); noteInput.addEventListener('click', (e) => e.stopPropagation()); noteInput.addEventListener('mousedown', (e) => e.stopPropagation()); noteInput.addEventListener('focus', () => listItem.draggable = false); noteInput.addEventListener('blur', () => listItem.draggable = true); } if (winInput) { winInput.addEventListener('change', handleWinLossChange); winInput.addEventListener('click', (e) => e.stopPropagation()); winInput.addEventListener('mousedown', (e) => e.stopPropagation()); winInput.addEventListener('focus', () => listItem.draggable = false); winInput.addEventListener('blur', () => listItem.draggable = true); } if (lossInput) { lossInput.addEventListener('change', handleWinLossChange); lossInput.addEventListener('click', (e) => e.stopPropagation()); lossInput.addEventListener('mousedown', (e) => e.stopPropagation()); lossInput.addEventListener('focus', () => listItem.draggable = false); lossInput.addEventListener('blur', () => listItem.draggable = true); } if (participationInput) { participationInput.addEventListener('change', handleParticipationChange); } listContainer.appendChild(listItem); 
            }); 
        }

        // --- Export Functions ---
        function exportToSpreadsheet(options = {}) { 
            const excludeParticipation = options.excludeParticipation || false; const excludeRecord = options.excludeRecord || false; const excludeRecent = options.excludeRecent || false; const delimiter = options.delimiter !== undefined ? options.delimiter : '\t';
            const dataRows = []; const previousRankMap = new Map(); previousRankingsData.forEach((item) => { previousRankMap.set(item.id, item.previousRank); }); const allCounts = rankingsData.map(item => item.defenseCount || 0); const maxDefenseCount = allCounts.length > 0 ? Math.max(...allCounts) : 0; const now = Date.now(); 
            let maxRankLen = getDisplayLength('ìˆœìœ„'); let maxRankSymbolLen = 0; let maxDefSymbolLen = 0; let maxNameLen = getDisplayLength('ë‹‰ë„¤ì„'); let maxRecordLen = excludeRecord ? 0 : getDisplayLength('ì „ì '); let maxRecentLen = excludeRecent ? 0 : getDisplayLength('ìµœê·¼'); let maxChangeLen = getDisplayLength('ë³€ë™'); let maxNotesLen = getDisplayLength('ë°©ì–´ì „'); let maxParticipatingLen = excludeParticipation ? 0 : getDisplayLength('ì°¸ì—¬'); 
            rankingsData.forEach((item, index) => { 
                const currentRank = index + 1; const previousRank = previousRankMap.get(item.id); let rankChange = 0; let changeDisplay = '-'; if (previousRank !== undefined) { rankChange = previousRank - currentRank; if (rankChange > 0) changeDisplay = `+${rankChange}`; else if (rankChange < 0) changeDisplay = `${rankChange}`; } 
                const rankSymbol = (currentRank === 1 ? 'ğŸ¥‡' : currentRank === 2 ? 'ğŸ¥ˆ' : currentRank === 3 ? 'ğŸ¥‰' : ''); let defenseSymbol = ''; const currentDefenseCount = item.defenseCount || 0; if (maxDefenseCount > 0 && currentDefenseCount >= maxDefenseCount && currentDefenseCount > 0) { defenseSymbol = 'ğŸ–ï¸'; } else if (currentDefenseCount >= 5) { defenseSymbol = 'ğŸ›¡ï¸'; } 
                maxRankSymbolLen = Math.max(maxRankSymbolLen, getDisplayLength(rankSymbol)); maxDefSymbolLen = Math.max(maxDefSymbolLen, getDisplayLength(defenseSymbol));
                let nameForExport = item.name; if (item.entryTime && (now - item.entryTime < 24 * 60 * 60 * 1000)) { nameForExport += " [NEW]"; }
                const notes = item.notes || '-'; const participationStatus = item.isParticipating ? 'O' : 'X'; const recordStr = `${item.wins || 0}ìŠ¹ ${item.losses || 0}íŒ¨`; let displayRankStr = String(currentRank); 
                const recentResults = item.recentMatchResults || [0,0,0,0,0,0]; const recentStr = recentResults.map(r => r === 1 ? 'W' : (r === 2 ? 'L' : '-')).join('');
                maxRankLen = Math.max(maxRankLen, getDisplayLength(displayRankStr)); maxNameLen = Math.max(maxNameLen, getDisplayLength(nameForExport)); if (!excludeRecord) maxRecordLen = Math.max(maxRecordLen, getDisplayLength(recordStr)); if (!excludeRecent) maxRecentLen = Math.max(maxRecentLen, getDisplayLength(recentStr)); maxChangeLen = Math.max(maxChangeLen, getDisplayLength(changeDisplay)); maxNotesLen = Math.max(maxNotesLen, getDisplayLength(notes)); if (!excludeParticipation) maxParticipatingLen = Math.max(maxParticipatingLen, getDisplayLength(participationStatus)); 
                dataRows.push({ rank: displayRankStr, rankSymbol: rankSymbol, defSymbol: defenseSymbol, name: nameForExport, record: recordStr, recent: recentStr, change: changeDisplay, notes: notes, participation: participationStatus }); 
            }); 
            if (maxRankSymbolLen > 0) maxRankSymbolLen = Math.max(maxRankSymbolLen, 2); if (maxDefSymbolLen > 0) maxDefSymbolLen = Math.max(maxDefSymbolLen, 2); const totalSymbolLen = maxRankSymbolLen + maxDefSymbolLen; const finalSymbolColLen = totalSymbolLen + (totalSymbolLen > 0 ? 1 : 0); 
            maxRankLen += 1; maxNameLen += 2; maxChangeLen += 1; maxNotesLen += 1; if (!excludeRecent) maxRecentLen += 1; if (!excludeRecord) maxRecordLen += 1; if (!excludeParticipation) maxParticipatingLen += 1; 
            const headerParts = [ padStringLeft('ìˆœìœ„', maxRankLen), padString('', finalSymbolColLen), padString('ë‹‰ë„¤ì„', maxNameLen) ]; if (!excludeRecord) headerParts.push(padString('ì „ì ', maxRecordLen)); if (!excludeRecent) headerParts.push(padString('ìµœê·¼', maxRecentLen)); headerParts.push(padString('ë³€ë™', maxChangeLen)); headerParts.push(padString('ë°©ì–´ì „', maxNotesLen)); if (!excludeParticipation) headerParts.push(padString('ì°¸ì—¬', maxParticipatingLen)); 
            let output = headerParts.join(delimiter) + '\n'; 
            dataRows.forEach(row => { const pRankSym = padString(row.rankSymbol, maxRankSymbolLen); const pDefSym = padString(row.defSymbol, maxDefSymbolLen); const combinedSymbol = pRankSym + pDefSym; const lineParts = [ padStringLeft(row.rank, maxRankLen), padString(combinedSymbol, finalSymbolColLen), padString(row.name, maxNameLen) ]; if (!excludeRecord) lineParts.push(padString(row.record, maxRecordLen)); if (!excludeRecent) lineParts.push(padString(row.recent, maxRecentLen)); lineParts.push(padString(row.change, maxChangeLen)); lineParts.push(padString(row.notes, maxNotesLen)); if (!excludeParticipation) lineParts.push(padString(row.participation, maxParticipatingLen)); output += lineParts.join(delimiter) + '\n'; }); 
            return output; 
        }

        function generateSeedDataCode() { const cleanData = rankingsData.map(item => ({ name: item.name, notes: item.notes, previousRank: item.previousRank, isParticipating: item.isParticipating, wins: item.wins || 0, losses: item.losses || 0, recentMatchResults: item.recentMatchResults })); return `const structuredSeedData = ${JSON.stringify(cleanData, null, 4)};`; }
        function showExportModal() { 
            const modal = document.getElementById('exportModal'); const modalContent = document.getElementById('exportContent'); const copyButton = document.getElementById('copyButton'); const formatSelect = document.getElementById('exportFormatSelect'); const exportHint = document.getElementById('exportHint'); if (!modal || !modalContent || !copyButton || !formatSelect || !exportHint) return; 
            formatSelect.onchange = () => { const selectedFormat = formatSelect.value; exportHint.innerHTML = ''; modalContent.readOnly = true; if (selectedFormat === 'fixed_mobile_no_participation') { modalContent.value = exportToSpreadsheet({ excludeParticipation: true, delimiter: '\t' }); modalContent.classList.add('font-mono'); modalContent.classList.remove('font-sans'); exportHint.innerHTML = '<span class="text-red-500 font-semibold">PCë©”ëª¨ì¥ í˜•ì‹ (ì°¸ì—¬ ì œì™¸):</span> íƒ­ìœ¼ë¡œ ì •ë ¬ë©ë‹ˆë‹¤.'; } else if (selectedFormat === 'fixed_simple') { modalContent.value = exportToSpreadsheet({ excludeParticipation: true, excludeRecord: true, excludeRecent: true, delimiter: '\t' }); modalContent.classList.add('font-mono'); modalContent.classList.remove('font-sans'); exportHint.innerHTML = '<span class="text-green-600 font-semibold">PCë©”ëª¨ì¥ í˜•ì‹ (ì°¸ì—¬/ì „ì  ì œì™¸):</span> ìˆœìœ„, ë‹‰ë„¤ì„, ë³€ë™, ë°©ì–´ì „ë§Œ í‘œì‹œí•©ë‹ˆë‹¤. (íƒ­ ì •ë ¬)'; } else if (selectedFormat === 'simple_name_rank') { modalContent.value = rankingsData.slice(0, 30).map((item, index) => `${item.name}(${index + 1})`).join('\n'); modalContent.classList.add('font-mono'); modalContent.classList.remove('font-sans'); exportHint.innerHTML = '<span class="text-indigo-600 font-semibold">ê°„í¸ ê³µìœ  í˜•ì‹:</span> ì´ë¦„(ìˆœìœ„) í˜•íƒœë¡œ 30ìœ„ê¹Œì§€ ì¶œë ¥ë©ë‹ˆë‹¤.'; } else if (selectedFormat === 'seed_code') { modalContent.value = generateSeedDataCode(); modalContent.classList.add('font-mono'); exportHint.innerHTML = '<span class="text-purple-600 font-bold">ê°œë°œììš© ì½”ë“œ:</span> ì´ ì½”ë“œë¥¼ ë³µì‚¬í•˜ì—¬ HTML íŒŒì¼ ë‚´ì˜ <code>structuredSeedData</code> ë³€ìˆ˜ë¥¼ ë®ì–´ì“°ë©´, ì´ ìƒíƒœê°€ ì˜êµ¬ì ì¸ ì´ˆê¸°ê°’ì´ ë©ë‹ˆë‹¤.'; } else { modalContent.value = exportToSpreadsheet(); modalContent.classList.add('font-mono'); modalContent.classList.remove('font-sans'); exportHint.innerHTML = '<span class="text-blue-500 font-semibold">ìŠ¤í”„ë ˆë“œì‹œíŠ¸/PC ë©”ëª¨ì¥ìš©:</span> íƒ­ìœ¼ë¡œ êµ¬ë¶„ëœ í˜•ì‹ì…ë‹ˆë‹¤. (W:ìŠ¹, L:íŒ¨, -:ì—†ìŒ)'; } copyButton.textContent = 'ë‚´ìš© ë³µì‚¬'; modalContent.focus(); modalContent.select(); }; 
            formatSelect.value = 'fixed_simple'; formatSelect.onchange(); modal.classList.remove('hidden'); copyButton.onclick = () => { modalContent.select(); document.execCommand('copy'); copyButton.textContent = 'ë³µì‚¬ ì™„ë£Œ!'; setTimeout(() => { copyButton.textContent = 'ë‚´ìš© ë³µì‚¬'; }, 2000); }; 
        }
        function hideExportModal() { const modal = document.getElementById('exportModal'); if (modal) modal.classList.add('hidden'); }
        
        // --- Printing & Image Functions ---
        function generatePrintableRankingsHtml(startIdx = 0, endIdx = rankingsData.length) { 
            let dateString = ""; if (currentRankingDate) { const [y, m, d] = currentRankingDate.split('-'); dateString = `${y}ë…„ ${m}ì›” ${d}ì¼`; } else { const today = new Date(); dateString = `${today.getFullYear()}ë…„ ${(today.getMonth() + 1).toString().padStart(2, '0')}ì›” ${today.getDate().toString().padStart(2, '0')}ì¼`; } 
            const headerHeight = "40px"; const headerStyle = `height: ${headerHeight}; line-height: ${headerHeight}; font-size: 16px; font-weight: 700; color: #6b7280; display: block; overflow: hidden; white-space: nowrap;`;
            let html = ` <div class="print-header flex items-center px-3 border-b border-gray-300 mb-0.5" style="height: ${headerHeight}; box-sizing: border-box;"> <div style="width: 3.5rem; text-align: center; ${headerStyle}" class="mr-1">ìˆœìœ„</div> <div style="width: 3rem; text-align: center; ${headerStyle}" class="mr-1"></div> <div style="width: 29%; text-align: left; padding-left: 36px; ${headerStyle}">ë‹‰ë„¤ì„</div> <div style="width: 15%; text-align: center; ${headerStyle}">ì „ì </div> <div style="width: 12%; text-align: center; ${headerStyle}">ë³€ë™</div> <div style="width: 16%; text-align: center; ${headerStyle}">ë°©ì–´ì „</div> <div style="width: 2rem; text-align: center; ${headerStyle}">ì°¸ì—¬</div> </div> `; 
            const previousRankMap = new Map(); previousRankingsData.forEach((item) => { previousRankMap.set(item.id, item.previousRank); }); const allCounts = rankingsData.map(item => item.defenseCount || 0); const maxDefenseCount = allCounts.length > 0 ? Math.max(...allCounts) : 0; const sliceData = rankingsData.slice(startIdx, endIdx); const now = Date.now(); 
            sliceData.forEach((item, index) => { 
                const currentRank = startIdx + index + 1; const previousRank = previousRankMap.get(item.id); let rankChange = 0; let changeDisplay = 'â€”'; let changeColor = '#6b7280'; if (previousRank !== undefined) { const rankChange = previousRank - currentRank; if (rankChange > 0) { changeDisplay = `+${rankChange}`; changeColor = '#dc2626'; } else if (rankChange < 0) { changeDisplay = `${rankChange}`; changeColor = '#3b82f6'; } } 
                let rankSymbol = ''; if (currentRank === 1) rankSymbol = 'ğŸ¥‡'; else if (currentRank === 2) rankSymbol = 'ğŸ¥ˆ'; else if (currentRank === 3) rankSymbol = 'ğŸ¥‰'; 
                let defenseSymbol = ''; const currentDefenseCount = item.defenseCount || 0; if (maxDefenseCount > 0 && currentDefenseCount >= maxDefenseCount && currentDefenseCount > 0) { defenseSymbol = 'ğŸ–ï¸'; } else if (currentDefenseCount >= 5) { defenseSymbol = 'ğŸ›¡ï¸'; } 
                let participationMarkHtml = item.isParticipating ? '<span style="color: #10b981; font-weight: 700;">O</span>' : '<span style="color: #9ca3af; font-weight: 500;">X</span>'; let nameStyle = item.isParticipating ? 'color: #1f2937; font-weight: 600;' : 'color: #9ca3af; font-weight: 500; opacity: 0.7; text-decoration: line-through;'; 
                let noteStyle = 'color: #6b7280; font-weight: 600;'; if (defenseSymbol === 'ğŸ–ï¸') { noteStyle = 'color: #d97706; font-weight: 700;'; } else if (currentRank <= 3 && item.notes && item.notes.includes('S ë°©ì–´ì „')) { noteStyle = 'color: #0284c7; font-weight: 700;'; } else if (item.notes && item.notes.includes('ë°©ì–´ì „')) { noteStyle = 'color: #1f2937; font-weight: 700;'; } 
                const isNewEntry = item.entryTime && (now - item.entryTime < 24 * 60 * 60 * 1000); let newBadgeHtml = ''; if (isNewEntry) { newBadgeHtml = `<span style="display: inline-block; font-size: 10px; line-height: 1; color: #e11d48; font-weight: 900; margin-left: 4px; vertical-align: middle;">NEW</span>`; }
                let rowBg = '#ffffff'; let borderLeftColor = '#d1d5db'; let borderLeftWidth = '4px'; let boxShadow = 'none'; let zIndex = 'auto'; let transform = 'none'; let marginY = '4px'; 
                if (currentRank <= 3) { rowBg = '#e0f2fe'; borderLeftColor = '#0ea5e9'; borderLeftWidth = '8px'; boxShadow = '0 4px 6px -1px rgba(0, 0, 0, 0.1)'; zIndex = 'auto'; transform = 'none'; marginY = '4px'; } else if (currentRank <= 10) { rowBg = '#f0fdfa'; borderLeftColor = '#2dd4bf'; } else if (currentRank <= 20) { rowBg = '#fffbeb'; borderLeftColor = '#fbbf24'; } else if (currentRank <= 30) { rowBg = '#f8fafc'; borderLeftColor = '#94a3b8'; }
                let rankDisp = String(currentRank); let rankColor = ""; if (!item.isParticipating) { rankColor = "color: #9ca3af;"; } else if (currentRank <= 3) { rankColor = "color: #0284c7;"; } else if (currentRank <= 10) { rankColor = "color: #14b8a6;"; } else if (currentRank <= 20) { rankColor = "color: #ca8a04;"; } else if (currentRank <= 30) { rankColor = "color: #64748b;"; } else { rankColor = "color: #6b7280;"; }
                let recordWinColor = "#111827"; let recordLossColor = "#111827"; if (!item.isParticipating) { recordWinColor = "#9ca3af"; recordLossColor = "#9ca3af"; } 
                const totalMatches = (item.wins || 0) + (item.losses || 0); let winPct = 0; let lossPct = 0; let winPctDisplay = "0%"; if (totalMatches > 0) { winPct = ((item.wins || 0) / totalMatches) * 100; lossPct = ((item.losses || 0) / totalMatches) * 100; if (Number.isInteger(winPct)) { winPctDisplay = winPct.toFixed(0) + "%"; } else { winPctDisplay = winPct.toFixed(1) + "%"; } } 
                const recentResults = item.recentMatchResults || [0,0,0,0,0,0]; let currentStreak = 0; let currentStreakType = 0; for (let i = recentResults.length - 1; i >= 0; i--) { const val = recentResults[i]; if (val === 0) break; if (currentStreakType === 0) { currentStreakType = val; currentStreak = 1; } else { if (val === currentStreakType) { currentStreak++; } else { break; } } }
                let streakContainerStyle = "display: flex; justify-content: flex-start; align-items: center; height: 16px; width: 100%; padding: 0 4px; box-sizing: border-box; -webkit-print-color-adjust: exact; print-color-adjust: exact; white-space: nowrap; line-height: 1;";
                let streakTextStyle = "font-size: 9px; color: #9ca3af; margin-left: 4px; white-space: nowrap; letter-spacing: -0.5px; display: inline-block; transform: translateY(-2px);"; let streakText = "(ìµœê·¼6)";
                if (currentStreak >= 3) { if (currentStreakType === 1) { streakTextStyle = "font-size: 12px; color: #ef4444; font-weight: 900; margin-left: 4px; white-space: nowrap; transform: scale(1.1) translateY(-3px); display: inline-block;"; streakText = `ğŸ”¥${currentStreak}`; } else if (currentStreakType === 2) { streakTextStyle = "font-size: 12px; color: #3b82f6; font-weight: 900; margin-left: 4px; white-space: nowrap; transform: scale(1.1) translateY(-3px); display: inline-block;"; streakText = `â„ï¸${currentStreak}`; } }
                let recentDotsHtml = ''; recentResults.forEach(val => { let color = '#e5e7eb'; if (val === 1) color = '#ef4444'; else if (val === 2) color = '#3b82f6'; recentDotsHtml += `<div style="width: 8px; height: 8px; border-radius: 50%; background-color: ${color}; margin-right: 2px; flex-shrink: 0; -webkit-print-color-adjust: exact; print-color-adjust: exact; transform: translateY(2px);"></div>`; }); recentDotsHtml += `<span style="${streakTextStyle}">${streakText}</span>`;
                let recordHtml = `<div style="display:flex; justify-content:center; align-items:flex-end; margin-bottom: 8px; width: 100%; line-height: 1;"> <span style="color:${recordWinColor}; font-weight:800; font-size: 14px; line-height: 1;">${item.wins||0}</span> <span style="color:#9ca3af; font-size: 12px; font-weight: 400; margin: 0 2px; line-height: 1; position: relative; top: -1px;">-</span> <span style="color:${recordLossColor}; font-weight:800; font-size: 14px; line-height: 1;">${item.losses||0}</span> <span style="color:#6b7280; font-size: 11px; font-weight: 600; margin-left: 4px; line-height: 1; position: relative; top: 0px;">(${winPctDisplay})</span> </div>`; 
                let formHtml = `<div style="${streakContainerStyle}">${recentDotsHtml}</div>`; 
                html += ` <div class="flex items-start px-3" style="box-sizing: border-box; background: ${rowBg}; border-left: ${borderLeftWidth} solid ${borderLeftColor}; height: 64px; margin-top: ${marginY}; margin-bottom: ${marginY}; box-shadow: ${boxShadow}; z-index: ${zIndex}; transform: ${transform}; border-radius: 0.75rem;"> <div style="font-weight: 700; width: 3.5rem; height: 100%; box-sizing: border-box; padding-top: 17px; text-align: center; display: block; font-size: 25px; line-height: 1; ${rankColor}" class="mr-1">${rankDisp}</div> <div style="width: 3rem; height: 100%; display: flex; justify-content: center; align-items: center;" class="text-xl mr-1 space-x-1"> <span>${rankSymbol}</span> <span>${defenseSymbol}</span> </div> <div style="width: 29%; height: 100%; display: flex; align-items: center; padding-left: 1rem;"> <span style="${nameStyle} font-size: 16px; display: inline-block; line-height: 1.5;">${item.name}</span>${newBadgeHtml} </div> <div style="width: 15%; height: 100%; text-align: center; color: #4b5563; font-weight: 700; display:flex; flex-direction:column; justify-content:center; align-items: center;" class="text-sm"> ${recordHtml} ${formHtml} </div> <div style="width: 12%; height: 100%; display: flex; align-items: center; justify-content: center; color: ${changeColor}; font-weight: bold;" class="text-sm"> ${changeDisplay} </div> <div class="text-sm text-center" style="width: 16%; height: 100%; display: flex; align-items: center; justify-content: center; ${noteStyle} line-height: 1.2;">${item.notes || '-'}</div> <div style="width: 2rem; height: 100%; display: flex; justify-content: center; align-items: center;" class="text-sm font-bold text-gray-600">${participationMarkHtml}</div> </div> `; 
            }); 
            let titleText = "ğŸ† RFC ë­í‚¹ì „ ìˆœìœ„"; if (endIdx - startIdx < rankingsData.length) { const rangeEnd = Math.min(endIdx, rankingsData.length); titleText += ` (${startIdx + 1}~${rangeEnd}ìœ„)`; } 
            const titleHeight = "40px"; return ` <div class="p-2" style="background-color: #f9fafb; width: 100%;"> <div class="relative flex justify-center items-center border-b border-transparent mb-2" style="height: ${titleHeight}; box-sizing: border-box; padding-bottom: 0;"> <h1 class="text-xl font-bold text-gray-800 text-center" style="line-height: ${titleHeight}; margin: 0; display: inline-block;">${titleText}</h1> <span class="absolute right-0 text-sm font-normal text-gray-600 whitespace-nowrap" style="line-height: ${titleHeight}; top: 0; display: inline-block;">(${dateString} ê¸°ì¤€)</span> </div> ${html} </div> `; 
        }

        function showPrintPreview() { 
            const modal = document.getElementById('printPreviewModal'); const previewContentDiv = document.getElementById('printPreviewContentDiv'); const saveBtn = document.getElementById('saveImageButton'); if (!modal || !previewContentDiv) return;
            const isTournamentActive = document.getElementById('tabTournament').classList.contains('active');
            if (isTournamentActive) { previewContentDiv.innerHTML = generatePrintableTournamentHtml(); if(saveBtn) saveBtn.innerText = "ëŒ€ì§„í‘œ ì´ë¯¸ì§€ ì €ì¥"; } else { previewContentDiv.innerHTML = generatePrintableRankingsHtml(0, rankingsData.length); if(saveBtn) saveBtn.innerText = "ì´ë¯¸ì§€ ì €ì¥ (2ë¶„í• )"; }
            modal.classList.remove('hidden'); 
        }
        function hidePrintPreviewModal() { document.getElementById('printPreviewModal')?.classList.add('hidden'); }
        function handlePrintNow() { const printableArea = document.getElementById('printableArea'); const previewContentDiv = document.getElementById('printPreviewContentDiv'); if (!printableArea || !previewContentDiv) return; printableArea.innerHTML = previewContentDiv.innerHTML; window.print(); setTimeout(() => { printableArea.innerHTML = ''; }, 500); }
        async function handleSaveImage() { 
            const btn = document.getElementById('saveImageButton'); const originalText = btn.innerText; btn.innerText = "ì €ì¥ ì¤‘..."; btn.disabled = true; 
            const isTournamentActive = document.getElementById('tabTournament').classList.contains('active');
            if (isTournamentActive) { await captureTournamentImage(); } else { await captureAndSaveRange(0, 15, "1-15"); if (rankingsData.length > 15) { await new Promise(resolve => setTimeout(resolve, 500)); const endIdx = Math.min(rankingsData.length, 30); await captureAndSaveRange(15, endIdx, `16-${endIdx}`); } }
            btn.innerText = originalText; btn.disabled = false; 
        }
        function captureTournamentImage() {
            return new Promise((resolve) => {
                const originalScrollY = window.scrollY; window.scrollTo(0, 0); const tempDiv = document.createElement('div'); tempDiv.style.cssText = `position: absolute; top: 0; left: 0; width: auto; height: auto; z-index: -9999; background-color: #ffffff; visibility: visible;`; tempDiv.innerHTML = generatePrintableTournamentHtml(); document.body.appendChild(tempDiv); const contentDiv = tempDiv.firstElementChild; const width = contentDiv.offsetWidth; const height = contentDiv.offsetHeight;
                setTimeout(() => { html2canvas(contentDiv, { scale: 2, useCORS: true, backgroundColor: "#ffffff", width: width, height: height, windowWidth: document.documentElement.scrollWidth, windowHeight: document.documentElement.scrollHeight, scrollX: 0, scrollY: 0, x: 0, y: 0 }).then(canvas => { const link = document.createElement('a'); const dateStr = currentRankingDate || new Date().toISOString().split('T')[0]; link.download = `tournament_${dateStr}.png`; link.href = canvas.toDataURL('image/png'); link.click(); document.body.removeChild(tempDiv); window.scrollTo(0, originalScrollY); resolve(); }).catch(err => { console.error("Image save failed:", err); if(document.body.contains(tempDiv)) document.body.removeChild(tempDiv); window.scrollTo(0, originalScrollY); resolve(); }); }, 300);
            });
        }
        function captureAndSaveRange(startIdx, endIdx, suffix) { 
            return new Promise((resolve) => { 
                const tempDiv = document.createElement('div'); tempDiv.className = 'p-4 bg-white font-sans'; tempDiv.style.cssText = 'position:absolute; top:0; left:0; width:800px; height:auto; z-index:-9999; background-color:#ffffff; overflow:visible; font-family: "Inter", sans-serif; box-sizing: border-box; -webkit-font-smoothing: antialiased;'; tempDiv.innerHTML = generatePrintableRankingsHtml(startIdx, endIdx); document.body.appendChild(tempDiv); 
                setTimeout(() => { html2canvas(tempDiv, { scale: 3, useCORS: true, backgroundColor: "#ffffff" }).then(canvas => { const link = document.createElement('a'); const dateStr = currentRankingDate || new Date().toISOString().split('T')[0]; link.download = `ranking_${dateStr}_${suffix}.png`; link.href = canvas.toDataURL('image/png'); link.click(); document.body.removeChild(tempDiv); resolve(); }).catch(err => { console.error("Image save failed:", err); if(document.body.contains(tempDiv)) document.body.removeChild(tempDiv); resolve(); }); }, 500); 
            }); 
        }

        // --- Tournament Functions ---
        function generatePrintableTournamentHtml() {
            if (!tournamentData.active) return '<div style="text-align:center; padding: 40px; color: #9ca3af; font-style: italic;">ì§„í–‰ ì¤‘ì¸ í† ë„ˆë¨¼íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
            let dateString = ""; if (currentRankingDate) { const [y, m, d] = currentRankingDate.split('-'); dateString = `${y}ë…„ ${m}ì›” ${d}ì¼`; } else { const today = new Date(); dateString = `${today.getFullYear()}ë…„ ${(today.getMonth() + 1).toString().padStart(2, '0')}ì›” ${today.getDate().toString().padStart(2, '0')}ì¼`; }
            let html = `<div style="padding: 50px; text-align: center; background-color: white; display: inline-flex; flex-direction: column; min-width: 1000px; width: max-content; box-sizing: border-box;"> <div style="border-bottom: 4px solid #e5e7eb; padding-bottom: 20px; margin-bottom: 40px; width: 100%;"> <h1 style="font-size: 36px; font-weight: 900; color: #111827; margin-bottom: 10px; line-height: 1.2;">ğŸ† ${currentSeasonTitle} í† ë„ˆë¨¼íŠ¸ ëŒ€ì§„í‘œ</h1> <span style="font-size: 18px; color: #6b7280; font-weight: 600;">(${dateString} ê¸°ì¤€)</span> </div> <div style="display: flex; justify-content: center; align-items: stretch; gap: 40px;">`;
            tournamentData.rounds.forEach((round, rIndex) => {
                let roundName = ""; if (rIndex === tournamentData.rounds.length - 1) roundName = "ê²°ìŠ¹ (Finals)"; else if (rIndex === tournamentData.rounds.length - 2) roundName = "4ê°• (Semis)"; else if (rIndex === tournamentData.rounds.length - 3) roundName = "8ê°• (Quarters)"; else roundName = "16ê°•";
                html += `<div style="display: flex; flex-direction: column; min-width: 240px;"> <div style="text-align: center; font-weight: 800; color: #4b5563; margin-bottom: 20px; font-size: 20px; border-bottom: 2px dashed #e5e7eb; padding-bottom: 8px; height: 35px;">${roundName}</div> <div style="display: flex; flex-direction: column; justify-content: space-around; flex: 1;">`;
                if (rIndex < tournamentData.rounds.length - 1) { for (let i = 0; i < round.length; i += 2) { const match1 = round[i]; const match2 = round[i+1]; html += `<div style="position: relative; display: flex; flex-direction: column; justify-content: space-around; flex: 1; margin-bottom: 20px;">`; if (match1) html += generateMatchPrintHTML(match1); if (match2) html += generateMatchPrintHTML(match2); html += `<div style="position: absolute; top: 25%; bottom: 25%; right: -25px; width: 25px; border-right: 3px solid #cbd5e1; border-top: 3px solid #cbd5e1; border-bottom: 3px solid #cbd5e1;"></div> <div style="position: absolute; top: 50%; right: -25px; width: 25px; height: 3px; background-color: #cbd5e1; transform: translateY(-50%);"></div> </div>`; } } else { round.forEach((match) => { html += `<div style="position: relative; display: flex; align-items: center; width: 100%;">`; html += generateMatchPrintHTML(match); if (match.winner) html += `<div style="position: absolute; right: -40px; top: 50%; width: 40px; height: 3px; background-color: #cbd5e1; transform: translateY(-50%); z-index: 0;"></div>`; html += `</div>`; }); }
                html += `</div></div>`;
            });
            const finalMatch = tournamentData.rounds[tournamentData.rounds.length-1][0];
            if (finalMatch && finalMatch.winner) { html += ` <div style="display: flex; flex-direction: column; margin-left: 20px;"> <div style="height: 35px; margin-bottom: 20px;"></div> <div style="display: flex; flex-direction: column; justify-content: center; flex: 1;"> <div style="text-align: center; border: 6px solid #fbbf24; padding: 40px; border-radius: 24px; background: linear-gradient(135deg, #fffbeb 0%, #ffffff 100%); box-shadow: 0 25px 30px -5px rgba(0, 0, 0, 0.1); min-width: 250px;"> <div style="font-size: 60px; margin-bottom: 15px;">ğŸ‘‘</div> <div style="color: #d97706; font-weight: 800; font-size: 18px; letter-spacing: 3px; margin-bottom: 10px;">CHAMPION</div> <div style="font-weight: 900; font-size: 40px; color: #111827; margin-top: 5px; white-space: nowrap;">${finalMatch.winner.name}</div> </div> </div> </div> `; }
            html += `</div></div>`; return html;
        }

        function generateMatchPrintHTML(match) {
            const p1 = match.p1; const p2 = match.p2; const matchStyle = "border: 1px solid #d1d5db; border-radius: 12px; padding: 10px; margin: 15px 0; background: white; box-shadow: 0 4px 6px rgba(0,0,0,0.05); position: relative; z-index: 10;";
            const p1Name = p1 ? p1.name : '-'; const p2Name = p2 ? p2.name : '-';
            let p1Rank = ''; if (p1 && !p1.isTemp) { const idx = rankingsData.findIndex(r=>r.id===p1.id); if (idx !== -1) p1Rank = `<span style="font-size:16px; color:#6b7280; margin-right:8px; font-weight: 600;">${idx+1}ìœ„</span>`; }
            let p2Rank = ''; if (p2 && !p2.isTemp) { const idx = rankingsData.findIndex(r=>r.id===p2.id); if (idx !== -1) p2Rank = `<span style="font-size:16px; color:#6b7280; margin-right:8px; font-weight: 600;">${idx+1}ìœ„</span>`; }
            let p1Style = "padding: 12px 14px; border-radius: 8px; font-size: 24px; display: flex; justify-content: space-between; align-items: center; font-weight: 800; color: #1f2937;"; let p2Style = "padding: 12px 14px; border-radius: 8px; font-size: 24px; display: flex; justify-content: space-between; align-items: center; font-weight: 800; color: #1f2937;";
            let p1Check = ""; let p2Check = "";
            if (match.winner) { if (match.winner.id === p1?.id) { p1Style += " background-color: #eff6ff; color: #1d4ed8; font-weight: 900;"; p2Style += " color: #9ca3af; text-decoration: line-through; font-weight: 500;"; p1Check = "âœ”"; } else if (match.winner.id === p2?.id) { p2Style += " background-color: #eff6ff; color: #1d4ed8; font-weight: 900;"; p1Style += " color: #9ca3af; text-decoration: line-through; font-weight: 500;"; p2Check = "âœ”"; } }
            return ` <div style="${matchStyle}"> <div style="${p1Style}"> <div style="display:flex; align-items:baseline;">${p1Rank}${p1Name}</div> <span style="color: #22c55e; font-weight:900; font-size: 28px;">${p1Check}</span> </div> <div style="border-top: 1px solid #e5e7eb; margin: 8px 0;"></div> <div style="${p2Style}"> <div style="display:flex; align-items:baseline;">${p2Rank}${p2Name}</div> <span style="color: #22c55e; font-weight:900; font-size: 28px;">${p2Check}</span> </div> </div> `;
        }
        
        function initTournament(size) {
            addToHistory(); const participants = rankingsData.filter(i => i.isParticipating).slice(0, size);
            if (participants.length < size) { alert(`ì°¸ì—¬ ê°€ëŠ¥í•œ ì¸ì›ì´ ë¶€ì¡±í•©ë‹ˆë‹¤. (í˜„ì¬ ${participants.length}ëª… / í•„ìš” ${size}ëª…)`); return; }
            const rounds = []; const matches = [];
            if (size === 8) { matches.push({ id: 1, p1: participants[0], p2: participants[7], winner: null }); matches.push({ id: 2, p1: participants[3], p2: participants[4], winner: null }); matches.push({ id: 3, p1: participants[1], p2: participants[6], winner: null }); matches.push({ id: 4, p1: participants[2], p2: participants[5], winner: null }); } else if (size === 16) { matches.push({ id: 1, p1: participants[0], p2: participants[15], winner: null }); matches.push({ id: 2, p1: participants[7], p2: participants[8], winner: null }); matches.push({ id: 3, p1: participants[3], p2: participants[12], winner: null }); matches.push({ id: 4, p1: participants[4], p2: participants[11], winner: null }); matches.push({ id: 5, p1: participants[1], p2: participants[14], winner: null }); matches.push({ id: 6, p1: participants[6], p2: participants[9], winner: null }); matches.push({ id: 7, p1: participants[2], p2: participants[13], winner: null }); matches.push({ id: 8, p1: participants[5], p2: participants[10], winner: null }); }
            rounds.push(matches);
            let currentSize = matches.length; let matchIdCounter = matches.length + 1;
            while (currentSize > 1) { currentSize = currentSize / 2; const nextRoundMatches = []; for(let i=0; i<currentSize; i++) { nextRoundMatches.push({ id: matchIdCounter++, p1: null, p2: null, winner: null }); } rounds.push(nextRoundMatches); }
            tournamentData = { active: true, size: 16, rounds: rounds };
            saveRankings(); renderTournament();
        }
        window.initTournament = initTournament;
        function openTournamentSetup() { const modal = document.getElementById('tournamentSetupModal'); const grid = document.getElementById('setupGrid'); const datalist = document.getElementById('rankingOptions'); if (!modal || !grid || !datalist) return; datalist.innerHTML = ''; rankingsData.forEach((item, idx) => { const opt = document.createElement('option'); opt.value = `${idx+1}ìœ„ ${item.name}`; datalist.appendChild(opt); }); grid.innerHTML = ''; for(let i=0; i<8; i++) { const div = document.createElement('div'); div.className = "bg-gray-50 p-2 rounded border"; div.innerHTML = ` <div class="text-xs font-bold text-gray-500 mb-1 text-center">Match ${i+1}</div> <div class="flex flex-col gap-1"> <input type="text" class="setup-input border rounded p-1 text-sm w-full" list="rankingOptions" placeholder="ì„ ìˆ˜ 1" value=""> <div class="text-center text-xs text-gray-400">VS</div> <input type="text" class="setup-input border rounded p-1 text-sm w-full" list="rankingOptions" placeholder="ì„ ìˆ˜ 2" value=""> </div> `; grid.appendChild(div); } modal.classList.remove('hidden'); }
        window.openTournamentSetup = openTournamentSetup;
        function closeTournamentSetup() { document.getElementById('tournamentSetupModal')?.classList.add('hidden'); }
        window.closeTournamentSetup = closeTournamentSetup;
        function openRandomTournamentSetup() { const modal = document.getElementById('randomTournamentModal'); const listContainer = document.getElementById('randomPlayerList'); if (!modal || !listContainer) return; randomSelectionCandidates = rankingsData.map((p, index) => ({ id: p.id, name: p.name, rank: index + 1, isSelected: p.isParticipating, isTemp: false })); renderRandomPlayerList(); updateSelectedCount(); modal.classList.remove('hidden'); }
        window.openRandomTournamentSetup = openRandomTournamentSetup;
        function closeRandomTournamentSetup() { document.getElementById('randomTournamentModal')?.classList.add('hidden'); }
        window.closeRandomTournamentSetup = closeRandomTournamentSetup;
        function renderRandomPlayerList() { const listContainer = document.getElementById('randomPlayerList'); if (!listContainer) return; listContainer.innerHTML = ''; randomSelectionCandidates.forEach((p, index) => { const div = document.createElement('div'); div.className = "flex items-center justify-between p-2 border-b last:border-0 hover:bg-gray-50"; const rankBadge = p.isTemp ? `<span class="bg-gray-200 text-gray-600 text-[10px] px-1.5 py-0.5 rounded mr-2">ì™¸ë¶€</span>` : `<span class="bg-blue-100 text-blue-600 text-[10px] px-1.5 py-0.5 rounded mr-2 font-bold">${p.rank}ìœ„</span>`; div.innerHTML = ` <div class="flex items-center"> <input type="checkbox" class="w-4 h-4 text-blue-600 rounded mr-2 cursor-pointer" ${p.isSelected ? 'checked' : ''} onchange="toggleRandomSelection(${index})"> ${rankBadge} <span class="text-sm font-medium ${p.isSelected ? 'text-gray-800' : 'text-gray-400'}">${p.name}</span> </div> ${p.isTemp ? `<button onclick="removeTempPlayer(${index})" class="text-red-400 hover:text-red-600 text-xs">ì‚­ì œ</button>` : ''} `; listContainer.appendChild(div); }); }
        window.renderRandomPlayerList = renderRandomPlayerList;
        function toggleRandomSelection(index) { randomSelectionCandidates[index].isSelected = !randomSelectionCandidates[index].isSelected; renderRandomPlayerList(); updateSelectedCount(); }
        window.toggleRandomSelection = toggleRandomSelection;
        function addExternalPlayer() { const input = document.getElementById('externalPlayerInput'); const name = input.value.trim(); if (!name) return; randomSelectionCandidates.push({ id: 'temp-' + crypto.randomUUID(), name: name, rank: 0, isSelected: true, isTemp: true }); input.value = ''; renderRandomPlayerList(); updateSelectedCount(); }
        window.addExternalPlayer = addExternalPlayer;
        function handleExternalInputKey(e) { if (e.key === 'Enter') addExternalPlayer(); }
        window.handleExternalInputKey = handleExternalInputKey;
        function removeTempPlayer(index) { randomSelectionCandidates.splice(index, 1); renderRandomPlayerList(); updateSelectedCount(); }
        window.removeTempPlayer = removeTempPlayer;
        function selectAllRandomPlayers() { randomSelectionCandidates.forEach(p => p.isSelected = true); renderRandomPlayerList(); updateSelectedCount(); }
        window.selectAllRandomPlayers = selectAllRandomPlayers;
        function deselectAllRandomPlayers() { randomSelectionCandidates.forEach(p => p.isSelected = false); renderRandomPlayerList(); updateSelectedCount(); }
        window.deselectAllRandomPlayers = deselectAllRandomPlayers;
        function updateSelectedCount() { const count = randomSelectionCandidates.filter(c => c.isSelected).length; const el = document.getElementById('selectedCount'); const btn = document.getElementById('startRandomBtn'); if (el) { el.textContent = `${count} / 16ëª…`; if (count === 16) { el.className = "font-bold text-green-600"; btn.disabled = false; btn.classList.remove('opacity-50', 'cursor-not-allowed'); } else { el.className = "font-bold text-red-500"; btn.disabled = true; btn.classList.add('opacity-50', 'cursor-not-allowed'); } } }
        window.updateSelectedCount = updateSelectedCount;
        function shuffleArray(array) { for (let i = array.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [array[i], array[j]] = [array[j], array[i]]; } return array; }
        function startRandomTournament() {
            const selected = randomSelectionCandidates.filter(c => c.isSelected); if (selected.length !== 16) { alert("ì •í™•íˆ 16ëª…ì„ ì„ íƒí•´ì•¼ í•©ë‹ˆë‹¤."); return; }
            const shuffled = shuffleArray([...selected]); const matches = []; for (let i = 0; i < 8; i++) { const p1 = shuffled[i * 2]; const p2 = shuffled[i * 2 + 1]; let player1Obj = p1.isTemp ? { id: p1.id, name: p1.name, isTemp: true } : rankingsData.find(r => r.id === p1.id); let player2Obj = p2.isTemp ? { id: p2.id, name: p2.name, isTemp: true } : rankingsData.find(r => r.id === p2.id); matches.push({ id: i+1, p1: player1Obj, p2: player2Obj, winner: null }); }
            const rounds = []; rounds.push(matches); let currentSize = 8; let matchIdCounter = 9; while (currentSize > 1) { currentSize = currentSize / 2; const nextRoundMatches = []; for(let i=0; i<currentSize; i++) { nextRoundMatches.push({ id: matchIdCounter++, p1: null, p2: null, winner: null }); } rounds.push(nextRoundMatches); }
            addToHistory(); tournamentData = { active: true, size: 16, rounds: rounds }; saveRankings(); renderTournament(); closeRandomTournamentSetup();
        }
        window.startRandomTournament = startRandomTournament;
        function startManualTournament() {
            const inputs = document.querySelectorAll('.setup-input'); const matches = [];
            const resolvePlayer = (val) => { val = val.trim(); if (!val) return null; let name = val; const rankMatch = val.match(/^\d+ìœ„\s+(.+)$/); if (rankMatch) { name = rankMatch[1]; } const existing = rankingsData.find(r => r.name === name); if (existing) return existing; return { id: 'temp-' + crypto.randomUUID(), name: name, isTemp: true }; };
            for(let i=0; i<8; i++) { const p1Val = inputs[i*2].value; const p2Val = inputs[i*2 + 1].value; const p1 = resolvePlayer(p1Val); const p2 = resolvePlayer(p2Val); matches.push({ id: i+1, p1: p1, p2: p2, winner: null }); }
            const rounds = []; rounds.push(matches); let currentSize = 8; let matchIdCounter = 9; while (currentSize > 1) { currentSize = currentSize / 2; const nextRoundMatches = []; for(let i=0; i<currentSize; i++) { nextRoundMatches.push({ id: matchIdCounter++, p1: null, p2: null, winner: null }); } rounds.push(nextRoundMatches); }
            addToHistory(); tournamentData = { active: true, size: 16, rounds: rounds }; saveRankings(); renderTournament(); closeTournamentSetup();
        }
        window.startManualTournament = startManualTournament;
        function handleTournamentMatchClick(roundIndex, matchIndex, winnerIsP1) { addToHistory(); const round = tournamentData.rounds[roundIndex]; const match = round[matchIndex]; if (!match.p1 || !match.p2) return; const winner = winnerIsP1 ? match.p1 : match.p2; match.winner = winner; const nextRoundIndex = roundIndex + 1; if (nextRoundIndex < tournamentData.rounds.length) { const nextRoundMatchIndex = Math.floor(matchIndex / 2); const nextRoundMatch = tournamentData.rounds[nextRoundIndex][nextRoundMatchIndex]; if (matchIndex % 2 === 0) { nextRoundMatch.p1 = winner; } else { nextRoundMatch.p2 = winner; } if (nextRoundMatch.winner) { nextRoundMatch.winner = null; } } saveRankings(); renderTournament(); }
        window.handleTournamentMatchClick = handleTournamentMatchClick;
        function resetTournament() { showConfirmModal("í˜„ì¬ ì§„í–‰ì¤‘ì¸ í† ë„ˆë¨¼íŠ¸ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?", () => { addToHistory(); tournamentData = { active: false, size: 0, rounds: [] }; saveRankings(); renderTournament(); }); }
        window.resetTournament = resetTournament;
        function renderTournament() {
            const container = document.getElementById('bracketContainer'); if (!container) return;
            if (!tournamentData.active) { container.innerHTML = '<div class="text-gray-400 italic py-10">ìƒì„±ëœ í† ë„ˆë¨¼íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤. ìƒë‹¨ ë²„íŠ¼ìœ¼ë¡œ ëŒ€ì§„í‘œë¥¼ ìƒì„±í•˜ì„¸ìš”.</div>'; return; }
            let html = '';
            tournamentData.rounds.forEach((round, rIndex) => {
                let roundName = ""; if (rIndex === tournamentData.rounds.length - 1) roundName = "ê²°ìŠ¹ (Finals)"; else if (rIndex === tournamentData.rounds.length - 2) roundName = "4ê°• (Semis)"; else if (rIndex === tournamentData.rounds.length - 3) roundName = "8ê°• (Quarters)"; else roundName = "16ê°•";
                const isFinalRound = rIndex === tournamentData.rounds.length - 1; const roundStyle = isFinalRound ? 'margin-right: 0;' : '';
                html += `<div class="bracket-round" style="${roundStyle}"> <div class="text-center font-bold text-gray-500 mb-2 text-sm h-6">${roundName}</div> <div class="bracket-matches">`;
                if (rIndex < tournamentData.rounds.length - 1) { for (let i = 0; i < round.length; i += 2) { const match1 = round[i]; const match2 = round[i+1]; html += `<div class="bracket-pair">`; if (match1) html += renderMatchHTML(match1, rIndex, i); if (match2) html += renderMatchHTML(match2, rIndex, i+1); html += `<div class="pair-connector"></div> </div>`; } } else { round.forEach((match, mIndex) => { html += `<div style="position: relative; display: flex; align-items: center; width: 100%;">`; html += renderMatchHTML(match, rIndex, mIndex); if (match.winner) html += `<div class="final-connector"></div>`; html += `</div>`; }); }
                html += `</div></div>`;
            });
            const finalMatch = tournamentData.rounds[tournamentData.rounds.length-1][0];
            if (finalMatch && finalMatch.winner) { html += ` <div class="bracket-round ml-0"> <div class="h-6 mb-2"></div> <div class="bracket-matches justify-center"> <div class="text-center hof-card hof-champion transform scale-90 p-4" style="min-width: 160px; margin-left: 20px;"> <div class="text-4xl mb-2">ğŸ‘‘</div> <div class="font-bold text-amber-500 text-sm">CHAMPION</div> <div class="font-black text-gray-800 text-xl">${finalMatch.winner.name}</div> </div> </div> </div> `; }
            container.innerHTML = html;
        }
        function renderMatchHTML(match, rIndex, mIndex) {
            const p1 = match.p1; const p2 = match.p2; let p1Class = "bracket-team"; let p2Class = "bracket-team";
            if (match.winner) { if (match.winner.id === p1?.id) { p1Class += " winner"; p2Class += " loser"; } else if (match.winner.id === p2?.id) { p2Class += " winner"; p1Class += " loser"; } }
            const p1Name = p1 ? p1.name : '-'; const p2Name = p2 ? p2.name : '-';
            let p1Rank = ''; if (p1 && !p1.isTemp) { const idx = rankingsData.findIndex(r=>r.id===p1.id); if (idx !== -1) p1Rank = `<span class="text-xs text-gray-400 mr-1">${idx+1}ìœ„</span>`; }
            let p2Rank = ''; if (p2 && !p2.isTemp) { const idx = rankingsData.findIndex(r=>r.id===p2.id); if (idx !== -1) p2Rank = `<span class="text-xs text-gray-400 mr-1">${idx+1}ìœ„</span>`; }
            return ` <div class="bracket-match w-full relative z-10"> <div class="${p1Class}" onclick="handleTournamentMatchClick(${rIndex}, ${mIndex}, true)"> <div>${p1Rank}${p1Name}</div> ${match.winner && match.winner.id === p1?.id ? '<span class="text-green-500">âœ”</span>' : ''} </div> <div class="border-t border-gray-100 my-1"></div> <div class="${p2Class}" onclick="handleTournamentMatchClick(${rIndex}, ${mIndex}, false)"> <div>${p2Rank}${p2Name}</div> ${match.winner && match.winner.id === p2?.id ? '<span class="text-green-500">âœ”</span>' : ''} </div> </div> `;
        }
        function showNonPartModal() { const listContainer = document.getElementById('nonPartList'); const modal = document.getElementById('nonPartModal'); if (!listContainer || !modal) return; const nonParticipants = rankingsData.filter(item => !item.isParticipating); if (nonParticipants.length === 0) { listContainer.innerHTML = '<div class="text-center text-gray-400 italic">ë¯¸ì°¸ì—¬ ì¸ì›ì´ ì—†ìŠµë‹ˆë‹¤.</div>'; } else { listContainer.innerHTML = nonParticipants.map(item => { const rankIndex = rankingsData.findIndex(r => r.id === item.id); return `<div class="flex justify-between border-b border-gray-200 last:border-0 pb-1 mb-1"> <span>${rankIndex + 1}ìœ„</span> <span class="text-xs sm:text-base font-bold truncate block max-w-[150px]">${item.name}</span> </div>`; }).join(''); } modal.classList.remove('hidden'); }
        function copyNonPartList() { const nonParticipants = rankingsData.filter(item => !item.isParticipating); if (nonParticipants.length === 0) return; const text = nonParticipants.map(item => { const rankIndex = rankingsData.findIndex(r => r.id === item.id); return `${rankIndex + 1}ìœ„ ${item.name}`; }).join('\n'); navigator.clipboard.writeText(text).then(() => { const btn = document.getElementById('copyNonPartButton'); const originalText = btn.textContent; btn.textContent = "ë³µì‚¬ ì™„ë£Œ!"; setTimeout(() => btn.textContent = originalText, 1500); }).catch(err => { const textArea = document.createElement("textarea"); textArea.value = text; document.body.appendChild(textArea); textArea.select(); document.execCommand('copy'); document.body.removeChild(textArea); const btn = document.getElementById('copyNonPartButton'); const originalText = btn.textContent; btn.textContent = "ë³µì‚¬ ì™„ë£Œ!"; setTimeout(() => btn.textContent = originalText, 1500); }); }
        function hideNonPartModal() { document.getElementById('nonPartModal')?.classList.add('hidden'); }

        // --- Backup & Restore Functions ---
        function getCompleteState() {
            return {
                rankings: rankingsData,
                logs: logsData,
                matchHistory: matchHistoryData,
                seasonArchives: seasonArchives,
                date: currentRankingDate,
                activeSeason: activeSeason,
                seasonTitle: currentSeasonTitle,
                seasonBestMatch: currentSeasonBestMatch,
                tournamentData: tournamentData
            };
        }
        function restoreState(data) {
            if (!data || !data.rankings) { alert("ìœ íš¨í•˜ì§€ ì•Šì€ ë°ì´í„°ì…ë‹ˆë‹¤."); return false; }
            try {
                rankingsData = data.rankings; logsData = data.logs || []; matchHistoryData = data.matchHistory || []; seasonArchives = data.seasonArchives || {}; currentRankingDate = data.date || ''; activeSeason = data.activeSeason || "ì‹œì¦Œ 1"; viewSeason = activeSeason; currentSeasonTitle = data.seasonTitle || "ì‹œì¦Œ 1"; currentSeasonBestMatch = data.seasonBestMatch || ""; tournamentData = data.tournamentData || { active: false, size: 0, rounds: [] };
                const dateInput = document.getElementById('rankingDateInput'); if (dateInput) dateInput.value = currentRankingDate;
                updateSeasonSelector(); saveRankings(); renderRankings(); renderLogs(); renderMatchHistory(); renderHallOfFame(); populateH2HSelectors(); renderTournament();
                alert("ë°ì´í„°ê°€ ì„±ê³µì ìœ¼ë¡œ ë³µì›ë˜ì—ˆìŠµë‹ˆë‹¤."); hideBackupRestoreModal(); return true;
            } catch (e) { console.error("Restore failed:", e); alert("ë³µì› ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + e.message); return false; }
        }
        function showBackupRestoreModal() { document.getElementById('backupRestoreModal')?.classList.remove('hidden'); }
        function hideBackupRestoreModal() { document.getElementById('backupRestoreModal')?.classList.add('hidden'); }
        function handleBackupDownload() {
            const data = getCompleteState(); const jsonStr = JSON.stringify(data, null, 2); const blob = new Blob([jsonStr], { type: "application/json" }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); const dateStr = currentRankingDate || new Date().toISOString().split('T')[0]; a.href = url; a.download = `rfc_backup_${dateStr}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
        }
        function handleBackupRestoreFromFile(event) {
            const file = event.target.files[0]; if (!file) return;
            showConfirmModal("í˜„ì¬ ë°ì´í„°ë¥¼ ë®ì–´ì“°ê³  íŒŒì¼ ë‚´ìš©ìœ¼ë¡œ ë³µì›í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ì´ ì‘ì—…ì€ ì·¨ì†Œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤)", () => { const reader = new FileReader(); reader.onload = function(e) { try { const data = JSON.parse(e.target.result); restoreState(data); } catch (err) { alert("íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì˜¬ë°”ë¥¸ JSON íŒŒì¼ì¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”."); } }; reader.readAsText(file); });
            event.target.value = ''; 
        }

        // --- Tag Selection Modal Functions ---
        function openTagSelectionModal(playerId) {
            currentTagEditPlayerId = playerId;
            const player = rankingsData.find(p => p.id === playerId);
            if (!player) return;
            
            const modal = document.getElementById('tagSelectionModal');
            const container = document.getElementById('predefinedTagsContainer');
            const customInput = document.getElementById('customTagInput');
            
            if (!modal || !container || !customInput) return;

            // Clear and populate checkboxes
            container.innerHTML = '';
            const currentTags = new Set(player.tags || []);
            
            PREDEFINED_TAGS.forEach(tag => {
                const isChecked = currentTags.has(tag);
                const label = document.createElement('label');
                label.className = "flex items-center space-x-2 cursor-pointer bg-gray-50 p-2 rounded hover:bg-gray-100 border border-gray-200 transition select-none";
                label.innerHTML = `
                    <input type="checkbox" value="${tag}" class="form-checkbox text-blue-600 rounded focus:ring-blue-500 w-4 h-4" ${isChecked ? 'checked' : ''}>
                    <span class="text-sm text-gray-700 font-bold">${tag}</span>
                `;
                container.appendChild(label);
            });
            
            // Handle custom tags (tags not in predefined list)
            const customTags = (player.tags || []).filter(t => !PREDEFINED_TAGS.includes(t));
            customInput.value = customTags.join(', ');
            
            modal.classList.remove('hidden');
        }
        window.openTagSelectionModal = openTagSelectionModal;

        function closeTagSelectionModal() {
            document.getElementById('tagSelectionModal')?.classList.add('hidden');
            currentTagEditPlayerId = null;
        }
        window.closeTagSelectionModal = closeTagSelectionModal;

        function saveTags() {
            if (!currentTagEditPlayerId) return;
            const player = rankingsData.find(p => p.id === currentTagEditPlayerId);
            if (!player) return;
            
            const container = document.getElementById('predefinedTagsContainer');
            const customInput = document.getElementById('customTagInput');
            
            const selectedTags = [];
            // Collect checked predefined tags
            container.querySelectorAll('input[type="checkbox"]:checked').forEach(cb => {
                selectedTags.push(cb.value);
            });
            
            // Collect custom tags
            const customText = customInput.value.trim();
            if (customText) {
                const customs = customText.split(',').map(t => t.trim()).filter(t => t !== '');
                selectedTags.push(...customs);
            }
            
            // Remove duplicates and save
            player.tags = [...new Set(selectedTags)];
            
            saveRankings();
            
            // Update profile view if open
            const tagsEl = document.getElementById('profileTags');
            if (tagsEl && !document.getElementById('profileModal').classList.contains('hidden')) {
                if (player.tags.length === 0) {
                    tagsEl.innerHTML = '<span class="tag-empty">+ ìŠ¤íƒ€ì¼ íƒœê·¸ ì¶”ê°€</span>';
                } else {
                    tagsEl.innerHTML = player.tags.map(tag => `<span class="tag-badge">#${tag}</span>`).join('');
                }
            }
            
            closeTagSelectionModal();
        }
        window.saveTags = saveTags;

        function handleCopyBackupText() {
            const data = getCompleteState(); const jsonStr = JSON.stringify(data); navigator.clipboard.writeText(jsonStr).then(() => { const btn = document.getElementById('copyBackupTextBtn'); const originalText = btn.textContent; btn.textContent = "ë³µì‚¬ ì™„ë£Œ!"; setTimeout(() => btn.textContent = originalText, 2000); }).catch(err => { const textArea = document.getElementById('backupTextArea'); textArea.value = jsonStr; textArea.select(); document.execCommand('copy'); alert("í´ë¦½ë³´ë“œ ì ‘ê·¼ ê¶Œí•œì´ ì—†ì–´ í…ìŠ¤íŠ¸ ì˜ì—­ì— ì¶œë ¥í–ˆìŠµë‹ˆë‹¤. ì§ì ‘ ë³µì‚¬í•´ì£¼ì„¸ìš”."); });
        }
        function handlePasteRestore() {
            const textArea = document.getElementById('backupTextArea'); const jsonStr = textArea.value.trim(); if (!jsonStr) { alert("ë³µì›í•  í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }
            showConfirmModal("ì…ë ¥ëœ í…ìŠ¤íŠ¸ ë°ì´í„°ë¡œ í˜„ì¬ ìƒíƒœë¥¼ ë®ì–´ì“°ì‹œê² ìŠµë‹ˆê¹Œ?", () => { try { const data = JSON.parse(jsonStr); restoreState(data); textArea.value = ''; } catch (e) { alert("ë°ì´í„° í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. (JSON íŒŒì‹± ì˜¤ë¥˜)"); } });
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadingElement = document.getElementById('loading');

            const safeAddListener = (id, event, handler) => {
                const el = document.getElementById(id);
                if (el) el.addEventListener(event, handler);
            };

            safeAddListener('exportButton', 'click', showExportModal);
            safeAddListener('closeModal', 'click', hideExportModal);
            safeAddListener('previewButton', 'click', showPrintPreview);
            safeAddListener('printNowButton', 'click', handlePrintNow);
            safeAddListener('saveImageButton', 'click', handleSaveImage); 
            safeAddListener('closePreviewModal', 'click', hidePrintPreviewModal);
            safeAddListener('closePreviewModalX', 'click', hidePrintPreviewModal);
            safeAddListener('resetButton', 'click', resetRankChanges); 
            safeAddListener('resetParticipationButton', 'click', resetParticipation);
            safeAddListener('resetRecordsButton', 'click', resetRecords); 
            safeAddListener('undoButton', 'click', performUndo);
            safeAddListener('resetDefenseButton', 'click', resetDefenseCounts);
            
            document.getElementById('seasonTitleInput')?.addEventListener('change', handleSeasonTitleChange);
            document.getElementById('bestMatchInput')?.addEventListener('change', handleBestMatchChange);
            
            safeAddListener('matchButton', 'click', showMatchModal);
            safeAddListener('closeMatchModal', 'click', hideMatchModal);
            
            document.getElementById('applyRankingMatchButton')?.addEventListener('click', () => applyMatchResult('ranking'));
            document.getElementById('applyFriendlyMatchButton')?.addEventListener('click', () => applyMatchResult('friendly'));
            
            document.getElementById('rankingDateInput')?.addEventListener('change', handleDateChange);

            safeAddListener('tabRanking', 'click', () => switchTab('ranking'));
            safeAddListener('tabHallOfFame', 'click', () => switchTab('hallOfFame'));
            safeAddListener('tabMatchHistory', 'click', () => switchTab('matchHistory'));
            safeAddListener('tabHeadToHead', 'click', () => switchTab('headToHead')); 
            safeAddListener('tabTournament', 'click', () => switchTab('tournament'));
            
            document.getElementById('h2hPlayerA')?.addEventListener('change', updateOpponentSelector); 
            document.getElementById('h2hPlayerB')?.addEventListener('change', renderHeadToHeadAnalysis); 
            
            const seasonSelector = document.createElement('select'); seasonSelector.id = 'seasonSelector'; seasonSelector.className = 'text-sm font-bold text-gray-700 border border-gray-300 rounded-lg p-1.5 focus:ring-blue-500 focus:border-blue-500 bg-white ml-2'; seasonSelector.addEventListener('change', handleSeasonChange);
            const headerDateDiv = document.querySelector('input#rankingDateInput').parentNode; headerDateDiv.insertBefore(seasonSelector, headerDateDiv.firstChild);
            
            const startSeasonBtn = document.getElementById('startSeasonButton');
            if (startSeasonBtn) {
                startSeasonBtn.addEventListener('click', (e) => { e.preventDefault(); startNewSeason(); });
            }

            safeAddListener('nonPartButton', 'click', showNonPartModal);
            safeAddListener('closeNonPartModal', 'click', hideNonPartModal);
            safeAddListener('copyNonPartButton', 'click', copyNonPartList);
            safeAddListener('closeTournamentSetup', 'click', closeTournamentSetup);
            safeAddListener('startManualTournamentBtn', 'click', startManualTournament);
            safeAddListener('tournamentPrintBtn', 'click', showPrintPreview);

            safeAddListener('backupRestoreButton', 'click', showBackupRestoreModal);
            safeAddListener('closeBackupRestoreModal', 'click', hideBackupRestoreModal);
            safeAddListener('downloadBackupBtn', 'click', handleBackupDownload);
            document.getElementById('uploadBackupInput')?.addEventListener('change', handleBackupRestoreFromFile);
            safeAddListener('copyBackupTextBtn', 'click', handleCopyBackupText);
            safeAddListener('pasteRestoreBtn', 'click', handlePasteRestore);
            
            safeAddListener('debugButton', 'click', () => {
                document.body.classList.toggle('debug-mode');
                const btn = document.getElementById('debugButton');
                if (document.body.classList.contains('debug-mode')) { btn.classList.remove('bg-gray-500', 'hover:bg-gray-600'); btn.classList.add('bg-pink-600', 'hover:bg-pink-700'); } else { btn.classList.remove('bg-pink-600', 'hover:bg-pink-700'); btn.classList.add('bg-gray-500', 'hover:bg-gray-600'); }
            });
            
            safeAddListener('vsExportBtn', 'click', showVsExportModal);
            safeAddListener('closeVsModal', 'click', hideVsExportModal);

            safeAddListener('closeTagModal', 'click', closeTagSelectionModal);
            safeAddListener('saveTagsBtn', 'click', saveTags);

            safeAddListener('confirmYesBtn', 'click', () => { if (confirmCallback) confirmCallback(); hideConfirmModal(); });
            safeAddListener('confirmNoBtn', 'click', hideConfirmModal);
            safeAddListener('closeProfileModalBtn', 'click', closeProfileModal);

            // [ì¶”ê°€] ì´ë¯¸ì§€ í¸ì§‘ ëª¨ë‹¬ ë¦¬ìŠ¤ë„ˆ
            safeAddListener('cancelImageEditBtn', 'click', closeImageEditModal);
            safeAddListener('saveImageEditBtn', 'click', saveProfileImage);

            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        if (modal.id === 'confirmModal') { hideConfirmModal(); } else { modal.classList.add('hidden'); }
                    }
                });
            });

            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    const visibleModals = Array.from(document.querySelectorAll('.modal:not(.hidden)'));
                    if (visibleModals.length > 0) { const topModal = visibleModals[visibleModals.length - 1]; if (topModal.id === 'confirmModal') { hideConfirmModal(); } else { topModal.classList.add('hidden'); } }
                }
            });

            setupFirebase();
        });
    </script>
</head>
<body class="p-4 bg-gray-50">

<div id="dragStatusBadge">â–² 1 (ìˆœìœ„ ìƒìŠ¹)</div>
<div id="printableArea" class="hidden"></div>
    <div class="max-w-2xl mx-auto">
        <div class="flex flex-col sm:flex-row items-center justify-between mb-4 relative">
            <div class="hidden sm:block w-[140px]"></div> 
            <h1 class="text-xl font-bold text-gray-800 flex items-center justify-center mb-2 sm:mb-0 whitespace-nowrap">
                <span class="text-xs text-gray-400 font-normal mr-2">v1.74</span>
                ğŸ† RFC ë­í‚¹ì „ ìˆœìœ„ ê´€ë¦¬ê¸°
                <span id="syncStatus" class="text-xs font-normal text-green-500 ml-2 hidden"></span>
            </h1>
            <div class="w-full sm:w-auto flex justify-center sm:justify-end items-center">
                <input type="date" id="rankingDateInput" class="border border-gray-300 text-gray-700 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-1.5 bg-white shadow-sm hover:bg-gray-50 transition ml-2">
            </div>
        </div>

        <div id="tabContainer" class="flex border-b border-gray-200 mb-4 sticky top-0 z-50 bg-gray-50 pt-2 transition-all duration-200">
            <button id="tabRanking" class="tab-btn active flex-1 py-3 px-1 sm:px-2 text-xs sm:text-sm text-center font-bold text-blue-600 border-b-2 border-blue-500 flex justify-center items-center gap-1 transition-colors duration-200"><span>ğŸ”¥</span> <span class="hidden sm:inline">ë­í‚¹</span></button>
            <button id="tabMatchHistory" class="tab-btn flex-1 py-3 px-1 sm:px-2 text-xs sm:text-sm text-center font-medium text-gray-400 hover:text-gray-600 hover:border-gray-200 border-b-2 border-transparent flex justify-center items-center gap-1 transition-colors duration-200"><span>âš”ï¸</span> <span class="hidden sm:inline">ê¸°ë¡</span></button>
            <button id="tabHeadToHead" class="tab-btn flex-1 py-3 px-1 sm:px-2 text-xs sm:text-sm text-center font-medium text-gray-400 hover:text-gray-600 hover:border-gray-200 border-b-2 border-transparent flex justify-center items-center gap-1 transition-colors duration-200"><span>ğŸ†š</span> <span class="hidden sm:inline">ì „ì </span></button>
            <button id="tabHallOfFame" class="tab-btn flex-1 py-3 px-1 sm:px-2 text-xs sm:text-sm text-center font-medium text-gray-400 hover:text-gray-600 hover:border-gray-200 border-b-2 border-transparent flex justify-center items-center gap-1 transition-colors duration-200"><span>ğŸ“Š</span> <span class="hidden sm:inline">í˜„í™©</span></button>
            <button id="tabTournament" class="tab-btn flex-1 py-3 px-1 sm:px-2 text-xs sm:text-sm text-center font-medium text-gray-400 hover:text-gray-600 hover:border-gray-200 border-b-2 border-transparent flex justify-center items-center gap-1 transition-colors duration-200"><span>ğŸ†</span> <span class="hidden sm:inline">ëŒ€ì§„</span></button>
        </div>

        <div id="rankingSection">
            <p class="text-sm text-gray-600 mb-4 text-center">ë“œë˜ê·¸ë¡œ ì´ë™, í´ë¦­í•˜ì—¬ ìˆ˜ì •. <b>ìˆœìœ„ ìˆ«ì í´ë¦­ ì‹œ í”„ë¡œí•„ í™•ì¸.</b></p>
            <div id="loading" class="text-center p-4 text-blue-500 font-medium">ë°ì´í„°ë¥¼ ë¡œë“œí•˜ëŠ” ì¤‘...</div>
            
            <div id="searchSortBar" class="flex items-center mb-2 px-1 justify-between">
                <div class="flex gap-1 flex-nowrap mr-2">
                    <button id="undoButton" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-2 rounded shadow text-sm flex items-center opacity-50 cursor-not-allowed" disabled title="ì‹¤í–‰ ì·¨ì†Œ"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-undo-2"><path d="M9 14 4 9l5-5"/><path d="M4 9h10.5a5.5 5.5 0 0 1 5.5 5.5v0a5.5 5.5 0 0 1-5.5 5.5H11"/></svg></button>
                    <button id="previewButton" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-2 rounded shadow text-sm flex items-center whitespace-nowrap"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-printer mr-1"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect width="12" height="8" x="6" y="14"/></svg><span class="hidden sm:inline">ì¸ì‡„</span></button>
                    <button id="exportButton" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-2 rounded shadow text-sm flex items-center whitespace-nowrap"><span class="mr-1">ğŸ“‹</span><span class="hidden sm:inline">ê³µìœ </span></button>
                    <button id="backupRestoreButton" class="bg-rose-600 hover:bg-rose-700 text-white font-bold py-2 px-2 rounded shadow text-sm flex items-center" title="ëª¨ë“  ë°ì´í„° ì €ì¥ ë° ë¶ˆëŸ¬ì˜¤ê¸°"><span class="mr-1">ğŸ’¾</span><span class="hidden sm:inline">ë°±ì—…</span></button>
                    <button id="debugButton" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-2 rounded shadow text-sm flex items-center whitespace-nowrap" title="ë ˆì´ì•„ì›ƒ ê°€ì´ë“œ ì¼œê¸°/ë„ê¸°">ğŸ“</button>
                </div>

                <div id="topBtnGroup" class="flex gap-1 flex-nowrap justify-end overflow-x-auto no-scrollbar">
                    <button id="matchButton" class="text-white bg-orange-500 hover:bg-orange-600 font-bold rounded-lg text-sm px-5 py-2 text-center flex items-center whitespace-nowrap shadow-sm transition flex-shrink-0"><span class="mr-1 text-lg">ğŸ¥Š</span>ë§¤ì¹˜<span class="ml-1 text-lg">ğŸ¥Š</span></button>
                    <button id="nonPartButton" class="text-white bg-gray-500 hover:bg-gray-600 font-medium rounded-lg text-xs px-2 py-2 text-center flex items-center whitespace-nowrap shadow-sm transition flex-shrink-0"><span class="mr-1 text-lg">âŒ</span>ë¯¸ì°¸ì—¬</button>
                    <button id="startSeasonButton" class="bg-purple-600 hover:bg-purple-700 text-white font-medium rounded-lg text-xs px-3 py-2 text-center flex items-center whitespace-nowrap shadow-sm transition flex-shrink-0"><span class="text-lg mr-1">ğŸ“…</span>ì‹œì¦Œ</button>
                </div>
            </div>

            <div id="rankingHeader" class="flex items-end p-2 text-sm font-bold text-gray-500 border-b border-gray-300 mb-2">
                <div class="rank-number mr-1 pb-1">ìˆœìœ„</div> 
                <div class="w-12 text-center mr-1 pb-1">ì‹¬ë³¼</div> 
                <div class="w-[29%] text-left pl-4 mr-1 pb-1">ë‹‰ë„¤ì„</div> 
                
                <div class="w-[15%] flex flex-col items-center justify-end">
                    <button id="resetRecordsButton" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-0.5 px-1 sm:px-2 rounded shadow text-[10px] mb-1 whitespace-nowrap" title="ì „ì  ì´ˆê¸°í™”"><span class="hidden sm:inline">ì „ì  </span>ì´ˆê¸°í™”</button>
                    <div>ì „ì </div>
                </div>
                
                <div class="w-[12%] flex flex-col items-center justify-end">
                    <button id="resetButton" class="bg-red-500 hover:bg-red-600 text-white font-bold py-0.5 px-1 sm:px-2 rounded shadow text-[10px] mb-1 whitespace-nowrap" title="ë³€ë™í­ ì´ˆê¸°í™”"><span class="hidden sm:inline">ë³€ë™ </span>ì´ˆê¸°í™”</button>
                    <div>ë³€ë™</div>
                </div>
                
                <div class="w-[16%] flex flex-col items-center justify-end">
                    <button id="resetDefenseButton" class="bg-amber-500 hover:bg-amber-600 text-white font-bold py-0.5 px-1 sm:px-2 rounded shadow text-[10px] mb-1 whitespace-nowrap" title="ë°©ì–´ì „ ì´ˆê¸°í™”"><span class="hidden sm:inline">ë°©ì–´ </span>ì´ˆê¸°í™”</button>
                    <div>ë°©ì–´ì „</div>
                </div>
                
                <div class="w-8 ml-auto flex flex-col items-center justify-end">
                    <button id="resetParticipationButton" class="bg-green-500 hover:bg-green-600 text-white font-bold py-0.5 px-0 rounded shadow text-[10px] w-6 h-6 flex items-center justify-center mb-1" title="ì°¸ì—¬ ì´ˆê¸°í™”"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-square-x"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/></svg></button>
                    <div>ì°¸ì—¬</div>
                </div>
            </div>
            <div id="rankingList" class="space-y-2"></div>
            <div id="noteBlock" class="mt-6 p-4 bg-yellow-100 border-l-4 border-yellow-500 text-sm text-gray-700 rounded-lg"> **ğŸ’¡ íŒ:** <ul class="list-disc ml-4 mt-2 space-y-1"> <li>1~3ìœ„ëŠ” <span class="text-amber-500 font-bold">S ë°©ì–´ì „</span> ëŒ€ìƒìì…ë‹ˆë‹¤.</li> <li>ìˆœìœ„ ìˆ«ìë¥¼ í´ë¦­í•˜ë©´ <span class="text-blue-600 font-bold">ì„ ìˆ˜ í”„ë¡œí•„</span>ì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li> </ul> </div>
            <div id="logSection" class="mt-6 bg-white rounded-lg border border-gray-200 shadow-sm">
                <div class="bg-gray-100 px-4 py-2 rounded-t-lg border-b border-gray-200 font-bold text-sm text-gray-600 flex items-center"> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-history mr-2"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 12"/><path d="M3 3v9h9"/><path d="M12 7v5l4 2"/></svg>ğŸ“œ í™œë™ ë¡œê·¸ </div>
                <div id="logContainer" class="log-container bg-white p-2"> <div class="text-gray-400 text-center italic p-2">ê¸°ë¡ëœ í™œë™ì´ ì—†ìŠµë‹ˆë‹¤.</div> </div>
            </div>
        </div>

        <div id="matchHistorySection" class="hidden p-4 bg-gray-50 rounded-lg shadow-inner">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-gray-700">âš”ï¸ ê²½ê¸° ê¸°ë¡ (Recent 400)</h3>
                <div class="relative">
                    <button id="vsExportBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-1.5 px-3 rounded text-xs flex items-center shadow-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-clipboard-copy mr-1"><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M8 4H6a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-2"/><path d="M16 4h2a2 2 0 0 1 2 2v4"/><path d="M21 14H11"/><path d="m15 10-4 4 4 4"/></svg>
                        <span>ğŸ“‹ ë‚´ë³´ë‚´ê¸°</span>
                    </button>
                </div>
            </div>
            <div id="matchHistoryList"></div>
        </div>
        
        <div id="headToHeadSection" class="hidden p-4 bg-gray-50 rounded-lg shadow-inner">
            <h3 class="text-lg font-bold text-gray-700 mb-4 text-center">ğŸ†š ìƒëŒ€ì „ì  ë¶„ì„</h3>
            <div class="flex gap-2 mb-4 justify-center items-center">
                <select id="h2hPlayerA" class="border rounded shadow-sm w-1/2 bg-white"><option value="">ì„ ìˆ˜ A ì„ íƒ</option></select> <span class="font-bold text-gray-400">VS</span> <select id="h2hPlayerB" class="border rounded shadow-sm w-1/2 bg-white"><option value="">ì„ ìˆ˜ B ì„ íƒ</option></select>
            </div>
            <div id="h2hResult" class="text-center"> <div class="text-gray-400 italic py-10">ë‘ ì„ ìˆ˜ë¥¼ ì„ íƒí•˜ì—¬<br>ìƒëŒ€ ì „ì ì„ í™•ì¸í•˜ì„¸ìš”.</div> </div>
        </div>
        
        <div id="hallOfFameSection" class="hidden p-4 bg-gray-50 rounded-lg shadow-inner">
            <div class="mb-6 text-center">
                 <label class="block text-sm font-medium text-gray-500 mb-1">í˜„ì¬ ì‹œì¦Œ íƒ€ì´í‹€</label>
                 <input type="text" id="seasonTitleInput" class="text-2xl font-bold text-center bg-transparent border-b-2 border-blue-400 focus:outline-none focus:border-blue-600 text-gray-800 w-full max-w-xs" value="ì‹œì¦Œ 1">
            </div>
            <div id="hofContent"></div>
        </div>
        
        <div id="tournamentSection" class="hidden p-4 bg-gray-50 rounded-lg shadow-inner overflow-x-auto">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h3 class="text-lg font-bold text-gray-700 text-center flex-grow pl-10">ğŸ† í† ë„ˆë¨¼íŠ¸ ëŒ€ì§„í‘œ</h3>
                <button id="tournamentPrintBtn" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-1.5 px-3 rounded shadow text-xs flex items-center"> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-printer mr-1"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect width="12" height="8" x="6" y="14"/></svg> <span>ëŒ€ì§„í‘œ ì¸ì‡„</span> </button>
            </div>
            <div class="flex space-x-2 mb-6 justify-center">
                <button onclick="initTournament(16)" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-1.5 px-3 rounded shadow-sm text-sm">16ê°• ìë™</button>
                <button onclick="openRandomTournamentSetup()" class="bg-green-600 hover:bg-green-700 text-white font-bold py-1.5 px-3 rounded shadow-sm text-sm">16ê°• ëœë¤</button>
                <button onclick="openTournamentSetup()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-1.5 px-3 rounded shadow-sm text-sm">16ê°• ì…ë ¥</button>
                <button onclick="resetTournament()" class="bg-red-500 hover:bg-red-600 text-white font-bold py-1.5 px-3 rounded shadow-sm text-sm ml-2">ì´ˆê¸°í™”</button>
            </div>
            <p class="text-center text-xs text-gray-500 mb-4">â€» [ìë™] ìƒìœ„ ë­ì»¤ ìš°ì„  / [ëœë¤] ë¬´ì‘ìœ„ ì¶”ì²¨ / [ì…ë ¥] ìˆ˜ë™ ì„¤ì • <br> ìŠ¹ë¦¬í•œ ì„ ìˆ˜ë¥¼ í´ë¦­í•˜ë©´ ë‹¤ìŒ ë¼ìš´ë“œë¡œ ì§„ì¶œí•©ë‹ˆë‹¤.</p>
            <div id="bracketContainer" class="bracket-container custom-scrollbar"> <div class="w-full text-center text-gray-400 italic py-10">ìƒì„±ëœ í† ë„ˆë¨¼íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤. ìƒë‹¨ ë²„íŠ¼ìœ¼ë¡œ ëŒ€ì§„í‘œë¥¼ ìƒì„±í•˜ì„¸ìš”.</div> </div>
        </div>
    </div>

    <div id="tournamentSetupModal" class="modal hidden">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-11/12 max-w-lg max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4 border-b pb-2"> <h2 class="text-xl font-bold text-gray-800 flex items-center">âš”ï¸ 16ê°• ëŒ€ì§„í‘œ ì„¤ì •</h2> <button id="closeTournamentSetup" class="text-gray-400 hover:text-gray-700"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg></button> </div>
            <p class="text-sm text-gray-500 mb-4 text-center">ëª©ë¡ì—ì„œ ì„ íƒí•˜ê±°ë‚˜ ì´ë¦„ì„ ì§ì ‘ ì…ë ¥í•˜ì„¸ìš”.</p>
            <div id="setupGrid" class="grid grid-cols-2 gap-3 mb-6"></div> <datalist id="rankingOptions"></datalist> <button id="startManualTournamentBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg shadow transition duration-150">ëŒ€ì§„í‘œ ìƒì„± ì‹œì‘</button>
        </div>
    </div>

    <div id="randomTournamentModal" class="modal hidden">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-11/12 max-w-lg max-h-[90vh] overflow-y-auto flex flex-col">
            <div class="flex justify-between items-center mb-4 border-b pb-2"> <h2 class="text-xl font-bold text-gray-800 flex items-center">ğŸ² 16ê°• ëœë¤ ì¶”ì²¨ ì„¤ì •</h2> <button onclick="closeRandomTournamentSetup()" class="text-gray-400 hover:text-gray-700"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg></button> </div>
            <div class="mb-4"> <label class="block text-sm font-medium text-gray-700 mb-1">ì™¸ë¶€ ì„ ìˆ˜(ì–¸ë­) ì¶”ê°€</label> <div class="flex gap-2"> <input type="text" id="externalPlayerInput" class="flex-grow border rounded p-2 text-sm" placeholder="ì´ë¦„ ì…ë ¥ í›„ ì—”í„°" onkeypress="handleExternalInputKey(event)"> <button onclick="addExternalPlayer()" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm font-bold">ì¶”ê°€</button> </div> </div>
            <div class="flex justify-between items-end mb-2"> <div> <span class="text-sm font-bold text-gray-600 block mb-1">ì°¸ê°€ì ì„ íƒ (16ëª… í•„ìˆ˜)</span> <div class="text-xs"> <button onclick="selectAllRandomPlayers()" class="text-blue-600 hover:text-blue-800 font-medium underline">ì „ì²´ ì„ íƒ</button> <span class="text-gray-300 mx-1">|</span> <button onclick="deselectAllRandomPlayers()" class="text-gray-500 hover:text-gray-700 font-medium underline">ì „ì²´ í•´ì œ</button> </div> </div> <span id="selectedCount" class="font-bold text-red-500">0 / 16ëª…</span> </div>
            <div id="randomPlayerList" class="flex-grow overflow-y-auto border rounded-lg bg-gray-50 p-2 mb-4 h-64 custom-scrollbar space-y-1"></div> <button id="startRandomBtn" onclick="startRandomTournament()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg shadow transition duration-150 opacity-50 cursor-not-allowed" disabled>ğŸ² ëœë¤ ëŒ€ì§„ ìƒì„±í•˜ê¸°</button>
        </div>
    </div>

    <div id="matchModal" class="modal hidden">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-11/12 max-w-lg">
            <div class="relative flex justify-center items-center mb-4 border-b pb-2"> 
                <h2 class="text-xl font-bold text-gray-800 flex items-center">ğŸ¥Šë§¤ì¹˜ğŸ¥Š</h2> 
                <button id="closeMatchModal" class="absolute right-0 text-gray-400 hover:text-gray-700"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg></button> 
            </div>
            
            <div class="grid grid-cols-2 gap-4 mb-4"> 
                <div class="flex flex-col"> 
                    <label class="block text-sm font-bold text-blue-600 mb-1 text-center">ğŸŸ¦ ì²­ì½”ë„ˆ (Blue)</label> 
                    <select id="matchPlayer1" class="block w-full p-2 border border-blue-300 rounded-md bg-blue-50 text-gray-900 mb-2" onchange="handleMatchSelectChange()"><option value="">ì„ ìˆ˜ ì„ íƒ</option></select> 
                    <label class="flex items-center justify-center p-2 border border-blue-200 rounded-lg cursor-pointer hover:bg-blue-100 transition shadow-sm bg-white">
                        <input type="radio" name="matchResult" value="blue" class="w-4 h-4 text-blue-600 focus:ring-blue-500 border-gray-300 cursor-pointer" onchange="handleMatchResultChange()">
                        <span class="ml-2 text-sm font-bold text-blue-800">ğŸ¥Š ìŠ¹ë¦¬</span>
                    </label>
                </div> 
                <div class="flex flex-col"> 
                    <label class="block text-sm font-bold text-red-600 mb-1 text-center">ğŸŸ¥ í™ì½”ë„ˆ (Red)</label> 
                    <select id="matchPlayer2" class="block w-full p-2 border border-red-300 rounded-md bg-red-50 text-gray-900 mb-2" onchange="handleMatchSelectChange()"><option value="">ì„ ìˆ˜ ì„ íƒ</option></select> 
                    <label class="flex items-center justify-center p-2 border border-red-200 rounded-lg cursor-pointer hover:bg-red-100 transition shadow-sm bg-white">
                        <input type="radio" name="matchResult" value="red" class="w-4 h-4 text-red-600 focus:ring-red-500 border-gray-300 cursor-pointer" onchange="handleMatchResultChange()">
                        <span class="ml-2 text-sm font-bold text-red-800">ğŸ¥Š ìŠ¹ë¦¬</span>
                    </label>
                </div> 
            </div>
            
            <div id="externalInputDiv" class="hidden mb-4">
                <label class="block text-sm font-bold text-indigo-600 mb-1">ğŸ¥· ì™¸ë¶€ ë„ì „ì ì´ë¦„ ì…ë ¥</label>
                <input type="text" id="externalNameInput" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ë„ì „ìA)" class="w-full p-2 border-2 border-indigo-300 rounded-md focus:border-indigo-500 focus:outline-none">
            </div>

            <div id="predictionContainer" class="hidden mb-4 bg-gray-50 p-3 rounded-lg border border-gray-200"></div>

            <div class="bg-gray-50 p-3 rounded-lg border border-gray-200 text-center mb-4"> <p class="text-xs text-gray-500 mb-1">ì˜ˆìƒ ê²°ê³¼</p> <p id="matchResultPreview" class="text-sm font-bold text-gray-500">ë‘ ì„ ìˆ˜ë¥¼ ì„ íƒí•˜ê³  ìŠ¹ìë¥¼ ì²´í¬í•˜ì„¸ìš”.</p> </div>
            
            <div class="flex gap-2">
                <button id="applyFriendlyMatchButton" class="w-1/2 bg-green-100 hover:bg-green-200 text-green-800 border border-green-300 font-bold py-3 px-4 rounded-lg shadow-sm transition duration-150 flex justify-center items-center text-base sm:text-lg">
                    <span>ğŸ¤ ì¹œì„ ì „ ì €ì¥</span>
                </button>
                <button id="applyRankingMatchButton" class="w-1/2 bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-4 rounded-lg shadow transition duration-150 flex justify-center items-center text-base sm:text-lg">
                    <span>ğŸ† ë­í‚¹ì „ ì ìš©</span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Profile Modal (Updated Structure with Tabs) -->
    <div id="profileModal" class="modal hidden overflow-y-auto" style="align-items: flex-start; padding-top: 2rem; padding-bottom: 2rem;">
        <div class="bg-white rounded-xl shadow-2xl w-11/12 max-w-sm overflow-hidden transform transition-all relative flex flex-col my-auto mx-auto">
            <!-- ë‹«ê¸° ë²„íŠ¼ (ì´ë¯¸ì§€ ìœ„ í”Œë¡œíŒ…) -->
            <button id="closeProfileModalBtn" class="absolute top-3 right-3 text-white/90 hover:text-white bg-black/40 hover:bg-black/60 rounded-full p-1.5 transition z-50 backdrop-blur-sm">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
            </button>
            
            <!-- ì´ë¯¸ì§€ ì˜ì—­ (ë†’ì´ ê³ ì •) -->
            <div id="profileImageContainer" class="profile-image-container group h-64 shrink-0 relative bg-gray-200 cursor-pointer" title="í´ë¦­í•˜ì—¬ ì´ë¯¸ì§€ URL ìˆ˜ì •">
                <img id="profileImage" src="" alt="Profile" class="w-full h-full object-cover object-top">
            </div>
            
            <!-- í—¤ë”: ì´ë¦„ ë° ìˆœìœ„ -->
            <div class="px-5 pt-4 pb-2 text-center shrink-0">
                <div class="flex justify-center items-baseline space-x-2">
                    <h2 id="profileName" class="text-2xl font-black text-gray-800 tracking-tight">ë‹‰ë„¤ì„</h2>
                    <div id="profileRank" class="text-blue-600 font-bold text-xl">1ìœ„</div>
                </div>
                <!-- Game ID Input Field -->
                <div class="mt-1 flex justify-center">
                    <input type="text" id="profileGameId" placeholder="Game ID ì…ë ¥" class="text-center text-sm text-gray-500 font-medium bg-transparent border-b border-transparent hover:border-gray-300 focus:border-blue-500 focus:outline-none transition-colors w-full max-w-[200px]" title="ê²Œì„ ë‹‰ë„¤ì„ (í´ë¦­í•˜ì—¬ ìˆ˜ì •)">
                </div>
            </div>

            <!-- íƒ­ ë©”ë‰´ -->
            <div class="flex border-b border-gray-200 px-4 shrink-0">
                <button id="btnProfileTabInfo" onclick="switchProfileTab('info')" class="flex-1 py-2 text-sm font-bold text-blue-600 border-b-2 border-blue-500 transition-colors">ì •ë³´</button>
                <button id="btnProfileTabHistory" onclick="switchProfileTab('history')" class="flex-1 py-2 text-sm font-medium text-gray-400 border-b-2 border-transparent hover:text-gray-600 transition-colors">ê¸°ë¡</button>
                <button id="btnProfileTabMemo" onclick="switchProfileTab('memo')" class="flex-1 py-2 text-sm font-medium text-gray-400 border-b-2 border-transparent hover:text-gray-600 transition-colors">ë©”ëª¨</button>
            </div>

            <!-- íƒ­ ì½˜í…ì¸  ì˜ì—­ (ë‚´ë¶€ ìŠ¤í¬ë¡¤ ì œê±°ë¨) -->
            <div class="p-4 bg-white min-h-[340px] flex flex-col">
                
                <!-- Tab 1: ê¸°ë³¸ ì •ë³´ -->
                <div id="tabProfileInfo" class="space-y-4 h-full">
                    <div id="profileTags" class="flex flex-wrap justify-center gap-1 cursor-pointer min-h-[24px]" title="í´ë¦­í•˜ì—¬ íƒœê·¸ ìˆ˜ì •"></div>
                    
                    <div class="grid grid-cols-2 gap-3">
                        <div class="profile-stat-box flex flex-col items-center justify-center p-2 bg-gray-50 rounded border border-gray-100">
                            <div class="text-xs text-gray-400 font-bold mb-1">ì „ì </div>
                            <div id="profileRecord" class="text-base font-black text-gray-800">0ìŠ¹ 0íŒ¨</div>
                        </div>
                        <div class="profile-stat-box flex flex-col items-center justify-center p-2 bg-gray-50 rounded border border-gray-100">
                            <div class="text-xs text-gray-400 font-bold mb-1">ìŠ¹ë¥ </div>
                            <div id="profileWinRate" class="text-base font-black text-gray-800">0%</div>
                        </div>
                    </div>
                    
                    <div class="flex justify-between items-center border-b border-gray-100 pb-2">
                        <span class="text-sm font-bold text-gray-500">ğŸ“ˆ ì»¤ë¦¬ì–´ í•˜ì´</span>
                        <span id="profileHighRank" class="font-black text-amber-600 text-lg"></span>
                    </div>

                    <div>
                        <span class="text-xs font-bold text-gray-400 block mb-2">ğŸ†š ìƒì„± ë¶„ì„ (Auto)</span>
                        <div id="profileMatchupAnalysis" class="space-y-1"></div>
                    </div>
                </div>

                <!-- Tab 2: ê¸°ë¡ (History) - ì—¬ê¸°ë§Œ ìì²´ ìŠ¤í¬ë¡¤ ìœ ì§€ -->
                <div id="tabProfileHistory" class="hidden">
                    <div id="profileLogList" class="space-y-1 max-h-64 overflow-y-auto custom-scrollbar pr-1"></div>
                </div>

                <!-- Tab 3: ë©”ëª¨ (Admin Memo) -->
                <div id="tabProfileMemo" class="hidden h-full flex flex-col">
                    <p class="text-xs text-gray-400 mb-2">ê´€ë¦¬ì ì „ìš© ë¹„ë°€ ë©”ëª¨ì…ë‹ˆë‹¤. (ìë™ ì €ì¥)</p>
                    <textarea id="profileAdminMemo" class="w-full h-40 p-3 border border-gray-200 rounded-lg text-sm text-gray-700 bg-yellow-50 focus:ring-1 focus:ring-yellow-400 focus:border-yellow-400 resize-none placeholder-gray-400 focus:outline-none" placeholder="ì„ ìˆ˜ íŠ¹ì§•, ì—°ë½ì²˜ ë“±..."></textarea>
                </div>

            </div>
        </div>
    </div>

    <!-- Image Edit Modal -->
    <div id="imageEditModal" class="modal hidden">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-11/12 max-w-sm">
            <h2 class="text-lg font-bold text-gray-800 mb-4">ğŸ–¼ï¸ í”„ë¡œí•„ ì‚¬ì§„ ë³€ê²½</h2>
            <p class="text-xs text-gray-500 mb-2">ì´ë¯¸ì§€ ì£¼ì†Œ(URL)ë¥¼ ì…ë ¥í•˜ì„¸ìš”.<br>(ì˜ˆ: ì¹´ì¹´ì˜¤í†¡ í”„ë¡œí•„ ì´ë¯¸ì§€ ë§í¬ ë³µì‚¬)</p>
            <input type="text" id="newImageUrlInput" class="w-full border border-gray-300 rounded-lg p-2 text-sm mb-4 focus:ring-blue-500 focus:border-blue-500" placeholder="https://...">
            <div class="flex justify-end space-x-2">
                <button id="cancelImageEditBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-lg text-sm">ì·¨ì†Œ</button>
                <button id="saveImageEditBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg text-sm">ì €ì¥</button>
            </div>
        </div>
    </div>

    <!-- Non-Part Modal -->
    <div id="nonPartModal" class="modal hidden">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-11/12 max-w-sm">
            <div class="flex justify-between items-center mb-4 border-b pb-2"> <h2 class="text-xl font-bold text-gray-800 flex items-center">ğŸ˜´ ë¯¸ì°¸ì—¬ ì¸ì› ëª©ë¡</h2> <button id="closeNonPartModal" class="text-gray-400 hover:text-gray-700"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg></button> </div>
            <div id="nonPartList" class="max-h-[60vh] overflow-y-auto mb-4 bg-gray-50 p-3 rounded-lg border text-sm text-gray-700 space-y-1"></div> <div class="flex justify-center"> <button id="copyNonPartButton" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">ëª©ë¡ ë³µì‚¬</button> </div>
        </div>
    </div>

    <!-- Export Modal -->
    <div id="exportModal" class="modal hidden">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-11/12 max-w-lg">
            <h2 class="text-xl font-bold mb-4 text-gray-800">ğŸ“Š ë­í‚¹ ë°ì´í„° ë‚´ë³´ë‚´ê¸°</h2>
            <div class="mb-4"> <select id="exportFormatSelect" class="mt-1 block w-full py-2 text-base border-gray-300 rounded-md shadow-sm"> <option value="fixed_simple">PCë©”ëª¨ì¥ í˜•ì‹ (ì°¸ì—¬/ì „ì  ì œì™¸)</option> <option value="simple_name_rank">ì´ë¦„(ìˆœìœ„) - ì¹´í†¡ìš©</option> <option value="spreadsheet">ìŠ¤í”„ë ˆë“œì‹œíŠ¸/PC ë©”ëª¨ì¥ìš© (ì°¸ì—¬ í¬í•¨)</option> <option value="fixed_mobile_no_participation">PCë©”ëª¨ì¥ í˜•ì‹ (ì°¸ì—¬ ì œì™¸)</option> <option value="seed_code">ê°œë°œììš©: ì´ˆê¸° ë°ì´í„° ì½”ë“œ (JS)</option> </select> </div>
            <p id="exportHint" class="text-sm text-gray-600 mb-3"></p>
            <textarea id="exportContent" rows="10" class="w-full p-3 border border-gray-300 rounded-lg font-mono text-xs"></textarea>
            <div class="flex justify-end space-x-3 mt-4"> <button id="copyButton" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">ë‚´ìš© ë³µì‚¬</button> <button id="closeModal" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">ë‹«ê¸°</button> </div>
        </div>
    </div>

    <!-- VS Export Modal -->
    <div id="vsExportModal" class="modal hidden">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-11/12 max-w-lg">
            <h2 class="text-xl font-bold mb-4 text-gray-800">âš”ï¸ ê²½ê¸° ê¸°ë¡ ë³µì‚¬ (VS ëª©ë¡)</h2>
            <div class="mb-4">
                <select id="vsExportCountSelect" class="mt-1 block w-full py-2 text-base border-gray-300 rounded-md shadow-sm">
                    <option value="15">ìµœê·¼ 15ê°œ</option>
                    <option value="30">ìµœê·¼ 30ê°œ</option>
                    <option value="0">ì „ì²´ (All)</option>
                </select>
            </div>
            <textarea id="vsExportContent" rows="10" class="w-full p-3 border border-gray-300 rounded-lg font-mono text-xs"></textarea>
            <div class="flex justify-end space-x-3 mt-4">
                <button id="vsCopyButton" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">ë‚´ìš© ë³µì‚¬</button>
                <button id="closeVsModal" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">ë‹«ê¸°</button>
            </div>
        </div>
    </div>

    <!-- Tag Selection Modal -->
    <div id="tagSelectionModal" class="modal hidden">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-11/12 max-w-sm">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h2 class="text-xl font-bold text-gray-800">ğŸ·ï¸ ìŠ¤íƒ€ì¼ íƒœê·¸ ì„ íƒ</h2>
                <button id="closeTagModal" class="text-gray-400 hover:text-gray-700"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg></button>
            </div>
            <p class="text-xs text-gray-500 mb-3">ì„ ìˆ˜ì˜ ë³µì‹± ìŠ¤íƒ€ì¼ì„ ì„ íƒí•˜ì„¸ìš”.</p>
            <div id="predefinedTagsContainer" class="grid grid-cols-2 gap-2 mb-4 max-h-40 overflow-y-auto custom-scrollbar"></div>
            <div class="mb-4">
                <label class="block text-xs font-bold text-gray-500 mb-1">ì§ì ‘ ì…ë ¥ (ì½¤ë§ˆë¡œ êµ¬ë¶„)</label>
                <input type="text" id="customTagInput" class="w-full border border-gray-300 rounded p-2 text-sm focus:ring-blue-500 focus:border-blue-500" placeholder="ì˜ˆ: ë¬´í˜¸í¡, ì¢€ë¹„">
            </div>
            <button id="saveTagsBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition">íƒœê·¸ ì €ì¥</button>
        </div>
    </div>

    <!-- Backup & Restore Modal (UI Updated v1.70) -->
    <div id="backupRestoreModal" class="modal hidden">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-11/12 max-w-lg transition-all transform duration-300">
            <!-- Header -->
            <div class="flex justify-between items-center mb-6 border-b pb-4"> 
                <h2 class="text-xl font-bold text-gray-800 flex items-center">
                    <span class="mr-2 text-2xl">ğŸ’¾</span> ë°±ì—… ë° ë³µì›
                </h2> 
                <button id="closeBackupRestoreModal" class="text-gray-400 hover:text-gray-600 p-1 rounded-full hover:bg-gray-100 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                </button> 
            </div>
            
            <!-- Main Actions: Card Style -->
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
                <!-- Save Card -->
                <button id="downloadBackupBtn" class="group flex flex-col items-center justify-center p-6 bg-white border-2 border-blue-100 hover:border-blue-500 hover:bg-blue-50 rounded-2xl transition-all duration-200 shadow-sm hover:shadow-md h-40 relative overflow-hidden">
                    <div class="bg-blue-100 text-blue-600 p-3 rounded-full mb-3 group-hover:bg-blue-600 group-hover:text-white transition-colors duration-200 z-10"> 
                        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-download"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg> 
                    </div>
                    <span class="font-bold text-gray-800 text-lg group-hover:text-blue-700 z-10">íŒŒì¼ ì €ì¥</span>
                    <span class="text-xs text-gray-500 mt-1 z-10">ë‚´ PCì— ë°±ì—… (.json)</span>
                    <div class="absolute inset-0 bg-blue-200 opacity-0 group-hover:opacity-10 transition-opacity duration-200"></div>
                </button>
                
                <!-- Load Card (Input Label) -->
                <label for="uploadBackupInput" class="group flex flex-col items-center justify-center p-6 bg-white border-2 border-green-100 hover:border-green-500 hover:bg-green-50 rounded-2xl transition-all duration-200 shadow-sm hover:shadow-md h-40 cursor-pointer relative overflow-hidden">
                    <div class="bg-green-100 text-green-600 p-3 rounded-full mb-3 group-hover:bg-green-600 group-hover:text-white transition-colors duration-200 z-10"> 
                        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-upload"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg> 
                    </div>
                    <span class="font-bold text-gray-800 text-lg group-hover:text-green-700 z-10">íŒŒì¼ ë³µì›</span>
                    <span class="text-xs text-gray-500 mt-1 z-10">ì €ì¥ëœ íŒŒì¼ ì„ íƒ</span>
                    <input type="file" id="uploadBackupInput" accept=".json" class="hidden">
                    <div class="absolute inset-0 bg-green-200 opacity-0 group-hover:opacity-10 transition-opacity duration-200"></div>
                </label>
            </div>

            <!-- Advanced Options: Accordion -->
            <details class="group border-t border-gray-100 pt-4">
                <summary class="flex justify-between items-center font-medium cursor-pointer list-none text-gray-400 hover:text-gray-600 text-sm select-none p-2 hover:bg-gray-50 rounded-lg transition">
                    <span class="flex items-center"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-code mr-2"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg> í…ìŠ¤íŠ¸ë¡œ ë°±ì—…/ë³µì› (ê³ ê¸‰)</span>
                    <span class="transition-transform duration-200 group-open:rotate-180">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-down"><path d="m6 9 6 6 6-6"/></svg>
                    </span>
                </summary>
                <div class="text-gray-500 mt-3 pl-2 pr-2 pb-2">
                    <textarea id="backupTextArea" class="w-full p-3 border border-gray-200 rounded-lg text-xs h-24 mb-3 font-mono bg-gray-50 focus:bg-white focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition shadow-inner resize-none" placeholder='{"rankings": [...], "logs": [...]} ë°ì´í„° í…ìŠ¤íŠ¸ë¥¼ ì´ê³³ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.'></textarea>
                    <div class="flex gap-2">
                        <button id="copyBackupTextBtn" class="flex-1 bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 font-bold py-2 rounded-lg text-xs transition shadow-sm flex justify-center items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy mr-1"><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>
                            í…ìŠ¤íŠ¸ ë³µì‚¬
                        </button>
                        <button id="pasteRestoreBtn" class="flex-1 bg-indigo-50 hover:bg-indigo-100 text-indigo-600 border border-indigo-200 font-bold py-2 rounded-lg text-xs transition shadow-sm flex justify-center items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-refresh-ccw mr-1"><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"/><path d="M16 16h5v5"/></svg>
                            í…ìŠ¤íŠ¸ë¡œ ë³µì›
                        </button>
                    </div>
                </div>
            </details>
        </div>
    </div>

    <!-- Confirm Modal -->
    <div id="confirmModal" class="modal hidden">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-11/12 max-w-sm text-center">
            <div class="mb-4 text-amber-500 flex justify-center"> <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-alert-circle"><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg> </div>
            <h3 class="text-lg font-bold text-gray-800 mb-2">í™•ì¸</h3>
            <div id="confirmMessage" class="text-sm text-gray-600 mb-6">ì •ë§ ì‹¤í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</div>
            <div class="flex justify-center gap-3"> <button id="confirmNoBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-5 rounded-lg transition">ì·¨ì†Œ</button> <button id="confirmYesBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-5 rounded-lg transition">í™•ì¸</button> </div>
        </div>
    </div>

    <!-- Print Preview Modal -->
    <div id="printPreviewModal" class="modal hidden">
        <div class="bg-white rounded-xl shadow-2xl w-11/12 max-w-[45rem] max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center p-4 border-b"> <h2 class="text-lg font-bold text-gray-800">ğŸ–¨ï¸ ì¸ì‡„ / ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°</h2> <button id="closePreviewModalX" class="text-gray-400 hover:text-gray-700"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg></button> </div>
            <div class="p-4 bg-gray-100 flex-grow overflow-auto flex justify-center"> <div id="printPreviewContentDiv" class="bg-white shadow-lg w-full max-w-none"></div> </div>
            <div class="p-4 border-t bg-gray-50 flex justify-end gap-3"> <button id="closePreviewModal" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">ë‹«ê¸°</button> <button id="saveImageButton" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow flex items-center"> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-image mr-2"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg> ì´ë¯¸ì§€ ì €ì¥ </button> <button id="printNowButton" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow flex items-center"> <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-printer mr-2"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect width="12" height="8" x="6" y="14"/></svg> ì¸ì‡„í•˜ê¸° </button> </div>
        </div>
    </div>

</body>
</html>