<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RFC ë­í‚¹ì „ (v2.1 Hybrid)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Pretendard', sans-serif; background-color: #f1f5f9; -webkit-tap-highlight-color: transparent; }
        
        /* í‹°ì–´ë³„ ìŠ¤íƒ€ì¼ */
        .tier-bronze { border-left: 4px solid #ad8a56; background: linear-gradient(90deg, #fff 0%, #fdfbf7 100%); }
        .tier-silver { border-left: 4px solid #94a3b8; background: linear-gradient(90deg, #fff 0%, #f8fafc 100%); }
        .tier-gold { border-left: 4px solid #f59e0b; background: linear-gradient(90deg, #fff 0%, #fffbeb 100%); }
        
        /* ë­í‚¹ ìˆ«ì */
        .rank-num-1 { color: #f59e0b; font-size: 1.5rem; text-shadow: 0 2px 4px rgba(245, 158, 11, 0.2); }
        .rank-num-2 { color: #94a3b8; font-size: 1.4rem; }
        .rank-num-3 { color: #ad8a56; font-size: 1.3rem; }
        
        /* ì• ë‹ˆë©”ì´ì…˜ */
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* íƒ­ ìŠ¤íƒ€ì¼ */
        .tab-active { color: #2563eb; border-bottom: 2px solid #2563eb; font-weight: 700; }
        .tab-inactive { color: #64748b; border-bottom: 2px solid transparent; font-weight: 500; }

        .modal-enter { animation: modalSlideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes modalSlideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 pb-20">

    <header class="bg-white sticky top-0 z-40 shadow-sm border-b border-slate-200">
        <div class="max-w-3xl mx-auto px-4 py-3 flex justify-between items-center">
            <div>
                <h1 class="text-xl font-black italic tracking-tighter text-slate-900 flex items-center gap-1">
                    <span class="text-blue-600">RFC</span> RANKING
                </h1>
                <p id="currentDate" class="text-xs text-slate-400 font-medium mt-0.5">Loading...</p>
            </div>
            <div class="flex gap-2">
                <button onclick="openRules()" class="bg-slate-100 text-slate-600 text-xs font-bold px-3 py-1.5 rounded-lg border border-slate-200 hover:bg-slate-200 transition">
                    ğŸ“œ ê·œì¹™
                </button>
                <div id="seasonBadge" class="bg-slate-900 text-white text-xs font-bold px-3 py-1.5 rounded-full shadow-lg shadow-slate-500/20">
                    -
                </div>
            </div>
        </div>
        
        <nav class="flex border-t border-slate-100 max-w-3xl mx-auto">
            <button onclick="switchTab('ranking')" id="tabRanking" class="tab-active flex-1 py-3 text-sm transition-colors text-center">ğŸ”¥ ë­í‚¹</button>
            <button onclick="switchTab('matches')" id="tabMatches" class="tab-inactive flex-1 py-3 text-sm transition-colors text-center">âš”ï¸ ê¸°ë¡</button>
            <button onclick="switchTab('hof')" id="tabHof" class="tab-inactive flex-1 py-3 text-sm transition-colors text-center">ğŸ›ï¸ ì „ë‹¹</button>
            <button onclick="switchTab('tournament')" id="tabTournament" class="tab-inactive flex-1 py-3 text-sm transition-colors text-center">ğŸ† ëŒ€ì§„</button>
        </nav>
    </header>

    <main class="max-w-3xl mx-auto p-3 min-h-screen">
        
        <div id="rankingSection" class="fade-in space-y-3">
            <div class="flex justify-between items-end px-1 pb-1">
                <span class="text-xs font-bold text-slate-400">Hybrid ELO ê¸°ì¤€ ì •ë ¬</span>
                <span class="text-[10px] text-slate-400 bg-white border px-2 py-1 rounded-full">âš¡ Elo + ğŸ›¡ï¸ ë°©ì–´ì „</span>
            </div>
            <div id="rankingList" class="space-y-2.5">
                <div class="text-center py-10 text-slate-400 text-sm">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>
            </div>
        </div>

        <div id="matchesSection" class="hidden fade-in space-y-4">
            <div class="bg-white p-3 rounded-xl border border-slate-200 shadow-sm flex items-center justify-between">
                <span class="text-sm font-bold text-slate-600">ì‹œì¦Œ ì„ íƒ</span>
                <select id="seasonSelector" class="text-sm font-bold text-slate-800 bg-slate-50 border border-slate-200 rounded-lg p-2 outline-none focus:ring-2 focus:ring-blue-500"></select>
            </div>
            <div id="matchList" class="space-y-2"></div>
        </div>

        <div id="hofSection" class="hidden fade-in">
            <div id="hofContent" class="space-y-6"></div>
        </div>

        <div id="tournamentSection" class="hidden fade-in">
            <div id="bracketContainer" class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 overflow-x-auto min-h-[300px] flex items-center justify-center text-slate-400 text-sm">
                ì§„í–‰ ì¤‘ì¸ í† ë„ˆë¨¼íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.
            </div>
        </div>

    </main>

    <div id="profileModal" class="fixed inset-0 z-50 hidden" role="dialog" aria-modal="true">
        <div class="absolute inset-0 bg-slate-900/80 backdrop-blur-sm transition-opacity" onclick="closeProfile()"></div>
        <div class="absolute bottom-0 left-0 right-0 bg-white rounded-t-3xl shadow-[0_-10px_40px_rgba(0,0,0,0.2)] max-w-3xl mx-auto h-[90vh] overflow-y-auto modal-enter flex flex-col">
            
            <div class="sticky top-0 bg-white/95 backdrop-blur z-10 pt-3 pb-2 flex justify-center cursor-pointer border-b border-slate-100" onclick="closeProfile()">
                <div class="w-12 h-1.5 bg-slate-200 rounded-full"></div>
            </div>
            
            <div class="px-6 pb-8 relative mt-4">
                <button onclick="closeProfile()" class="absolute top-0 right-4 text-slate-400 hover:text-slate-600 p-2 text-2xl font-bold z-20">âœ•</button>
                
                <div class="flex flex-col items-center">
                    <div class="relative mb-6">
                        <img id="pModalImg" src="" class="w-64 h-64 rounded-2xl object-cover shadow-2xl bg-slate-100">
                        <div id="pModalTierBadge" class="absolute -bottom-3 -right-3 bg-slate-800 text-white text-xs font-bold px-4 py-1.5 rounded-full border-4 border-white shadow-md">
                            Bronze
                        </div>
                    </div>
                    
                    <h2 class="text-3xl font-black text-slate-800 flex items-center gap-2 mb-1">
                        <span id="pModalName">Name</span>
                        <span id="pModalCrown" class="text-2xl"></span>
                    </h2>
                    <p id="pModalGameId" class="text-sm text-slate-500 font-medium mb-6">Game ID: -</p>
                    
                    <div class="grid grid-cols-3 gap-3 w-full mb-8">
                        <div class="bg-slate-50 p-4 rounded-2xl text-center border border-slate-100">
                            <div class="text-[10px] text-slate-400 font-bold uppercase tracking-wider mb-1">Elo Score</div>
                            <div id="pModalElo" class="text-2xl font-black text-amber-500">1000</div>
                        </div>
                        <div class="bg-slate-50 p-4 rounded-2xl text-center border border-slate-100">
                            <div class="text-[10px] text-slate-400 font-bold uppercase tracking-wider mb-1">Rank</div>
                            <div id="pModalRank" class="text-2xl font-black text-slate-700"># -</div>
                        </div>
                        <div class="bg-slate-50 p-4 rounded-2xl text-center border border-slate-100">
                            <div class="text-[10px] text-slate-400 font-bold uppercase tracking-wider mb-1">Win Rate</div>
                            <div id="pModalWinRate" class="text-2xl font-black text-blue-600">0%</div>
                        </div>
                    </div>

                    <div class="w-full space-y-6">
                        <div class="bg-white rounded-2xl p-5 border border-slate-200 shadow-sm">
                            <h3 class="text-xs font-bold text-slate-400 uppercase mb-4 border-b border-slate-100 pb-2">Physical & Style</h3>
                            <div class="grid grid-cols-3 gap-4 text-center">
                                <div><div class="text-xs text-slate-400 mb-1">Height</div><div id="pModalHeight" class="font-bold text-slate-700 text-lg">-</div></div>
                                <div class="border-x border-slate-100"><div class="text-xs text-slate-400 mb-1">Reach</div><div id="pModalReach" class="font-bold text-slate-700 text-lg">-</div></div>
                                <div><div class="text-xs text-slate-400 mb-1">Stance</div><div id="pModalStance" class="font-bold text-slate-700 text-lg">-</div></div>
                            </div>
                            <div id="pModalTags" class="flex flex-wrap gap-2 justify-center mt-5"></div>
                        </div>

                        <div>
                            <div class="flex justify-between items-center mb-3 px-1">
                                <h3 class="text-sm font-bold text-slate-700 flex gap-2 items-center">
                                    Recent Bouts 
                                    <span class="text-xs font-normal text-slate-400" id="pModalRecordText">(0ìŠ¹ 0íŒ¨)</span>
                                </h3>
                                <select id="pModalSeason" class="text-xs bg-transparent font-bold text-blue-600 outline-none cursor-pointer">
                                    <option value="all">ì „ì²´ ê¸°ë¡</option>
                                    <option value="current">í˜„ì¬ ì‹œì¦Œ</option>
                                </select>
                            </div>
                            <div id="pModalMatchList" class="space-y-2 pb-10"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="rulesModal" class="fixed inset-0 z-[60] hidden" role="dialog" aria-modal="true">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onclick="closeRules()"></div>
        <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white rounded-2xl shadow-2xl w-11/12 max-w-md p-6 max-h-[80vh] overflow-y-auto">
            <h2 class="text-xl font-black text-slate-800 mb-4 border-b pb-2">ğŸ“œ RFC Hybrid ELO ê·œì¹™</h2>
            
            <div class="space-y-4 text-sm text-slate-600">
                <div class="bg-blue-50 p-3 rounded-lg border border-blue-100">
                    <h3 class="font-bold text-blue-700 mb-1">1. ì ìˆ˜ ê³„ì‚° (Hybrid)</h3>
                    <p class="mb-1">â€¢ ìŠ¹íŒ¨ ì ìˆ˜(Elo) + <span class="text-red-500 font-bold">ì°¸ì—¬ ë³´ë„ˆìŠ¤ 10ì </span></p>
                    <p class="text-xs text-slate-500">ì§€ë”ë¼ë„ ì°¸ì—¬ ì ìˆ˜ ë•ë¶„ì— ì†í•´ë¥¼ ìµœì†Œí™”í•˜ê±°ë‚˜ ì˜¤íˆë ¤ ì ìˆ˜ê°€ ì˜¤ë¥¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                </div>

                <div>
                    <h3 class="font-bold text-slate-800 mb-2">2. í‹°ì–´ë³„ í˜œíƒ (ì‹œì¦Œ ëˆ„ì  ê²½ê¸° ìˆ˜)</h3>
                    <ul class="list-disc pl-4 space-y-1 text-xs">
                        <li><span class="font-bold text-amber-700">ğŸ¥‰ ë¸Œë¡ ì¦ˆ (0~3ì „):</span> ê¸°ë³¸ ì ìˆ˜</li>
                        <li><span class="font-bold text-slate-500">ğŸ¥ˆ ì‹¤ë²„ (4~6ì „):</span> ìŠ¹ë¦¬ ì‹œ ì ìˆ˜ <span class="text-blue-600">1.1ë°°</span></li>
                        <li><span class="font-bold text-amber-500">ğŸ¥‡ ê³¨ë“œ (7ì „ ì´ìƒ):</span> ìŠ¹ë¦¬ ì‹œ <span class="text-blue-600">1.2ë°°</span>, íŒ¨ë°° ì‹œ ê°ì  <span class="text-green-600">10% ë©´ì œ</span></li>
                    </ul>
                </div>

                <div>
                    <h3 class="font-bold text-slate-800 mb-2">3. ë³´í˜¸ ë° ê°•ë“± ì‹œìŠ¤í…œ</h3>
                    <div class="space-y-2">
                        <div class="p-2 bg-slate-50 rounded border border-slate-100">
                            <span class="font-bold text-xs block">ğŸ›¡ï¸ íŒ¨ë°° í•˜í•œì„  (Max Loss)</span>
                            <span class="text-xs">ì••ë„ì ì¸ ìƒëŒ€ì—ê²Œ ì ¸ë„ ìµœëŒ€ <span class="text-red-500 font-bold">-20ì </span>ê¹Œì§€ë§Œ ê¹ì…ë‹ˆë‹¤.</span>
                        </div>
                        <div class="p-2 bg-orange-50 rounded border border-orange-100">
                            <span class="font-bold text-xs text-orange-700 block">ğŸ“‰ íœ´ë©´ ê°•ë“± (Decay)</span>
                            <span class="text-xs">ë§ˆì§€ë§‰ ê²½ê¸° í›„ <span class="font-bold">5ì¼</span> ê²½ê³¼ ì‹œ, ë§¤ì¼ <span class="text-red-500 font-bold">-5ì </span>ì”© ìë™ ì°¨ê°ë©ë‹ˆë‹¤.</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <button onclick="closeRules()" class="w-full mt-6 bg-slate-800 text-white font-bold py-3 rounded-xl">í™•ì¸í–ˆìŠµë‹ˆë‹¤</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDlj68ex-fM0ExRdD-tvCy-UyIneVoPmGk",
            authDomain: "rfk-ranking.firebaseapp.com",
            projectId: "rfk-ranking",
            storageBucket: "rfk-ranking.firebasestorage.app",
            messagingSenderId: "675366165774",
            appId: "1:675366165774:web:795d34c56eab630b4dcb5f",
            measurementId: "G-CXPDZQ8GTL"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const appId = 'ranking-manager-default';

        let rankingsData = [];
        let matchHistoryData = [];
        let seasonArchives = {};
        let activeSeason = "";
        let viewSeason = "";
        let currentProfileId = null;

        const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'rankings', 'main');
        onSnapshot(docRef, (docSnapshot) => {
            if (docSnapshot.exists()) {
                const data = docSnapshot.data();
                rankingsData = data.rankings || [];
                matchHistoryData = data.matchHistory || [];
                activeSeason = data.activeSeason || "ì‹œì¦Œ 1";
                seasonArchives = data.seasonArchives || {};
                
                if (!viewSeason) viewSeason = activeSeason;

                // ELO ê¸°ì¤€ ì •ë ¬
                rankingsData.sort((a, b) => (b.elo || 1000) - (a.elo || 1000));

                updateUI();
                
                if (currentProfileId) {
                    renderProfileMatches(currentProfileId, document.getElementById('pModalSeason').value);
                }
            }
        });

        function updateUI() {
            const now = new Date();
            document.getElementById('currentDate').textContent = now.toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric' });
            document.getElementById('seasonBadge').textContent = activeSeason;

            renderRankings();
            updateSeasonSelector();
            renderMatches();
            renderHOF();
        }

        // ë¬´ìŠ¹ë¶€ ì œì™¸í•˜ê³  ê²½ê¸° ìˆ˜ ê³„ì‚°
        function getTier(wins, losses) {
            const matches = (wins || 0) + (losses || 0); // Draws ì œì™¸
            if (matches < 4) return { name: 'Bronze', class: 'tier-bronze', color: 'text-slate-500' };
            if (matches < 7) return { name: 'Silver', class: 'tier-silver', color: 'text-slate-400' };
            return { name: 'Gold', class: 'tier-gold', color: 'text-amber-500' };
        }

        function renderRankings() {
            const container = document.getElementById('rankingList');
            container.innerHTML = '';

            rankingsData.forEach((p, idx) => {
                const rank = idx + 1;
                const tier = getTier(p.wins, p.losses);
                
                const prevRank = p.previousRank || rank;
                const diff = prevRank - rank;
                let diffHtml = `<span class="text-slate-300">-</span>`;
                if (diff > 0) diffHtml = `<span class="text-rose-500 font-bold text-xs">â–²${diff}</span>`;
                else if (diff < 0) diffHtml = `<span class="text-blue-500 font-bold text-xs">â–¼${Math.abs(diff)}</span>`;

                let rankNumClass = "text-slate-400 font-bold text-lg";
                if (rank === 1) rankNumClass = "rank-num-1 font-black";
                else if (rank === 2) rankNumClass = "rank-num-2 font-black";
                else if (rank === 3) rankNumClass = "rank-num-3 font-black";

                // ìµœê·¼ ì „ì  (ë¬´ìŠ¹ë¶€ ì œì™¸)
                const myMatches = matchHistoryData
                    .filter(m => (m.winner === p.name || m.loser === p.name) && m.season === activeSeason && m.type !== 'draw')
                    .slice(0, 5);
                
                let dots = '';
                myMatches.forEach(m => {
                    if (m.winner === p.name) dots += `<div class="w-1.5 h-1.5 rounded-full bg-emerald-500"></div>`;
                    else dots += `<div class="w-1.5 h-1.5 rounded-full bg-rose-500"></div>`;
                });

                const div = document.createElement('div');
                div.className = `bg-white rounded-xl p-3 shadow-sm border border-slate-100 flex items-center gap-3 relative overflow-hidden transition-transform active:scale-[0.99] cursor-pointer ${tier.class}`;
                div.onclick = () => openProfile(p.id);
                
                div.innerHTML = `
                    <div class="flex flex-col items-center justify-center w-8 shrink-0">
                        <span class="${rankNumClass}">${rank}</span>
                        <div class="mt-0.5">${diffHtml}</div>
                    </div>
                    
                    <div class="shrink-0 relative">
                        ${p.imageUrl ? `<img src="${p.imageUrl}" class="w-10 h-10 rounded-full bg-slate-100 object-cover border border-slate-100">` : `<div class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center text-lg">ğŸ‘¤</div>`}
                        ${rank === 1 ? `<div class="absolute -top-1 -right-1 text-sm">ğŸ‘‘</div>` : ''}
                    </div>

                    <div class="flex-grow min-w-0">
                        <div class="flex items-center gap-1.5 mb-0.5">
                            <span class="font-bold text-slate-800 truncate text-sm">${p.name}</span>
                            <span class="text-[9px] px-1.5 py-0.5 rounded bg-slate-100 text-slate-500 font-bold border border-slate-200">${tier.name}</span>
                        </div>
                        <div class="flex items-center gap-2 text-xs">
                            <span class="font-bold text-amber-600 bg-amber-50 px-1 rounded">âš¡${p.elo || 1000}</span>
                            <span class="text-slate-400">|</span>
                            <span class="text-slate-500 font-medium">${p.wins}W ${p.losses}L</span>
                        </div>
                    </div>

                    <div class="flex flex-col items-end gap-1.5 shrink-0">
                        ${p.defenseCount > 0 ? `<div class="text-[10px] bg-yellow-100 text-yellow-700 px-1.5 py-0.5 rounded-full font-bold border border-yellow-200 flex items-center gap-0.5">ğŸ›¡ï¸${p.defenseCount}</div>` : ''}
                        <div class="flex gap-0.5">${dots}</div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function updateSeasonSelector() {
            const selector = document.getElementById('seasonSelector');
            selector.innerHTML = '';
            const opts = [activeSeason, ...Object.keys(seasonArchives).sort().reverse().filter(s => s !== activeSeason)];
            opts.forEach(s => {
                const opt = document.createElement('option');
                opt.value = s;
                opt.textContent = s + (s === activeSeason ? " (ì§„í–‰ì¤‘)" : "");
                selector.appendChild(opt);
            });
            selector.value = viewSeason;
            selector.onchange = (e) => { viewSeason = e.target.value; renderMatches(); renderHOF(); };
        }

        function renderMatches() {
            const container = document.getElementById('matchList');
            container.innerHTML = '';
            // ë¬´ìŠ¹ë¶€ í•„í„°ë§
            const filtered = matchHistoryData.filter(m => (m.season || "ì‹œì¦Œ 1") === viewSeason && m.type !== 'draw');
            
            if (filtered.length === 0) {
                container.innerHTML = `<div class="text-center py-10 text-slate-400 text-sm">ê¸°ë¡ëœ ê²½ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
                return;
            }

            filtered.forEach(m => {
                const isDef = m.type === 'defense';
                let badge = `<span class="bg-slate-100 text-slate-500 text-[10px] font-bold px-1.5 py-0.5 rounded">ì¼ë°˜</span>`;
                if (isDef) badge = `<span class="bg-blue-100 text-blue-600 text-[10px] font-bold px-1.5 py-0.5 rounded">ë°©ì–´ì „</span>`;
                if (m.type === 'challenge_success') badge = `<span class="bg-rose-100 text-rose-600 text-[10px] font-bold px-1.5 py-0.5 rounded">ì—…ì…‹</span>`;

                const div = document.createElement('div');
                div.className = "bg-white p-3 rounded-xl border border-slate-200 shadow-sm flex flex-col gap-2";
                div.innerHTML = `
                    <div class="flex justify-between items-center border-b border-slate-50 pb-2">
                        <span class="text-[10px] font-bold text-slate-400">${m.date}</span>
                        ${badge}
                    </div>
                    <div class="flex items-center justify-between text-sm px-2">
                        <span class="font-bold ${m.winner === m.blue ? 'text-blue-600' : 'text-rose-600'} w-[40%] text-right truncate">${m.winner}</span>
                        <span class="text-xs text-slate-300 font-bold">VS</span>
                        <span class="font-medium text-slate-500 w-[40%] text-left truncate">${m.loser}</span>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function renderHOF() {
            const container = document.getElementById('hofContent');
            let data = null;

            if (viewSeason === activeSeason) {
                if (rankingsData.length > 0) {
                    const maxDef = Math.max(...rankingsData.map(p => p.defenseCount || 0), 0);
                    const defKings = rankingsData.filter(p => (p.defenseCount||0) === maxDef && maxDef > 0).map(p => p.name).join(', ');
                    
                    data = {
                        season: activeSeason + " (ì§„í–‰ì¤‘)",
                        champion: rankingsData[0]?.name || "-",
                        rank2: rankingsData[1]?.name || "-",
                        rank3: rankingsData[2]?.name || "-",
                        defKing: defKings || "-",
                        defCount: maxDef
                    };
                }
            } else {
                const arc = seasonArchives[viewSeason];
                if (arc) {
                    data = {
                        season: viewSeason,
                        champion: arc.champion,
                        rank2: arc.rank2 || "-",
                        rank3: arc.rank3 || "-",
                        defKing: arc.defenseKing || "-",
                        defCount: arc.defenseCount || 0
                    };
                }
            }

            if (!data) {
                container.innerHTML = `<div class="text-center py-10 text-slate-400">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>`;
                return;
            }

            container.innerHTML = `
                <div class="text-center mb-6">
                    <h3 class="text-lg font-black text-slate-800">${data.season}</h3>
                </div>
                
                <div class="grid grid-cols-3 gap-3 items-end text-center mb-8 px-2">
                    <div class="bg-white p-3 rounded-t-xl border-t-4 border-slate-300 shadow-sm order-1 h-32 flex flex-col justify-end pb-2">
                        <div class="text-2xl mb-1">ğŸ¥ˆ</div>
                        <div class="font-bold text-slate-700 text-sm truncate">${data.rank2}</div>
                    </div>
                    <div class="bg-white p-3 rounded-t-xl border-t-4 border-amber-400 shadow-md order-2 h-40 flex flex-col justify-end pb-4 relative z-10 -mx-1">
                        <div class="text-4xl mb-1">ğŸ‘‘</div>
                        <div class="font-black text-slate-800 truncate">${data.champion}</div>
                    </div>
                    <div class="bg-white p-3 rounded-t-xl border-t-4 border-amber-700 shadow-sm order-3 h-28 flex flex-col justify-end pb-2">
                        <div class="text-2xl mb-1">ğŸ¥‰</div>
                        <div class="font-bold text-slate-700 text-sm truncate">${data.rank3}</div>
                    </div>
                </div>

                <div class="bg-white rounded-xl p-4 shadow-sm border border-slate-200 flex items-center justify-between">
                    <div>
                        <div class="text-xs font-bold text-slate-400 uppercase">Best Defender</div>
                        <div class="font-bold text-slate-700 text-lg">${data.defKing}</div>
                    </div>
                    <div class="text-right">
                        <div class="text-2xl font-black text-blue-600">${data.defCount}</div>
                        <div class="text-[10px] text-blue-400 font-bold">DEFENSES</div>
                    </div>
                </div>
            `;
        }

        window.openProfile = (id) => {
            currentProfileId = id;
            const p = rankingsData.find(x => x.id === id);
            if (!p) return;

            document.getElementById('pModalName').textContent = p.name;
            document.getElementById('pModalCrown').textContent = (rankingsData.indexOf(p) === 0) ? 'ğŸ‘‘' : '';
            document.getElementById('pModalGameId').textContent = `Game ID: ${p.gameId || '-'}`;
            document.getElementById('pModalImg').src = p.imageUrl || "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23cbd5e1' stroke-width='2'%3E%3Ccircle cx='12' cy='8' r='5'/%3E%3Cpath d='M20 21a8 8 0 0 0-16 0'/%3E%3C/svg%3E";

            const tier = getTier(p.wins, p.losses);
            const tierEl = document.getElementById('pModalTierBadge');
            tierEl.textContent = tier.name;
            tierEl.className = `absolute -bottom-3 -right-3 text-white text-xs font-bold px-4 py-1.5 rounded-full border-4 border-white shadow-md ${tier.name === 'Gold' ? 'bg-amber-500' : (tier.name === 'Silver' ? 'bg-slate-400' : 'bg-amber-700')}`;

            document.getElementById('pModalElo').textContent = p.elo || 1000;
            document.getElementById('pModalRank').textContent = '#' + (rankingsData.indexOf(p) + 1);
            
            // ìŠ¹ë¥  ê³„ì‚° (ë¬´ìŠ¹ë¶€ ì œì™¸)
            const totalMatches = (p.wins || 0) + (p.losses || 0);
            const winRate = totalMatches > 0 ? Math.round((p.wins / totalMatches) * 100) : 0;
            document.getElementById('pModalWinRate').textContent = `${winRate}%`;
            
            // ì „ì  í‘œì‹œ (ë¬´ìŠ¹ë¶€ ì œì™¸)
            document.getElementById('pModalRecordText').textContent = `(${p.wins}ìŠ¹ ${p.losses}íŒ¨)`;

            document.getElementById('pModalHeight').textContent = p.height ? p.height + 'cm' : '-';
            document.getElementById('pModalReach').textContent = p.reach ? p.reach + 'cm' : '-';
            document.getElementById('pModalStance').textContent = p.stance || '-';
            
            const tagsContainer = document.getElementById('pModalTags');
            tagsContainer.innerHTML = '';
            (p.tags || []).forEach(tag => {
                tagsContainer.innerHTML += `<span class="text-[10px] font-bold text-slate-500 bg-slate-100 px-3 py-1 rounded-full border border-slate-200">#${tag}</span>`;
            });

            const filterEl = document.getElementById('pModalSeason');
            filterEl.value = 'all';
            filterEl.onchange = (e) => renderProfileMatches(id, e.target.value);
            renderProfileMatches(id, 'all');

            document.getElementById('profileModal').classList.remove('hidden');
        };

        window.closeProfile = () => {
            document.getElementById('profileModal').classList.add('hidden');
        }

        window.renderProfileMatches = (id, filter) => {
            const container = document.getElementById('pModalMatchList');
            container.innerHTML = '';
            const p = rankingsData.find(x => x.id === id);
            
            // ë¬´ìŠ¹ë¶€ ì œì™¸ í•„í„°ë§
            let matches = matchHistoryData.filter(m => (m.winner === p.name || m.loser === p.name) && m.type !== 'draw');
            if (filter === 'current') matches = matches.filter(m => m.season === activeSeason);

            if (matches.length === 0) {
                container.innerHTML = `<div class="text-center text-xs text-slate-400 py-4">ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
                return;
            }

            matches.forEach(m => {
                const isWin = m.winner === p.name;
                const resultText = isWin ? 'W' : 'L';
                const resultColor = isWin ? 'bg-emerald-100 text-emerald-600' : 'bg-rose-100 text-rose-600';
                const oppName = isWin ? m.loser : m.winner;

                const div = document.createElement('div');
                div.className = "flex items-center justify-between text-xs p-3 bg-slate-50 rounded-xl border border-slate-100";
                div.innerHTML = `
                    <div class="flex items-center gap-3">
                        <span class="font-bold ${resultColor} w-8 h-8 flex items-center justify-center rounded-lg text-sm">${resultText}</span>
                        <div class="flex flex-col">
                            <span class="font-bold text-slate-700 text-sm">vs ${oppName}</span>
                            <span class="text-slate-400 font-medium text-[10px]">${m.date}</span>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
        };

        window.openRules = () => document.getElementById('rulesModal').classList.remove('hidden');
        window.closeRules = () => document.getElementById('rulesModal').classList.add('hidden');

        window.switchTab = (tab) => {
            ['ranking', 'matches', 'hof', 'tournament'].forEach(t => {
                document.getElementById(t + 'Section').classList.add('hidden');
                const btn = document.getElementById('tab' + t.charAt(0).toUpperCase() + t.slice(1));
                btn.className = "tab-inactive flex-1 py-3 text-sm transition-colors text-center";
            });
            document.getElementById(tab + 'Section').classList.remove('hidden');
            const activeBtn = document.getElementById('tab' + tab.charAt(0).toUpperCase() + tab.slice(1));
            activeBtn.className = "tab-active flex-1 py-3 text-sm transition-colors text-center";
        };
    </script>
</body>
</html>
