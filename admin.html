<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RFC ê´€ë¦¬ì (Admin)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        
        /* ë¡œê·¸ì¸ ì˜¤ë²„ë ˆì´ */
        #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #111827; z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        
        /* ë“œë˜ê·¸ ì•¤ ë“œë¡­ ìŠ¤íƒ€ì¼ */
        .rank-item { cursor: grab; transition: all 0.2s; }
        .rank-item:active { cursor: grabbing; }
        .rank-item.dragging { opacity: 0.5; border: 2px dashed #3b82f6; background-color: #eff6ff; }
        
        .tab-btn { border-bottom: 2px solid transparent; }
        .tab-btn.active { border-bottom: 2px solid #2563eb; color: #2563eb; font-weight: bold; }
        
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); display: flex; justify-content: center; align-items: center; z-index: 5000; }
    </style>
</head>
<body class="p-4">

    <div id="loginOverlay">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-sm text-center">
            <h2 class="text-2xl font-black text-gray-800 mb-2">ğŸ”’ ê´€ë¦¬ì ì ‘ì†</h2>
            <input type="email" id="adminEmail" placeholder="ì´ë©”ì¼" class="w-full p-3 border rounded-lg mb-3">
            <input type="password" id="adminPw" placeholder="ë¹„ë°€ë²ˆí˜¸" class="w-full p-3 border rounded-lg mb-6">
            <button id="btnLogin" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg">ë¡œê·¸ì¸</button>
        </div>
    </div>

    <div id="mainContent" class="max-w-4xl mx-auto hidden">
        <div class="flex justify-between items-center mb-4">
            <h1 class="text-xl font-bold text-gray-800">âš™ï¸ RFC ê´€ë¦¬ì íŒ¨ë„ <span id="saveStatus" class="text-xs font-normal text-green-500 ml-2"></span></h1>
            <div class="flex gap-2">
                <button onclick="saveRankings()" class="bg-indigo-600 text-white text-xs font-bold py-2 px-3 rounded">ğŸ’¾ ê°•ì œ ì €ì¥</button>
                <button onclick="window.open('index.html')" class="bg-gray-600 text-white text-xs font-bold py-2 px-3 rounded">ì‚¬ì´íŠ¸ ë³´ê¸°</button>
            </div>
        </div>

        <div class="flex border-b border-gray-300 mb-4 bg-white rounded-t-lg">
            <button onclick="switchTab('ranking')" id="tabRanking" class="tab-btn active flex-1 py-3 text-sm">ğŸ”¥ ë­í‚¹/ì„ ìˆ˜ ê´€ë¦¬</button>
            <button onclick="switchTab('match')" id="tabMatch" class="tab-btn flex-1 py-3 text-sm">âš”ï¸ ê²½ê¸° ì…ë ¥</button>
            <button onclick="switchTab('tools')" id="tabTools" class="tab-btn flex-1 py-3 text-sm">ğŸ› ï¸ ë„êµ¬</button>
        </div>

        <div id="rankingSection">
            <div class="flex justify-end mb-2">
                <button onclick="addNewPlayer()" class="bg-green-600 text-white text-xs font-bold py-2 px-3 rounded">+ ìƒˆ ì„ ìˆ˜ ì¶”ê°€</button>
            </div>
            <div id="rankingList" class="space-y-2"></div>
        </div>

        <div id="matchSection" class="hidden p-6 bg-white rounded-lg shadow">
            <h3 class="text-lg font-bold text-gray-700 mb-6 text-center">ê²½ê¸° ê²°ê³¼ ì…ë ¥</h3>
            <div class="flex flex-col md:flex-row gap-4 items-center justify-center mb-6">
                <div class="w-full md:w-1/3 bg-blue-50 p-4 rounded border border-blue-200">
                    <label class="block text-sm font-bold text-blue-600 mb-2">ì²­ì½”ë„ˆ (Blue)</label>
                    <select id="p1Select" class="w-full border p-2 rounded mb-2"></select>
                    <label class="flex items-center justify-center p-2 bg-white rounded border cursor-pointer hover:bg-blue-100">
                        <input type="radio" name="winner" value="blue" class="w-4 h-4 text-blue-600">
                        <span class="ml-2 text-sm font-bold">ìŠ¹ë¦¬ (Win)</span>
                    </label>
                </div>
                <div class="font-bold text-gray-400">VS</div>
                <div class="w-full md:w-1/3 bg-red-50 p-4 rounded border border-red-200">
                    <label class="block text-sm font-bold text-red-600 mb-2">í™ì½”ë„ˆ (Red)</label>
                    <select id="p2Select" class="w-full border p-2 rounded mb-2"></select>
                    <label class="flex items-center justify-center p-2 bg-white rounded border cursor-pointer hover:bg-red-100">
                        <input type="radio" name="winner" value="red" class="w-4 h-4 text-red-600">
                        <span class="ml-2 text-sm font-bold">ìŠ¹ë¦¬ (Win)</span>
                    </label>
                </div>
            </div>
            <div class="flex gap-2 justify-center">
                <button onclick="applyMatch('friendly')" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded">ì¹œì„ ì „ (ê¸°ë¡ë§Œ)</button>
                <button onclick="applyMatch('ranking')" class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-6 rounded">ğŸ† ë­í‚¹ì „ ì ìš©</button>
            </div>
        </div>

        <div id="toolsSection" class="hidden p-4 bg-white rounded-lg shadow space-y-4">
            <h3 class="font-bold text-gray-700">ë°ì´í„° ì´ˆê¸°í™”</h3>
            <div class="grid grid-cols-2 gap-3">
                <button onclick="resetStats()" class="bg-red-100 text-red-700 py-3 rounded hover:bg-red-200">ğŸ“Š ì „ì (ìŠ¹íŒ¨) ì´ˆê¸°í™”</button>
                <button onclick="resetHistory()" class="bg-red-100 text-red-700 py-3 rounded hover:bg-red-200">ğŸ“œ ê²½ê¸° ê¸°ë¡ ì‚­ì œ</button>
            </div>
        </div>
    </div>

    <div id="editModal" class="modal hidden">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-11/12 max-w-md">
            <h3 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2">âœï¸ ì„ ìˆ˜ ìƒì„¸ ì •ë³´ ìˆ˜ì •</h3>
            <input type="hidden" id="editPlayerId">
            
            <div class="grid grid-cols-2 gap-3 mb-3">
                <div>
                    <label class="text-xs text-gray-500">ì´ë¦„</label>
                    <input type="text" id="editName" class="w-full border p-2 rounded text-sm font-bold">
                </div>
                <div>
                    <label class="text-xs text-gray-500">Game ID</label>
                    <input type="text" id="editGameId" class="w-full border p-2 rounded text-sm">
                </div>
            </div>
            
            <div class="grid grid-cols-3 gap-3 mb-3">
                <div>
                    <label class="text-xs text-gray-500">í‚¤ (cm)</label>
                    <input type="text" id="editHeight" class="w-full border p-2 rounded text-sm">
                </div>
                <div>
                    <label class="text-xs text-gray-500">ë¦¬ì¹˜ (cm)</label>
                    <input type="text" id="editReach" class="w-full border p-2 rounded text-sm">
                </div>
                <div>
                    <label class="text-xs text-gray-500">ë‚˜ì´</label>
                    <input type="text" id="editAge" class="w-full border p-2 rounded text-sm">
                </div>
            </div>

            <div class="mb-3">
                <label class="text-xs text-gray-500">ìŠ¤íƒ ìŠ¤ (ì˜ˆ: Orthodox, Southpaw)</label>
                <select id="editStance" class="w-full border p-2 rounded text-sm">
                    <option value="Orthodox">Orthodox (ì˜¤ë¥¸ì†)</option>
                    <option value="Southpaw">Southpaw (ì™¼ì†)</option>
                    <option value="Switch">Switch (ì–‘ì†)</option>
                </select>
            </div>

            <div class="mb-4">
                <label class="text-xs text-gray-500">ì´ë¯¸ì§€ URL</label>
                <input type="text" id="editImage" class="w-full border p-2 rounded text-sm" placeholder="https://...">
            </div>

            <div class="flex justify-end gap-2">
                <button onclick="closeEditModal()" class="bg-gray-200 text-gray-700 py-2 px-4 rounded text-sm">ì·¨ì†Œ</button>
                <button onclick="savePlayerDetails()" class="bg-blue-600 text-white py-2 px-4 rounded text-sm font-bold">ì €ì¥</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

        // ============================================================
        // [ìë™ ì…ë ¥] Firebase ì„¤ì •
        // ============================================================
        const firebaseConfig = {
            apiKey: "AIzaSyDlj68ex-fM0ExRdD-tvCy-UyIneVoPmGk",
            authDomain: "rfk-ranking.firebaseapp.com",
            projectId: "rfk-ranking",
            storageBucket: "rfk-ranking.firebasestorage.app",
            messagingSenderId: "675366165774",
            appId: "1:675366165774:web:795d34c56eab630b4dcb5f",
            measurementId: "G-CXPDZQ8GTL"
        };
        // ============================================================

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = 'ranking-manager-default';

        let rankingsData = [];
        let matchHistoryData = [];
        let seasonArchives = {};
        let activeSeason = "ì‹œì¦Œ 1";
        let dragSrcEl = null;

        // ë¡œê·¸ì¸ ë¡œì§
        document.getElementById('btnLogin').addEventListener('click', () => {
            const email = document.getElementById('adminEmail').value;
            const pw = document.getElementById('adminPw').value;
            signInWithEmailAndPassword(auth, email, pw)
                .then(() => { document.getElementById('loginOverlay').style.display = 'none'; document.getElementById('mainContent').classList.remove('hidden'); })
                .catch((e) => alert("ë¡œê·¸ì¸ ì‹¤íŒ¨: " + e.message));
        });

        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('loginOverlay').style.display = 'none';
                document.getElementById('mainContent').classList.remove('hidden');
                loadData();
            }
        });

        function loadData() {
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'rankings', 'main');
            onSnapshot(docRef, (doc) => {
                if (doc.exists()) {
                    const data = doc.data();
                    rankingsData = data.rankings || [];
                    matchHistoryData = data.matchHistory || [];
                    seasonArchives = data.seasonArchives || {};
                    activeSeason = data.activeSeason || "ì‹œì¦Œ 1";
                    renderRankings();
                    populateMatchSelectors();
                }
            });
        }

        window.saveRankings = async function() {
            const statusEl = document.getElementById('saveStatus');
            statusEl.textContent = "ì €ì¥ ì¤‘...";
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'rankings', 'main');
            
            try {
                await setDoc(docRef, {
                    rankings: rankingsData,
                    matchHistory: matchHistoryData,
                    seasonArchives: seasonArchives,
                    activeSeason: activeSeason,
                    date: new Date().toLocaleDateString('ko-KR', {timeZone: 'Asia/Seoul'})
                }, { merge: true });
                statusEl.textContent = "ì™„ë£Œ";
                setTimeout(() => statusEl.textContent = "", 1500);
            } catch (e) { alert("ì €ì¥ ì˜¤ë¥˜: " + e.message); }
        }

        function renderRankings() {
            const list = document.getElementById('rankingList');
            list.innerHTML = '';
            rankingsData.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = "rank-item flex items-center p-3 bg-white border mb-2 rounded shadow-sm hover:shadow-md";
                div.draggable = true;
                div.dataset.index = index;
                
                div.innerHTML = `
                    <div class="text-gray-400 font-bold w-8 cursor-grab">â‰¡ ${index + 1}</div>
                    <div class="flex-grow flex flex-col sm:flex-row sm:items-center gap-2">
                        <div class="font-bold text-gray-800 w-32 truncate">${item.name}</div>
                        <div class="text-xs text-gray-500 flex gap-2">
                            <span>${item.wins}ìŠ¹</span>
                            <span>${item.losses}íŒ¨</span>
                            <span class="text-gray-300">|</span>
                            <span>${item.stance || '-'}</span>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="openEditModal(${index})" class="bg-blue-100 text-blue-600 text-xs font-bold px-3 py-1 rounded hover:bg-blue-200">ìƒì„¸ í¸ì§‘</button>
                        <button onclick="deletePlayer(${index})" class="bg-gray-100 text-gray-400 text-xs font-bold px-2 py-1 rounded hover:bg-red-100 hover:text-red-500">ì‚­ì œ</button>
                    </div>
                `;
                
                div.addEventListener('dragstart', handleDragStart);
                div.addEventListener('dragover', handleDragOver);
                div.addEventListener('drop', handleDrop);
                list.appendChild(div);
            });
        }

        // --- ìƒì„¸ í¸ì§‘ ëª¨ë‹¬ ë¡œì§ ---
        window.openEditModal = (idx) => {
            const p = rankingsData[idx];
            document.getElementById('editPlayerId').value = idx;
            document.getElementById('editName').value = p.name;
            document.getElementById('editGameId').value = p.gameId || '';
            document.getElementById('editHeight').value = p.height || '';
            document.getElementById('editReach').value = p.reach || '';
            document.getElementById('editAge').value = p.age || '';
            document.getElementById('editStance').value = p.stance || 'Orthodox';
            document.getElementById('editImage').value = p.imageUrl || '';
            document.getElementById('editModal').classList.remove('hidden');
        };

        window.closeEditModal = () => document.getElementById('editModal').classList.add('hidden');

        window.savePlayerDetails = () => {
            const idx = document.getElementById('editPlayerId').value;
            const p = rankingsData[idx];
            p.name = document.getElementById('editName').value;
            p.gameId = document.getElementById('editGameId').value;
            p.height = document.getElementById('editHeight').value;
            p.reach = document.getElementById('editReach').value;
            p.age = document.getElementById('editAge').value;
            p.stance = document.getElementById('editStance').value;
            p.imageUrl = document.getElementById('editImage').value;
            
            saveRankings();
            closeEditModal();
            renderRankings();
        };

        window.addNewPlayer = () => {
            const name = prompt("ìƒˆ ì„ ìˆ˜ ì´ë¦„:");
            if(name) {
                rankingsData.push({ 
                    id: crypto.randomUUID(), name: name, wins: 0, losses: 0, 
                    isParticipating: true, entryTime: Date.now(),
                    recentMatchResults: [0,0,0,0,0,0] 
                });
                saveRankings();
            }
        };
        
        window.deletePlayer = (idx) => {
            if(confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                rankingsData.splice(idx, 1);
                saveRankings();
            }
        };

        // --- ê²½ê¸° ê²°ê³¼ ì ìš© ---
        window.applyMatch = (type) => {
            const p1Idx = document.getElementById('p1Select').value;
            const p2Idx = document.getElementById('p2Select').value;
            const winnerVal = document.querySelector('input[name="winner"]:checked')?.value;

            if(!winnerVal || p1Idx==="" || p2Idx==="") return alert("ì„ ìˆ˜ì™€ ìŠ¹ìë¥¼ ëª¨ë‘ ì„ íƒí•˜ì„¸ìš”.");
            if(p1Idx === p2Idx) return alert("ì„œë¡œ ë‹¤ë¥¸ ì„ ìˆ˜ë¥¼ ì„ íƒí•˜ì„¸ìš”.");

            const p1 = rankingsData[p1Idx];
            const p2 = rankingsData[p2Idx];
            let winner, loser;

            if (winnerVal === 'blue') { winner = p1; loser = p2; }
            else { winner = p2; loser = p1; }

            // ì „ì  ì—…ë°ì´íŠ¸
            winner.wins = (winner.wins || 0) + 1;
            loser.losses = (loser.losses || 0) + 1;

            // ìµœê·¼ 6ê²½ê¸° (Last 6) ì—…ë°ì´íŠ¸ - 1:ìŠ¹, 2:íŒ¨
            if(!winner.recentMatchResults) winner.recentMatchResults = [0,0,0,0,0,0];
            winner.recentMatchResults.push(1);
            
            if(!loser.recentMatchResults) loser.recentMatchResults = [0,0,0,0,0,0];
            loser.recentMatchResults.push(2);

            // ë§¤ì¹˜ íˆìŠ¤í† ë¦¬ ì €ì¥
            matchHistoryData.unshift({
                date: new Date().toLocaleDateString('ko-KR', {timeZone: 'Asia/Seoul'}).replace(/\. /g, '-').replace('.', ''),
                winner: winner.name,
                loser: loser.name,
                type: type,
                season: activeSeason
            });

            saveRankings();
            alert("ê²½ê¸° ê²°ê³¼ê°€ ë°˜ì˜ë˜ì—ˆìŠµë‹ˆë‹¤.");
        };

        function populateMatchSelectors() {
            const s1 = document.getElementById('p1Select');
            const s2 = document.getElementById('p2Select');
            let opts = '<option value="">ì„ ìˆ˜ ì„ íƒ</option>';
            rankingsData.forEach((p, i) => opts += `<option value="${i}">${i+1}ìœ„ ${p.name}</option>`);
            s1.innerHTML = opts; s2.innerHTML = opts;
        }

        // --- ë„êµ¬ ---
        window.resetStats = () => {
            if(confirm("ëª¨ë“  ì„ ìˆ˜ì˜ ì „ì (ìŠ¹/íŒ¨/ìµœê·¼ê¸°ë¡)ì„ 0ìœ¼ë¡œ ì´ˆê¸°í™”í•©ë‹ˆê¹Œ?")) {
                rankingsData.forEach(p => { p.wins = 0; p.losses = 0; p.recentMatchResults = [0,0,0,0,0,0]; });
                saveRankings();
            }
        }
        window.resetHistory = () => {
            if(confirm("ëª¨ë“  ê²½ê¸° ê¸°ë¡(íˆìŠ¤í† ë¦¬)ì„ ì‚­ì œí•©ë‹ˆê¹Œ?")) {
                matchHistoryData = [];
                saveRankings();
            }
        }

        // --- ë“œë˜ê·¸ ë¡œì§ ---
        function handleDragStart(e) { dragSrcEl = this; e.dataTransfer.effectAllowed = 'move'; this.classList.add('dragging'); }
        function handleDragOver(e) { e.preventDefault(); return false; }
        function handleDrop(e) {
            e.stopPropagation();
            if (dragSrcEl !== this) {
                const srcIdx = parseInt(dragSrcEl.dataset.index);
                const targetIdx = parseInt(this.dataset.index);
                const [moved] = rankingsData.splice(srcIdx, 1);
                rankingsData.splice(targetIdx, 0, moved);
                saveRankings();
            }
            this.classList.remove('dragging');
            return false;
        }

        window.switchTab = (tab) => {
            ['ranking', 'match', 'tools'].forEach(t => {
                document.getElementById(t+'Section').classList.add('hidden');
                document.getElementById('tab'+t.charAt(0).toUpperCase()+t.slice(1)).classList.remove('active');
            });
            document.getElementById(tab+'Section').classList.remove('hidden');
            document.getElementById('tab'+tab.charAt(0).toUpperCase()+tab.slice(1)).classList.add('active');
        }
    </script>
</body>
</html>
