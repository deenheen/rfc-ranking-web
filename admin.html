<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RFC ê´€ë¦¬ì (Final)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #111827; z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .rank-item { cursor: grab; transition: all 0.2s; }
        .rank-item:active { cursor: grabbing; }
        .rank-item.dragging { opacity: 0.5; border: 2px dashed #3b82f6; background-color: #eff6ff; }
        .tab-btn { border-bottom: 2px solid transparent; }
        .tab-btn.active { border-bottom: 2px solid #2563eb; color: #2563eb; font-weight: bold; }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); display: flex; justify-content: center; align-items: center; z-index: 5000; }
        .style-checkbox:checked + label { background-color: #3b82f6; color: white; border-color: #3b82f6; }
    </style>
</head>
<body class="p-4">

    <div id="loginOverlay">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-sm text-center">
            <h2 class="text-2xl font-black text-gray-800 mb-2">ğŸ”’ ê´€ë¦¬ì ì ‘ì†</h2>
            <input type="email" id="adminEmail" placeholder="ì´ë©”ì¼" class="w-full p-3 border rounded-lg mb-3">
            <input type="password" id="adminPw" placeholder="ë¹„ë°€ë²ˆí˜¸" class="w-full p-3 border rounded-lg mb-6">
            <button id="btnLogin" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg">ë¡œê·¸ì¸</button>
        </div>
    </div>

    <div id="mainContent" class="max-w-4xl mx-auto hidden">
        <div class="flex justify-between items-center mb-4">
            <h1 class="text-xl font-bold text-gray-800">âš™ï¸ RFC ê´€ë¦¬ì <span id="saveStatus" class="text-xs font-normal text-green-500 ml-2"></span></h1>
            <div class="flex gap-2">
                <button onclick="saveRankings()" class="bg-indigo-600 text-white text-xs font-bold py-2 px-3 rounded">ğŸ’¾ ê°•ì œ ì €ì¥</button>
                <button onclick="window.open('index.html')" class="bg-gray-600 text-white text-xs font-bold py-2 px-3 rounded">ì‚¬ì´íŠ¸ ë³´ê¸°</button>
            </div>
        </div>

        <div class="flex border-b border-gray-300 mb-4 bg-white rounded-t-lg">
            <button onclick="switchTab('ranking')" id="tabRanking" class="tab-btn active flex-1 py-3 text-sm">ğŸ”¥ ë­í‚¹/ì„ ìˆ˜</button>
            <button onclick="switchTab('match')" id="tabMatch" class="tab-btn flex-1 py-3 text-sm">âš”ï¸ ê²½ê¸° ì…ë ¥</button>
            <button onclick="switchTab('tools')" id="tabTools" class="tab-btn flex-1 py-3 text-sm">ğŸ› ï¸ ì‹œì¦Œ/ë„êµ¬</button>
        </div>

        <div id="rankingSection">
            <div class="flex justify-between items-center mb-2">
                <button onclick="sortRankingsByElo()" class="bg-purple-100 text-purple-700 text-xs font-bold py-2 px-3 rounded hover:bg-purple-200">ğŸ“‰ ELOìˆœ ìë™ ì •ë ¬</button>
                <button onclick="addNewPlayer()" class="bg-green-600 text-white text-xs font-bold py-2 px-3 rounded">+ ìƒˆ ì„ ìˆ˜ ì¶”ê°€</button>
            </div>
            <div id="rankingList" class="space-y-2"></div>
        </div>

        <div id="matchSection" class="hidden p-6 bg-white rounded-lg shadow">
            <h3 class="text-lg font-bold text-gray-700 mb-2 text-center">ê²½ê¸° ê²°ê³¼ ì…ë ¥</h3>
            <p class="text-center text-xs text-gray-500 mb-6">í˜„ì¬ ì‹œì¦Œ: <span id="currentSeasonDisplay" class="font-bold text-blue-600">Loading...</span></p>
            
            <div class="flex flex-col md:flex-row gap-4 items-center justify-center mb-6">
                <div class="w-full md:w-1/3 bg-blue-50 p-4 rounded border border-blue-200">
                    <label class="block text-sm font-bold text-blue-600 mb-2">ì²­ì½”ë„ˆ (Blue)</label>
                    <select id="p1Select" class="w-full border p-2 rounded mb-2"></select>
                    <label class="flex items-center justify-center p-2 bg-white rounded border cursor-pointer hover:bg-blue-100">
                        <input type="radio" name="winner" value="blue" class="w-4 h-4 text-blue-600">
                        <span class="ml-2 text-sm font-bold">ìŠ¹ë¦¬ (Win)</span>
                    </label>
                </div>
                <div class="flex flex-col items-center justify-center">
                    <div class="font-bold text-gray-400 mb-2">VS</div>
                    <label class="flex items-center justify-center p-2 bg-gray-100 rounded border cursor-pointer hover:bg-gray-200 w-24">
                        <input type="radio" name="winner" value="draw" class="w-4 h-4 text-gray-600">
                        <span class="ml-2 text-sm font-bold text-gray-700">ë¬´ìŠ¹ë¶€</span>
                    </label>
                </div>
                <div class="w-full md:w-1/3 bg-red-50 p-4 rounded border border-red-200">
                    <label class="block text-sm font-bold text-red-600 mb-2">í™ì½”ë„ˆ (Red)</label>
                    <select id="p2Select" class="w-full border p-2 rounded mb-2"></select>
                    <label class="flex items-center justify-center p-2 bg-white rounded border cursor-pointer hover:bg-red-100">
                        <input type="radio" name="winner" value="red" class="w-4 h-4 text-red-600">
                        <span class="ml-2 text-sm font-bold">ìŠ¹ë¦¬ (Win)</span>
                    </label>
                </div>
            </div>
            <div class="flex gap-2 justify-center">
                <button onclick="applyMatch()" class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-8 rounded shadow-lg transform active:scale-95 transition">
                    ğŸ† ê²½ê¸° ê²°ê³¼ ì €ì¥
                </button>
            </div>
        </div>

        <div id="toolsSection" class="hidden p-4 bg-white rounded-lg shadow space-y-6">
            <div class="border-b pb-4">
                <h3 class="font-bold text-gray-800 mb-3 text-lg">ğŸ“… ì‹œì¦Œ ê´€ë¦¬</h3>
                <div class="flex gap-4 items-end mb-4">
                    <div class="flex-grow">
                        <label class="block text-xs text-gray-500 mb-1">í˜„ì¬ ì‹œì¦Œ ì´ë¦„</label>
                        <input type="text" id="seasonNameInput" class="w-full border p-2 rounded" placeholder="ì˜ˆ: ì‹œì¦Œ 1">
                    </div>
                    <button onclick="updateSeasonName()" class="bg-blue-500 text-white font-bold py-2 px-4 rounded text-sm h-10">ë³€ê²½</button>
                </div>
                <div class="bg-purple-50 p-4 rounded border border-purple-200 mb-4">
                    <h4 class="font-bold text-sm text-purple-700 mb-2">ğŸš€ ìƒˆ ì‹œì¦Œ ì‹œì‘</h4>
                    <div class="flex items-center gap-2 mb-3">
                        <input type="checkbox" id="resetStatsCheck" class="w-4 h-4" checked>
                        <label for="resetStatsCheck" class="text-sm">ì„ ìˆ˜ ì „ì (ìŠ¹/íŒ¨/ë¬´) ì´ˆê¸°í™” (ELOëŠ” ìœ ì§€)</label>
                    </div>
                    <button onclick="startNewSeason()" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded w-full">ì‹œì¦Œ ì¢…ë£Œ ë° ìƒˆ ì‹œì¦Œ ì‹œì‘</button>
                </div>
                <div class="bg-gray-50 p-4 rounded border border-gray-200">
                    <h4 class="font-bold text-sm text-gray-700 mb-2">ğŸ“‚ ì•„ì¹´ì´ë¸Œ ê´€ë¦¬</h4>
                    <div id="archiveList" class="space-y-2 text-sm text-gray-600"><p class="text-xs italic">ê¸°ë¡ ì—†ìŒ</p></div>
                </div>
            </div>

            <div>
                <h3 class="font-bold text-gray-800 mb-3">ğŸ› ï¸ ë°ì´í„° ì´ˆê¸°í™”</h3>
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="resetStats()" class="bg-red-100 text-red-700 py-3 rounded hover:bg-red-200 font-bold text-sm">ğŸ“Š ì „ì  ì´ˆê¸°í™”</button>
                    <button onclick="resetELO()" class="bg-amber-100 text-amber-800 py-3 rounded hover:bg-amber-200 font-bold text-sm">âš¡ ELO ì´ˆê¸°í™” (1000)</button>
                    <button onclick="resetHistory()" class="bg-red-100 text-red-700 py-3 rounded hover:bg-red-200 font-bold text-sm col-span-2">ğŸ“œ ê²½ê¸° ê¸°ë¡ ì‚­ì œ</button>
                </div>
            </div>
        </div>
    </div>

    <div id="editModal" class="modal hidden">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-11/12 max-w-md max-h-[90vh] overflow-y-auto">
            <h3 class="text-lg font-bold text-gray-800 mb-4 border-b pb-2">âœï¸ ì„ ìˆ˜ ì •ë³´ ìˆ˜ì •</h3>
            <input type="hidden" id="editPlayerId">
            <input type="hidden" id="editOriginalName"> <div class="grid grid-cols-2 gap-3 mb-3">
                <div><label class="text-xs text-gray-500">ì´ë¦„</label><input type="text" id="editName" class="w-full border p-2 rounded text-sm font-bold"></div>
                <div><label class="text-xs text-gray-500">ELO ì ìˆ˜</label><input type="number" id="editElo" class="w-full border p-2 rounded text-sm bg-yellow-50 font-bold text-yellow-700"></div>
            </div>
            
            <div class="grid grid-cols-2 gap-3 mb-3">
                <div><label class="text-xs text-gray-500">í‚¤ (cm)</label><input type="text" id="editHeight" class="w-full border p-2 rounded text-sm"></div>
                <div><label class="text-xs text-gray-500">ë¦¬ì¹˜ (cm)</label><input type="text" id="editReach" class="w-full border p-2 rounded text-sm"></div>
            </div>

            <div class="grid grid-cols-2 gap-3 mb-3">
                <div>
                    <label class="text-xs text-gray-500">ìŠ¤íƒ ìŠ¤</label>
                    <select id="editStance" class="w-full border p-2 rounded text-sm">
                        <option value="Orthodox">Orthodox</option>
                        <option value="Southpaw">Southpaw</option>
                        <option value="Switch">Switch</option>
                    </select>
                </div>
                <div><label class="text-xs text-gray-500">Game ID</label><input type="text" id="editGameId" class="w-full border p-2 rounded text-sm"></div>
            </div>

            <div class="mb-4">
                <label class="text-xs text-gray-500">ì´ë¯¸ì§€ URL</label>
                <input type="text" id="editImage" class="w-full border p-2 rounded text-sm" placeholder="https://...">
            </div>

            <div class="mb-6 p-3 bg-gray-50 rounded border border-gray-200">
                <label class="block text-xs font-bold text-gray-600 mb-2">ğŸ¥Š íŒŒì´íŒ… ìŠ¤íƒ€ì¼ (ì¤‘ë³µ ê°€ëŠ¥)</label>
                <div id="styleTagsContainer" class="flex flex-wrap gap-2"></div>
            </div>

            <div class="flex justify-end gap-2">
                <button onclick="closeEditModal()" class="bg-gray-200 text-gray-700 py-2 px-4 rounded text-sm">ì·¨ì†Œ</button>
                <button onclick="savePlayerDetails()" class="bg-blue-600 text-white py-2 px-4 rounded text-sm font-bold">ì €ì¥</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

        // ============================================================
        // [ì¤‘ìš”] ì—¬ê¸°ì— ë³¸ì¸ì˜ firebaseConfigë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”!
        // ============================================================
        const firebaseConfig = {
            apiKey: "AIzaSyDlj68ex-fM0ExRdD-tvCy-UyIneVoPmGk",
  authDomain: "rfk-ranking.firebaseapp.com",
  projectId: "rfk-ranking",
  storageBucket: "rfk-ranking.firebasestorage.app",
  messagingSenderId: "675366165774",
  appId: "1:675366165774:web:795d34c56eab630b4dcb5f",
  measurementId: "G-CXPDZQ8GTL"

        };
        // ============================================================

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = 'ranking-manager-default';

        let rankingsData = [];
        let matchHistoryData = [];
        let seasonArchives = {};
        let activeSeason = "ì‹œì¦Œ 1";
        let dragSrcEl = null;

        const STYLE_OPTIONS = ["ì¸íŒŒì´í„°", "ì•„ì›ƒë³µì„œ", "ìŠ¬ëŸ¬ê±°", "ì¹´ìš´í„°", "ìŠ¤ì›Œë¨¸", "í•˜ë“œí€ì²˜", "í…Œí¬ë‹ˆì…˜", "ë§·ì§‘ì™•", "ë³€ì¹™"];

        document.getElementById('btnLogin').addEventListener('click', () => {
            const email = document.getElementById('adminEmail').value;
            const pw = document.getElementById('adminPw').value;
            signInWithEmailAndPassword(auth, email, pw)
                .then(() => { document.getElementById('loginOverlay').style.display = 'none'; document.getElementById('mainContent').classList.remove('hidden'); })
                .catch((e) => alert("ë¡œê·¸ì¸ ì‹¤íŒ¨: " + e.message));
        });

        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('loginOverlay').style.display = 'none';
                document.getElementById('mainContent').classList.remove('hidden');
                loadData();
            }
        });

        function loadData() {
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'rankings', 'main');
            onSnapshot(docRef, (doc) => {
                if (doc.exists()) {
                    const data = doc.data();
                    rankingsData = data.rankings || [];
                    matchHistoryData = data.matchHistory || [];
                    seasonArchives = data.seasonArchives || {};
                    activeSeason = data.activeSeason || "ì‹œì¦Œ 1";
                    
                    document.getElementById('currentSeasonDisplay').textContent = activeSeason;
                    document.getElementById('seasonNameInput').value = activeSeason;

                    rankingsData.forEach(p => { if(p.elo === undefined) p.elo = 1000; });

                    renderRankings();
                    populateMatchSelectors();
                    renderArchiveList();
                }
            });
        }

        window.saveRankings = async function() {
            const statusEl = document.getElementById('saveStatus');
            statusEl.textContent = "ì €ì¥ ì¤‘...";
            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'rankings', 'main');
            try {
                // ì €ì¥ ì‹œ í˜„ì¬ ìˆœìœ„ë¥¼ previousRankì— ë°±ì—… (ìˆœìœ„ ë³€ë™ ê³„ì‚°ìš©)
                // ë‹¨, ë‹¨ìˆœ ì €ì¥ì´ ì•„ë‹ˆë¼ 'í•˜ë£¨ê°€ ì§€ë‚¬ì„ ë•Œ' ê°±ì‹ í•˜ëŠ” ê²ƒì´ ì •ì„ì´ì§€ë§Œ
                // ì—¬ê¸°ì„œëŠ” ì¼ë‹¨ ì‹¤ì‹œê°„ ë³€ë™ì„ ìœ„í•´ í˜„ì¬ indexë¥¼ ì €ì¥.
                // *ì£¼ì˜: ë“œë˜ê·¸í•  ë•Œë§ˆë‹¤ ì €ì¥ë˜ë©´ ë³€ë™í­ì´ 0ì´ ë  ìˆ˜ ìˆìŒ.
                // ë³€ë™í­ì„ 'ì–´ì œ ëŒ€ë¹„'ë¡œ ë³´ë ¤ë©´ ë³„ë„ ìŠ¤ëƒ…ìƒ· ë¡œì§ì´ í•„ìš”í•˜ì§€ë§Œ
                // ì‚¬ìš©ìê°€ ìš”ì²­í•œ 'ìˆœìœ„ ë³€ë™ í‘œì‹œ'ë¥¼ ìœ„í•´ ì¼ë‹¨ current index ì €ì¥.
                rankingsData.forEach((p, i) => {
                    // p.previousRankê°€ ì—†ìœ¼ë©´ ì´ˆê¸°í™”
                    if (p.previousRank === undefined) p.previousRank = i + 1;
                });

                const now = new Date();
                const kstDate = new Date(now.getTime() + (9 * 60 * 60 * 1000)).toISOString().split('T')[0];
                await setDoc(docRef, {
                    rankings: rankingsData,
                    matchHistory: matchHistoryData,
                    seasonArchives: seasonArchives,
                    activeSeason: activeSeason,
                    date: kstDate
                }, { merge: true });
                statusEl.textContent = "ì™„ë£Œ";
                setTimeout(() => statusEl.textContent = "", 1500);
            } catch (e) { alert("ì €ì¥ ì˜¤ë¥˜: " + e.message); }
        }

        function calculateNewElo(ratingA, ratingB, actualScoreA) {
            const K = 32;
            const expectedScoreA = 1 / (1 + Math.pow(10, (ratingB - ratingA) / 400));
            return Math.round(ratingA + K * (actualScoreA - expectedScoreA));
        }

        window.applyMatch = () => {
            const p1Idx = document.getElementById('p1Select').value;
            const p2Idx = document.getElementById('p2Select').value;
            const winnerVal = document.querySelector('input[name="winner"]:checked')?.value;

            if(!winnerVal || p1Idx==="" || p2Idx==="") return alert("ì„ ìˆ˜ì™€ ê²°ê³¼ë¥¼ ëª¨ë‘ ì„ íƒí•˜ì„¸ìš”.");
            if(p1Idx === p2Idx) return alert("ì„œë¡œ ë‹¤ë¥¸ ì„ ìˆ˜ë¥¼ ì„ íƒí•˜ì„¸ìš”.");

            const p1 = rankingsData[p1Idx];
            const p2 = rankingsData[p2Idx];
            
            let p1Score, p2Score;
            
            if (winnerVal === 'draw') {
                p1.draws = (p1.draws || 0) + 1;
                p2.draws = (p2.draws || 0) + 1;
                p1.recentMatchResults = [...(p1.recentMatchResults||[]), 3];
                p2.recentMatchResults = [...(p2.recentMatchResults||[]), 3];
                p1Score = 0.5; p2Score = 0.5;
            } else {
                let winner, loser;
                if (winnerVal === 'blue') { winner = p1; loser = p2; p1Score = 1; p2Score = 0; } 
                else { winner = p2; loser = p1; p1Score = 0; p2Score = 1; }
                winner.wins = (winner.wins || 0) + 1;
                loser.losses = (loser.losses || 0) + 1;
                winner.recentMatchResults = [...(winner.recentMatchResults||[]), 1];
                loser.recentMatchResults = [...(loser.recentMatchResults||[]), 2];
            }

            const oldElo1 = p1.elo || 1000;
            const oldElo2 = p2.elo || 1000;
            p1.elo = calculateNewElo(oldElo1, oldElo2, p1Score);
            p2.elo = calculateNewElo(oldElo2, oldElo1, p2Score);

            const now = new Date();
            const kstDate = new Date(now.getTime() + (9 * 60 * 60 * 1000)).toISOString().split('T')[0];
            
            matchHistoryData.unshift({
                date: kstDate,
                winner: p1.name,
                loser: p2.name,
                type: winnerVal === 'draw' ? 'draw' : 'ranking',
                season: activeSeason
            });

            saveRankings();
            alert(`ê²°ê³¼ ë°˜ì˜ ì™„ë£Œ!\n${p1.name}: ${oldElo1}->${p1.elo}\n${p2.name}: ${oldElo2}->${p2.elo}`);
        };

        function renderRankings() {
            const list = document.getElementById('rankingList');
            list.innerHTML = '';
            rankingsData.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = "rank-item flex items-center p-3 bg-white border mb-2 rounded shadow-sm hover:shadow-md";
                div.draggable = true;
                div.dataset.index = index;
                
                const tagsText = (item.tags && item.tags.length > 0) ? `[${item.tags.join(', ')}]` : '';

                div.innerHTML = `
                    <div class="text-gray-400 font-bold w-8 cursor-grab">â‰¡ ${index + 1}</div>
                    <div class="flex-grow flex flex-col sm:flex-row sm:items-center gap-2">
                        <div class="font-bold text-gray-800 w-32 truncate">${item.name}</div>
                        <div class="text-xs text-gray-500 flex gap-2 items-center">
                            <span class="bg-yellow-100 text-yellow-800 px-1.5 py-0.5 rounded font-bold">âš¡${item.elo || 1000}</span>
                            <span class="text-green-600">${item.wins}ìŠ¹</span>
                            <span class="text-red-600">${item.losses}íŒ¨</span>
                            <span class="text-blue-600">${item.draws || 0}ë¬´</span>
                            <span class="text-gray-400 text-[10px]">${tagsText}</span>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="openEditModal(${index})" class="bg-blue-100 text-blue-600 text-xs font-bold px-3 py-1 rounded">í¸ì§‘</button>
                        <button onclick="deletePlayer(${index})" class="bg-gray-100 text-gray-400 text-xs font-bold px-2 py-1 rounded hover:bg-red-100">ì‚­ì œ</button>
                    </div>
                `;
                div.addEventListener('dragstart', handleDragStart);
                div.addEventListener('dragover', handleDragOver);
                div.addEventListener('drop', handleDrop);
                list.appendChild(div);
            });
        }

        // --- ìƒì„¸ í¸ì§‘ ëª¨ë‹¬ (ì´ë¦„ ë³€ê²½ ì‹œ ê¸°ë¡ ìˆ˜ì • ê¸°ëŠ¥ ì¶”ê°€) ---
        window.openEditModal = (idx) => {
            const p = rankingsData[idx];
            document.getElementById('editPlayerId').value = idx;
            document.getElementById('editOriginalName').value = p.name; // ê¸°ì¡´ ì´ë¦„ ë°±ì—…
            document.getElementById('editName').value = p.name;
            document.getElementById('editGameId').value = p.gameId || '';
            document.getElementById('editHeight').value = p.height || '';
            document.getElementById('editReach').value = p.reach || '';
            document.getElementById('editStance').value = p.stance || 'Orthodox';
            document.getElementById('editImage').value = p.imageUrl || '';
            document.getElementById('editElo').value = p.elo || 1000;
            renderStyleTags(p.tags || []);
            document.getElementById('editModal').classList.remove('hidden');
        };

        function renderStyleTags(currentTags) {
            const container = document.getElementById('styleTagsContainer');
            container.innerHTML = '';
            STYLE_OPTIONS.forEach(style => {
                const isChecked = currentTags.includes(style);
                const id = `style-${style}`;
                const html = `<div><input type="checkbox" id="${id}" value="${style}" class="style-checkbox hidden" ${isChecked ? 'checked' : ''}><label for="${id}" class="inline-block px-3 py-1 text-xs font-bold border border-gray-300 rounded-full cursor-pointer text-gray-500 hover:bg-gray-100 transition select-none ${isChecked ? 'bg-blue-500 text-white border-blue-500' : ''}">${style}</label></div>`;
                container.innerHTML += html;
            });
            container.querySelectorAll('input').forEach(input => {
                input.addEventListener('change', (e) => {
                    const label = e.target.nextElementSibling;
                    if(e.target.checked) { label.classList.add('bg-blue-500', 'text-white', 'border-blue-500'); label.classList.remove('text-gray-500'); }
                    else { label.classList.remove('bg-blue-500', 'text-white', 'border-blue-500'); label.classList.add('text-gray-500'); }
                });
            });
        }

        window.closeEditModal = () => document.getElementById('editModal').classList.add('hidden');
        
        // [ì¤‘ìš”] ì´ë¦„ ë³€ê²½ ì‹œ ê³¼ê±° ê¸°ë¡ ìˆ˜ì • ë¡œì§ (ìë™ ìˆ˜í–‰)
        window.savePlayerDetails = () => {
            const idx = document.getElementById('editPlayerId').value;
            const originalName = document.getElementById('editOriginalName').value; // ì›ë˜ ì´ë¦„
            const newName = document.getElementById('editName').value; // ìƒˆ ì´ë¦„
            
            const p = rankingsData[idx];
            p.name = newName;
            p.gameId = document.getElementById('editGameId').value;
            p.height = document.getElementById('editHeight').value;
            p.reach = document.getElementById('editReach').value;
            p.stance = document.getElementById('editStance').value;
            p.imageUrl = document.getElementById('editImage').value;
            p.elo = parseInt(document.getElementById('editElo').value) || 1000;
            
            const checkedTags = document.querySelectorAll('.style-checkbox:checked');
            p.tags = Array.from(checkedTags).map(cb => cb.value);

            // ì´ë¦„ì´ ë°”ë€Œì—ˆë‹¤ë©´ ê¸°ë¡ë„ ìˆ˜ì • (ë¬»ì§€ ì•Šê³  ìë™ ì‹¤í–‰)
            if (originalName && originalName !== newName) {
                let updateCount = 0;
                matchHistoryData.forEach(match => {
                    if(match.winner === originalName) { match.winner = newName; updateCount++; }
                    if(match.loser === originalName) { match.loser = newName; updateCount++; }
                });
                console.log(`Updated ${updateCount} history records for name change.`);
            }

            saveRankings();
            closeEditModal();
            renderRankings();
        };

        // --- ìˆœìœ„ ìë™ ì •ë ¬ ---
        window.sortRankingsByElo = () => {
            if(!confirm("ELO ì ìˆ˜ ìˆœìœ¼ë¡œ ìˆœìœ„ë¥¼ ì¬ì •ë ¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ì£¼ì˜: ê¸°ì¡´ ìˆ˜ë™ ìˆœì„œê°€ ë°”ë€ë‹ˆë‹¤.)")) return;
            rankingsData.sort((a, b) => (b.elo || 1000) - (a.elo || 1000));
            saveRankings();
            renderRankings();
        };

        function populateMatchSelectors() {
            const s1 = document.getElementById('p1Select');
            const s2 = document.getElementById('p2Select');
            let opts = '<option value="">ì„ ìˆ˜ ì„ íƒ</option>';
            rankingsData.forEach((p, i) => opts += `<option value="${i}">${i+1}ìœ„ ${p.name} (${p.elo||1000})</option>`);
            s1.innerHTML = opts; s2.innerHTML = opts;
        }

        window.resetELO = () => { if(confirm("ëª¨ë“  ELO 1000ìœ¼ë¡œ ì´ˆê¸°í™”?")) { rankingsData.forEach(p => p.elo = 1000); saveRankings(); } };
        window.addNewPlayer = () => { const name = prompt("ìƒˆ ì„ ìˆ˜ ì´ë¦„:"); if(name) { rankingsData.push({ id: crypto.randomUUID(), name: name, wins: 0, losses: 0, draws: 0, elo: 1000, isParticipating: true, recentMatchResults: [], tags: [], previousRank: rankingsData.length + 1 }); saveRankings(); } };
        window.deletePlayer = (idx) => { if(confirm("ì‚­ì œ?")) { rankingsData.splice(idx, 1); saveRankings(); } };
        window.resetStats = () => { if(confirm("ì „ì  0ìœ¼ë¡œ?")) { rankingsData.forEach(p => { p.wins=0; p.losses=0; p.draws=0; p.recentMatchResults=[]; }); saveRankings(); } };
        window.resetHistory = () => { if(confirm("ê¸°ë¡ ì‚­ì œ?")) { matchHistoryData=[]; saveRankings(); } };
        window.updateSeasonName = () => { activeSeason = document.getElementById('seasonNameInput').value; saveRankings(); };
        window.startNewSeason = () => { 
            if(!confirm(`[${activeSeason}] ì¢…ë£Œ & ìƒˆ ì‹œì¦Œ?`)) return; 
            const nextNum = parseInt(activeSeason.replace(/[^0-9]/g, '')) + 1 || 2; 
            seasonArchives[activeSeason] = { champion: rankingsData[0]?.name||"-", bestMatch: "-" }; 
            activeSeason = `ì‹œì¦Œ ${nextNum}`; 
            // ìƒˆ ì‹œì¦Œ ì‹œì‘ ì‹œ previousRank ì´ˆê¸°í™”
            rankingsData.forEach((p, i) => {
                p.previousRank = i + 1; // í˜„ì¬ ìˆœìœ„ë¡œ ë¦¬ì…‹
                if(document.getElementById('resetStatsCheck').checked) { 
                    p.wins=0; p.losses=0; p.draws=0; p.recentMatchResults=[]; 
                }
            });
            saveRankings(); 
            alert(`[${activeSeason}] ì‹œì‘!`); 
        };
        
        function renderArchiveList() { const c = document.getElementById('archiveList'); c.innerHTML=''; Object.keys(seasonArchives).sort().forEach(s => { c.innerHTML += `<div class="flex justify-between items-center bg-white p-2 border rounded shadow-sm"><span>${s}</span> <div class="flex gap-2"><button onclick="restoreSeason('${s}')" class="text-xs bg-blue-100 text-blue-600 px-2 py-1 rounded">ë³µêµ¬</button><button onclick="deleteArchive('${s}')" class="text-xs bg-red-100 text-red-600 px-2 py-1 rounded">ì‚­ì œ</button></div></div>`; }); }
        window.restoreSeason = (s) => { if(confirm("ë³µêµ¬?")) { delete seasonArchives[s]; activeSeason = s; saveRankings(); } };
        window.deleteArchive = (s) => { if(confirm("ì‚­ì œ?")) { delete seasonArchives[s]; saveRankings(); } };

        function handleDragStart(e) { dragSrcEl = this; e.dataTransfer.effectAllowed = 'move'; this.classList.add('dragging'); }
        function handleDragOver(e) { e.preventDefault(); return false; }
        function handleDrop(e) { e.stopPropagation(); if (dragSrcEl !== this) { const srcIdx = parseInt(dragSrcEl.dataset.index); const targetIdx = parseInt(this.dataset.index); const [moved] = rankingsData.splice(srcIdx, 1); rankingsData.splice(targetIdx, 0, moved); saveRankings(); } this.classList.remove('dragging'); return false; }
        
        window.switchTab = (tab) => {
            ['ranking', 'match', 'tools'].forEach(t => { document.getElementById(t+'Section').classList.add('hidden'); document.getElementById('tab'+t.charAt(0).toUpperCase()+t.slice(1)).classList.remove('active'); });
            document.getElementById(tab+'Section').classList.remove('hidden');
            document.getElementById('tab'+tab.charAt(0).toUpperCase()+tab.slice(1)).classList.add('active');
        }
    </script>
</body>
</html>
